<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Grattan Institute • grattan</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.1/css/all.min.css" integrity="sha256-PbSmjxuVAzJ6FPvNYsrXygfGhNJYyZ2GktDbkMBqQZg=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.1/css/v4-shims.min.css" integrity="sha256-A6jcAdwFD48VMjlI3GDxUd+eCQa7/KWy6G9oe/ovaPA=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Grattan Institute">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">grattan</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.7.1.4</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/grattan.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/datatable-implementation.html">Calculations of income tax are rolling joins</a>
    </li>
    <li>
      <a href="../articles/long-vignettes/budget-2018.html">Budget 2018 modelling</a>
    </li>
    <li>
      <a href="../articles/long-vignettes/issues/166.html">2015-16 size of dividends credit</a>
    </li>
    <li>
      <a href="../articles/long-vignettes/population/forecasting-population.html">Forecasting population</a>
    </li>
    <li>
      <a href="../articles/model-income-tax.html">Model income tax and project</a>
    </li>
    <li>
      <a href="../articles/v201515-taxstats.html">2015-16 taxstats miscellany</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/HughParsonage/grattan">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Grattan Institute</h1>
                        <h4 class="author">Hugh Parsonage</h4>
            
            <h4 class="date">2019-10-29</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/HughParsonage/grattan/blob/master/vignettes/grattan.Rmd"><code>vignettes/grattan.Rmd</code></a></small>
      <div class="hidden name"><code>grattan.Rmd</code></div>

    </div>

    
    
<div id="budget-2018" class="section level2">
<h2 class="hasAnchor">
<a href="#budget-2018" class="anchor"></a>Budget 2018</h2>
<p>For a vignette from the Budget 2018 analysis, see: <a href="https://hughparsonage.github.io/grattan/articles/long-vignettes/budget-2018.html" class="uri">https://hughparsonage.github.io/grattan/articles/long-vignettes/budget-2018.html</a></p>
<p>This vignette collates the vignettes that were present before version 1.5.3.</p>
<p>To run the vignette, provided you have access to the Internet, set the environment variable <code>R_GRATTAN_BUILD_MAIN_VIGNETTE</code> to <code>"true"</code>. (It is set off to satisfy CRAN requirements.)</p>
</div>
<div id="bracket-creep" class="section level1">
<h1 class="hasAnchor">
<a href="#bracket-creep" class="anchor"></a>Bracket creep</h1>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(mgcv)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(lattice)</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(dtplyr)</span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(dplyr)</span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(ggplot2)</span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(scales)</span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(magrittr)</span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(ggrepel)</span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(viridis)</span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(knitr)</span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(hutils)</span>
<span id="cb1-12"><a href="#cb1-12"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(magrittr)</span>
<span id="cb1-13"><a href="#cb1-13"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(data.table)</span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(grattan)</span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="kw"><a href="../reference/require_taxstats.html">require_taxstats</a></span>()</span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="kw"><a href="../reference/require_taxstats.html">require_taxstats1516</a></span>()</span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>sample_files_all &lt;-<span class="st"> </span><span class="kw">get_sample_files_all</span>()</span>
<span id="cb4-2"><a href="#cb4-2"></a>sample_files_all[, WEIGHT <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span>(fy.year <span class="op">&gt;</span><span class="st"> '2010-11'</span>, 50L, 100L)]</span>
<span id="cb4-3"><a href="#cb4-3"></a>age_range_decoder &lt;-<span class="st"> </span><span class="kw"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span>(age_range_decoder)</span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="co"># Just an easy way to grab a bit of extra memory</span></span>
<span id="cb5-2"><a href="#cb5-2"></a>weighted.mean &lt;-<span class="st"> </span><span class="cf">function</span>(x, w) {</span>
<span id="cb5-3"><a href="#cb5-3"></a>  <span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/double.html">as.double</a></span>(x) <span class="op">*</span><span class="st"> </span>w) <span class="op">/</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(x)</span>
<span id="cb5-4"><a href="#cb5-4"></a>}</span></code></pre></div>
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>This vignette uses a <a href="https://grattan.edu.au/news/young-australians-will-wear-the-costs-of-turnbulls-middle-income-tax-cut/">recent op-ed</a> to demonstrate several tools within the <code>grattan</code> package:</p>
<ol style="list-style-type: decimal">
<li>projection of sample files for analysis over the budget forward estimates, including a flexible assumption about future wage growth</li>
<li>calculating income tax, both under present settings and changes to thresholds or rates.</li>
</ol>
<div id="average-change-of-tax-rates-by-decile" class="section level3">
<h3 class="hasAnchor">
<a href="#average-change-of-tax-rates-by-decile" class="anchor"></a>Average change of tax rates by decile</h3>
<p>Say we want to compare the expected income tax paid by individuals in 2016-17 vs 2020-21. We have 2% sample files from 2012-13 and 2013-14. To do distributional analysis for years beyond 2013-14, we <code>project</code> a sample file as many years ahead as required. So for 2016-17, we use <code>project</code> with <code>h = 4L</code>. (The <code>h</code> stands for ‘’horizon’‘. The <code>L</code> means ’integer’ in R: <code>project</code> insists that the <code>h</code> value is strictly an integer as that is the only type of value that makes sense here.)</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>sample_file_<span class="dv">1617</span> &lt;-</span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="st">  </span><span class="kw"><a href="../reference/project.html">project</a></span>(sample_file_<span class="dv">1213</span>,</span>
<span id="cb6-3"><a href="#cb6-3"></a>          <span class="dt">h =</span> 4L,</span>
<span id="cb6-4"><a href="#cb6-4"></a>          <span class="dt">fy.year.of.sample.file =</span> <span class="st">"2012-13"</span>)</span></code></pre></div>
<p>and similarly for 2020-21 we use <code>h = 8L</code>:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>sample_file_<span class="dv">2021</span> &lt;-</span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="st">  </span><span class="kw"><a href="../reference/project.html">project</a></span>(sample_file_<span class="dv">1213</span>,</span>
<span id="cb7-3"><a href="#cb7-3"></a>          <span class="dt">h =</span> 8L,</span>
<span id="cb7-4"><a href="#cb7-4"></a>          <span class="dt">fy.year.of.sample.file =</span> <span class="st">"2012-13"</span>)</span></code></pre></div>
<p>I use <code>fy.year.of.sample.file = "2012-13"</code> rather than <code>= "2013-14"</code> as the former seems to give more accurate forecasts when compared with final budget outcomes in the years that follow.</p>
<p>The next step is to calculate the tax paid for each entry in the sample file for those years. The <code>grattan</code> package provides <code>income_tax</code> for this purpose, with the optional argument <code>.dots.ATO</code> accepting a sample file to take care of the variables that are needed for the complex calculations of offsets and the Medicare levy. The argument <code>fy.year</code> specifies what tax scales to use; for future years, we assume the current settings, unless the Government has announced changes in a future year, such as the expected increase to the Medicare levy. Since the <code>income_tax</code> function only currently works for years as far ahead as 2019-20, we use that year for the 2020-21 projection of the sample file.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>sample_file_<span class="dv">1617</span>[, tax_paid <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="../reference/income_tax.html">income_tax</a></span>(Taxable_Income,</span>
<span id="cb8-2"><a href="#cb8-2"></a>                                          <span class="dt">.dots.ATO =</span> <span class="kw"><a href="https://Rdatatable.gitlab.io/data.table/reference/copy.html">copy</a></span>(sample_file_<span class="dv">1617</span>),</span>
<span id="cb8-3"><a href="#cb8-3"></a>                                          <span class="dt">fy.year =</span> <span class="st">"2016-17"</span>)]</span>
<span id="cb8-4"><a href="#cb8-4"></a>sample_file_<span class="dv">1617</span>[, avg_tax <span class="op">:</span><span class="er">=</span><span class="st"> </span>tax_paid <span class="op">/</span><span class="st"> </span>Taxable_Income]</span>
<span id="cb8-5"><a href="#cb8-5"></a>sample_file_<span class="dv">2021</span>[, tax_paid <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="../reference/income_tax.html">income_tax</a></span>(Taxable_Income,</span>
<span id="cb8-6"><a href="#cb8-6"></a>                                          <span class="dt">.dots.ATO =</span> <span class="kw"><a href="https://Rdatatable.gitlab.io/data.table/reference/copy.html">copy</a></span>(sample_file_<span class="dv">2021</span>),</span>
<span id="cb8-7"><a href="#cb8-7"></a>                                          <span class="dt">fy.year =</span> <span class="st">"2019-20"</span>)]</span>
<span id="cb8-8"><a href="#cb8-8"></a>sample_file_<span class="dv">2021</span>[, avg_tax <span class="op">:</span><span class="er">=</span><span class="st"> </span>tax_paid <span class="op">/</span><span class="st"> </span>Taxable_Income]</span></code></pre></div>
<p>To calculate the average (average) tax by decile, we use <code>weighted_ntile</code> with the optional arguments <code>weights</code> left to the default (as the sample file is equiweighted).</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>avg_tax_by_decile_<span class="dv">1617</span> &lt;-<span class="st"> </span></span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="st">  </span>sample_file_<span class="dv">1617</span> <span class="op">%&gt;%</span></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="st">  </span>.[, .(<span class="dt">avg_tax =</span> <span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(avg_tax)),</span>
<span id="cb9-4"><a href="#cb9-4"></a>    keyby =<span class="st"> </span>.(<span class="dt">decile =</span> <span class="kw"><a href="https://rdrr.io/pkg/hutils/man/weighted_ntile.html">weighted_ntile</a></span>(Taxable_Income, <span class="dt">n =</span> <span class="dv">10</span>))]</span>
<span id="cb9-5"><a href="#cb9-5"></a></span>
<span id="cb9-6"><a href="#cb9-6"></a>avg_tax_by_decile_<span class="dv">2021</span> &lt;-<span class="st"> </span></span>
<span id="cb9-7"><a href="#cb9-7"></a><span class="st">  </span>sample_file_<span class="dv">2021</span> <span class="op">%&gt;%</span></span>
<span id="cb9-8"><a href="#cb9-8"></a><span class="st">  </span>.[, .(<span class="dt">avg_tax =</span> <span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(avg_tax)),</span>
<span id="cb9-9"><a href="#cb9-9"></a>    keyby =<span class="st"> </span>.(<span class="dt">decile =</span> <span class="kw"><a href="https://rdrr.io/pkg/hutils/man/weighted_ntile.html">weighted_ntile</a></span>(Taxable_Income, <span class="dt">n =</span> <span class="dv">10</span>))]</span></code></pre></div>
<p>We can then plot a comparison of these table by joining them and using <code>ggplot2</code>. Since the tables are already keyed by <code>decile</code>, we can use the <code>X[Y]</code> method from <code>data.table</code> to join by <code>decile</code>. This creates a three-column table: the first is <code>decile</code>, the second is <code>avg_tax</code> which is the <code>avg_tax</code> from the 2016-17 table and <code>i.avg_tax</code> which is the <code>avg_tax</code> from the 2020-21 table. (In the result of <code>X[Y]</code>, any column in <code>Y</code> which has the same name as a column in <code>X</code> (but isn’t a key) is prefixed with <code>i.</code> to distinguish it.) We discard the lowest decile as the average tax is <code>NaN</code> for those with zero taxable income. Lastly, for cosmetic reasons, we convert <code>decile</code> to a factor so that the labels on the chart are <code>1, 2, 3, ...</code> rather than <code>0, 2.5, 5, ...</code>.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>avg_tax_by_decile_<span class="dv">1617</span>[avg_tax_by_decile_<span class="dv">2021</span>] <span class="op">%&gt;%</span></span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="st">  </span>.[decile <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>] <span class="op">%&gt;%</span></span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="st">  </span>.[, ppt_increase <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">100</span><span class="op">*</span>(i.avg_tax <span class="op">-</span><span class="st"> </span>avg_tax)] <span class="op">%&gt;%</span></span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="st">  </span>.[, decile <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(decile)] <span class="op">%&gt;%</span></span>
<span id="cb10-5"><a href="#cb10-5"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> decile, <span class="dt">y =</span> ppt_increase)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb10-6"><a href="#cb10-6"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span>()</span></code></pre></div>
<p>This chart and the underlying data are a reflection of the assumptions in the <code>project</code> function. In particular, the <code>project</code> function uses a particular forecast of the wage price index to uprate the salary column in the sample file. This differs from the assumptions in the 2017 Budget.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a>Budget_wage_series &lt;-</span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="st">  </span><span class="kw"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span>(<span class="dt">fy_year =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"2017-18"</span>, <span class="st">"2018-19"</span>, <span class="st">"2019-20"</span>, <span class="st">"2020-21"</span>),</span>
<span id="cb11-3"><a href="#cb11-3"></a>             <span class="dt">r =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.025</span>, <span class="fl">0.03</span>, <span class="fl">0.035</span>, <span class="fl">0.0375</span>))</span>
<span id="cb11-4"><a href="#cb11-4"></a></span>
<span id="cb11-5"><a href="#cb11-5"></a><span class="kw"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>(Budget_wage_series)</span></code></pre></div>
<p>The <code>project</code> function expects wages to grow by res over the period 2016-17 to 2020-21, whereas by the forecast in the Budget this number would be res. Whatever the merits of each forecast, the <code>project</code> function allows you to specify a particular wage series in the future through the argument <code>wage.series =</code>. We can then repeat the analysis above using those estimates:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>sample_file_<span class="dv">1617</span> &lt;-<span class="st"> </span><span class="kw"><a href="../reference/project.html">project</a></span>(sample_file_<span class="dv">1213</span>,</span>
<span id="cb12-2"><a href="#cb12-2"></a>                            <span class="dt">h =</span> 4L,</span>
<span id="cb12-3"><a href="#cb12-3"></a>                            <span class="dt">fy.year.of.sample.file =</span> <span class="st">"2012-13"</span>)</span>
<span id="cb12-4"><a href="#cb12-4"></a></span>
<span id="cb12-5"><a href="#cb12-5"></a>sample_file_<span class="dv">2021</span> &lt;-<span class="st"> </span><span class="kw"><a href="../reference/project.html">project</a></span>(sample_file_<span class="dv">1213</span>,</span>
<span id="cb12-6"><a href="#cb12-6"></a>                            <span class="dt">fy.year.of.sample.file =</span> <span class="st">"2012-13"</span>,</span>
<span id="cb12-7"><a href="#cb12-7"></a>                            <span class="dt">h =</span> 8L,</span>
<span id="cb12-8"><a href="#cb12-8"></a>                            <span class="dt">wage.series =</span> Budget_wage_series)</span>
<span id="cb12-9"><a href="#cb12-9"></a></span>
<span id="cb12-10"><a href="#cb12-10"></a>sample_file_<span class="dv">1617</span>[, tax_paid <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="../reference/income_tax.html">income_tax</a></span>(Taxable_Income,</span>
<span id="cb12-11"><a href="#cb12-11"></a>                                          <span class="dt">.dots.ATO =</span> <span class="kw"><a href="https://Rdatatable.gitlab.io/data.table/reference/copy.html">copy</a></span>(sample_file_<span class="dv">1617</span>),</span>
<span id="cb12-12"><a href="#cb12-12"></a>                                          <span class="dt">fy.year =</span> <span class="st">"2016-17"</span>)]</span>
<span id="cb12-13"><a href="#cb12-13"></a>sample_file_<span class="dv">1617</span>[, avg_tax <span class="op">:</span><span class="er">=</span><span class="st"> </span>tax_paid <span class="op">/</span><span class="st"> </span>Taxable_Income]</span>
<span id="cb12-14"><a href="#cb12-14"></a>sample_file_<span class="dv">2021</span>[, tax_paid <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="../reference/income_tax.html">income_tax</a></span>(Taxable_Income,</span>
<span id="cb12-15"><a href="#cb12-15"></a>                                          <span class="dt">.dots.ATO =</span> <span class="kw"><a href="https://Rdatatable.gitlab.io/data.table/reference/copy.html">copy</a></span>(sample_file_<span class="dv">2021</span>),</span>
<span id="cb12-16"><a href="#cb12-16"></a>                                          <span class="dt">fy.year =</span> <span class="st">"2019-20"</span>)]</span>
<span id="cb12-17"><a href="#cb12-17"></a>sample_file_<span class="dv">2021</span>[, avg_tax <span class="op">:</span><span class="er">=</span><span class="st"> </span>tax_paid <span class="op">/</span><span class="st"> </span>Taxable_Income]</span>
<span id="cb12-18"><a href="#cb12-18"></a></span>
<span id="cb12-19"><a href="#cb12-19"></a>avg_tax_by_decile_<span class="dv">1617</span> &lt;-<span class="st"> </span></span>
<span id="cb12-20"><a href="#cb12-20"></a><span class="st">  </span>sample_file_<span class="dv">1617</span> <span class="op">%&gt;%</span></span>
<span id="cb12-21"><a href="#cb12-21"></a><span class="st">  </span>.[, .(<span class="dt">avg_tax =</span> <span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(avg_tax)),</span>
<span id="cb12-22"><a href="#cb12-22"></a>    keyby =<span class="st"> </span>.(<span class="dt">decile =</span> <span class="kw"><a href="https://rdrr.io/pkg/hutils/man/weighted_ntile.html">weighted_ntile</a></span>(Taxable_Income, <span class="dt">n =</span> <span class="dv">10</span>))]</span>
<span id="cb12-23"><a href="#cb12-23"></a></span>
<span id="cb12-24"><a href="#cb12-24"></a>avg_tax_by_decile_<span class="dv">2021</span> &lt;-<span class="st"> </span></span>
<span id="cb12-25"><a href="#cb12-25"></a><span class="st">  </span>sample_file_<span class="dv">2021</span> <span class="op">%&gt;%</span></span>
<span id="cb12-26"><a href="#cb12-26"></a><span class="st">  </span>.[, .(<span class="dt">avg_tax =</span> <span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(avg_tax)),</span>
<span id="cb12-27"><a href="#cb12-27"></a>    keyby =<span class="st"> </span>.(<span class="dt">decile =</span> <span class="kw"><a href="https://rdrr.io/pkg/hutils/man/weighted_ntile.html">weighted_ntile</a></span>(Taxable_Income, <span class="dt">n =</span> <span class="dv">10</span>))]</span>
<span id="cb12-28"><a href="#cb12-28"></a></span>
<span id="cb12-29"><a href="#cb12-29"></a>difference_<span class="dv">2021</span>_Budget &lt;-</span>
<span id="cb12-30"><a href="#cb12-30"></a><span class="st">  </span>avg_tax_by_decile_<span class="dv">1617</span>[avg_tax_by_decile_<span class="dv">2021</span>] <span class="op">%&gt;%</span></span>
<span id="cb12-31"><a href="#cb12-31"></a><span class="st">  </span>.[decile <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>] <span class="op">%&gt;%</span></span>
<span id="cb12-32"><a href="#cb12-32"></a><span class="st">  </span>.[, ppt_increase <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">100</span><span class="op">*</span>(i.avg_tax <span class="op">-</span><span class="st"> </span>avg_tax)]</span>
<span id="cb12-33"><a href="#cb12-33"></a></span>
<span id="cb12-34"><a href="#cb12-34"></a>difference_<span class="dv">2021</span>_Budget <span class="op">%&gt;%</span></span>
<span id="cb12-35"><a href="#cb12-35"></a><span class="st">  </span>copy <span class="op">%&gt;%</span></span>
<span id="cb12-36"><a href="#cb12-36"></a><span class="st">  </span>.[, decile <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(decile)] <span class="op">%&gt;%</span></span>
<span id="cb12-37"><a href="#cb12-37"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> decile, <span class="dt">y =</span> ppt_increase)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb12-38"><a href="#cb12-38"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span>()</span></code></pre></div>
<p>Through some intermediate calculations, we can obtain the sentence that was used in the op-ed:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>middle_income_avg_inc &lt;-</span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="st">  </span>difference_<span class="dv">2021</span>_Budget <span class="op">%&gt;%</span></span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="st">  </span>.[decile <span class="op">%between%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">3</span>, <span class="dv">7</span>)] <span class="op">%$%</span></span>
<span id="cb13-4"><a href="#cb13-4"></a><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/base/range.html">range</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(ppt_increase, <span class="dv">1</span>))</span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a>sample_file_<span class="dv">1617</span>[, percentile <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/hutils/man/weighted_ntile.html">weighted_ntile</a></span>(Taxable_Income, <span class="dt">n =</span> <span class="dv">100</span>)]</span>
<span id="cb14-2"><a href="#cb14-2"></a><span class="kw"><a href="https://rdrr.io/r/base/stopifnot.html">stopifnot</a></span>(<span class="dv">56</span> <span class="op">%in%</span><span class="st"> </span>sample_file_<span class="dv">1617</span>[Taxable_Income <span class="op">%between%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">49500</span>, <span class="dv">50500</span>)][[<span class="st">"percentile"</span>]])</span>
<span id="cb14-3"><a href="#cb14-3"></a></span>
<span id="cb14-4"><a href="#cb14-4"></a>avg_tax_rate_<span class="dv">2017</span>_50k &lt;-<span class="st"> </span></span>
<span id="cb14-5"><a href="#cb14-5"></a><span class="st">  </span>sample_file_<span class="dv">1617</span>[percentile <span class="op">==</span><span class="st"> </span><span class="dv">56</span>] <span class="op">%$%</span><span class="st"> </span></span>
<span id="cb14-6"><a href="#cb14-6"></a><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(avg_tax) <span class="op">%&gt;%</span></span>
<span id="cb14-7"><a href="#cb14-7"></a><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="dv">3</span>)</span>
<span id="cb14-8"><a href="#cb14-8"></a></span>
<span id="cb14-9"><a href="#cb14-9"></a>avg_tax_rate_<span class="dv">2021</span>_50k &lt;-<span class="st"> </span></span>
<span id="cb14-10"><a href="#cb14-10"></a><span class="st">  </span>sample_file_<span class="dv">2021</span> <span class="op">%&gt;%</span></span>
<span id="cb14-11"><a href="#cb14-11"></a><span class="st">  </span>.[, percentile <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/hutils/man/weighted_ntile.html">weighted_ntile</a></span>(Taxable_Income, <span class="dt">n =</span> <span class="dv">100</span>)] <span class="op">%&gt;%</span></span>
<span id="cb14-12"><a href="#cb14-12"></a><span class="st">  </span>.[percentile <span class="op">==</span><span class="st"> </span><span class="dv">56</span>] <span class="op">%$%</span><span class="st"> </span></span>
<span id="cb14-13"><a href="#cb14-13"></a><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(avg_tax) <span class="op">%&gt;%</span></span>
<span id="cb14-14"><a href="#cb14-14"></a><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="dv">3</span>)</span></code></pre></div>
<blockquote>
<p>Middle-income earners are particularly hurt by bracket creep. Based on the wages growth projected in the 2016 budget, the average tax rates for people in middle-income groups will increase by between res and res percentage points by 2021. For example, a person earning $50,000 a year will go from paying an average tax rate of res per cent in 2017 to res per cent in 2021.</p>
</blockquote>
</div>
<div id="income-tax-with-changes-to-rates" class="section level3">
<h3 class="hasAnchor">
<a href="#income-tax-with-changes-to-rates" class="anchor"></a>Income tax with changes to rates</h3>
<p>We can also use the package to estimate the revenue difference under changes to the marginal tax rates. The following function accepts two arguments: the bracket number to modified, and a rate increase to that bracket. The function returns the change in revenue (as a loss).</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a>tax_delta &lt;-<span class="st"> </span><span class="cf">function</span>(bracket_number, <span class="dt">rate_increase =</span> <span class="fl">-0.01</span>) {</span>
<span id="cb15-2"><a href="#cb15-2"></a>  current_tax &lt;-</span>
<span id="cb15-3"><a href="#cb15-3"></a><span class="st">    </span>sample_file_<span class="dv">2021</span>[, .(<span class="dt">tax =</span> <span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(tax_paid), </span>
<span id="cb15-4"><a href="#cb15-4"></a>                         <span class="dt">WEIGHT =</span> WEIGHT[<span class="dv">1</span>])] <span class="op">%$%</span><span class="st"> </span></span>
<span id="cb15-5"><a href="#cb15-5"></a><span class="st">    </span><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(tax <span class="op">*</span><span class="st"> </span>WEIGHT)</span>
<span id="cb15-6"><a href="#cb15-6"></a>  </span>
<span id="cb15-7"><a href="#cb15-7"></a>  orig_rates &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>, <span class="fl">0.19</span>, <span class="fl">0.325</span>, <span class="fl">0.37</span>, <span class="fl">0.45</span>)</span>
<span id="cb15-8"><a href="#cb15-8"></a>  new_rates &lt;-<span class="st"> </span>orig_rates</span>
<span id="cb15-9"><a href="#cb15-9"></a>  new_rates[bracket_number] &lt;-<span class="st"> </span>new_rates[bracket_number] <span class="op">+</span><span class="st"> </span>rate_increase</span>
<span id="cb15-10"><a href="#cb15-10"></a>    </span>
<span id="cb15-11"><a href="#cb15-11"></a>  <span class="co"># rebate_income is an internal function</span></span>
<span id="cb15-12"><a href="#cb15-12"></a>  .ri &lt;-<span class="st"> </span>grattan<span class="op">:::</span>rebate_income</span>
<span id="cb15-13"><a href="#cb15-13"></a>  </span>
<span id="cb15-14"><a href="#cb15-14"></a>  new_tax &lt;-<span class="st"> </span></span>
<span id="cb15-15"><a href="#cb15-15"></a><span class="st">    </span>sample_file_<span class="dv">2021</span> <span class="op">%&gt;%</span></span>
<span id="cb15-16"><a href="#cb15-16"></a><span class="st">    </span><span class="co"># memory is tight on e.g. Travis-CI</span></span>
<span id="cb15-17"><a href="#cb15-17"></a><span class="st">    </span><span class="kw"><a href="https://rdrr.io/pkg/hutils/man/selector.html">selector</a></span>(<span class="dt">cols =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"age_range"</span>,</span>
<span id="cb15-18"><a href="#cb15-18"></a>                      <span class="st">"Net_rent_amt"</span>,</span>
<span id="cb15-19"><a href="#cb15-19"></a>                      <span class="st">"Rep_frng_ben_amt"</span>,</span>
<span id="cb15-20"><a href="#cb15-20"></a>                      <span class="st">"Spouse_adjusted_taxable_inc"</span>, </span>
<span id="cb15-21"><a href="#cb15-21"></a>                      <span class="st">"Net_fincl_invstmt_lss_amt"</span>,</span>
<span id="cb15-22"><a href="#cb15-22"></a>                      <span class="st">"Rptbl_Empr_spr_cont_amt"</span>, </span>
<span id="cb15-23"><a href="#cb15-23"></a>                      <span class="st">"Taxable_Income"</span>, </span>
<span id="cb15-24"><a href="#cb15-24"></a>                      <span class="st">"WEIGHT"</span>, </span>
<span id="cb15-25"><a href="#cb15-25"></a>                      <span class="st">"tax_paid"</span>)) <span class="op">%&gt;%</span></span>
<span id="cb15-26"><a href="#cb15-26"></a><span class="st">    </span>.[, base_tax. <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="../reference/IncomeTax.html">IncomeTax</a></span>(Taxable_Income,</span>
<span id="cb15-27"><a href="#cb15-27"></a>                              <span class="dt">thresholds =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>, <span class="dv">18200</span>, <span class="dv">37000</span>, <span class="dv">87000</span>, <span class="fl">180e3</span>),</span>
<span id="cb15-28"><a href="#cb15-28"></a>                              <span class="dt">rates =</span> new_rates)] <span class="op">%&gt;%</span></span>
<span id="cb15-29"><a href="#cb15-29"></a><span class="st">    </span>.[, medicare_levy. <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="../reference/medicare_levy.html">medicare_levy</a></span>(<span class="dt">income =</span> Taxable_Income,</span>
<span id="cb15-30"><a href="#cb15-30"></a>                                        <span class="dt">fy.year =</span> <span class="st">"2019-20"</span>,</span>
<span id="cb15-31"><a href="#cb15-31"></a>                                        <span class="dt">Spouse_income =</span> Spouse_adjusted_taxable_inc,</span>
<span id="cb15-32"><a href="#cb15-32"></a>                                        <span class="dt">sapto.eligible =</span> (age_range <span class="op">&lt;=</span><span class="st"> </span><span class="dv">1</span>),</span>
<span id="cb15-33"><a href="#cb15-33"></a>                                        <span class="dt">family_status =</span> <span class="kw"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span>(Spouse_adjusted_taxable_inc <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, <span class="st">"family"</span>, <span class="st">"individual"</span>))] <span class="op">%&gt;%</span></span>
<span id="cb15-34"><a href="#cb15-34"></a><span class="st">    </span>.[, lito. <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="../reference/lito.html">lito</a></span>(Taxable_Income, <span class="dt">max_lito =</span> <span class="dv">445</span>, <span class="dt">lito_taper =</span> <span class="fl">0.015</span>, <span class="dt">min_bracket =</span> <span class="dv">37000</span>)] <span class="op">%&gt;%</span></span>
<span id="cb15-35"><a href="#cb15-35"></a><span class="st">    </span>.[, rebate_income <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">.ri</span>(Taxable_Income,</span>
<span id="cb15-36"><a href="#cb15-36"></a>                             <span class="dt">Rptbl_Empr_spr_cont_amt =</span> Rptbl_Empr_spr_cont_amt,</span>
<span id="cb15-37"><a href="#cb15-37"></a>                             <span class="dt">Net_fincl_invstmt_lss_amt =</span> Net_fincl_invstmt_lss_amt,</span>
<span id="cb15-38"><a href="#cb15-38"></a>                             <span class="dt">Net_rent_amt =</span> Net_rent_amt,</span>
<span id="cb15-39"><a href="#cb15-39"></a>                             <span class="dt">Rep_frng_ben_amt =</span> Rep_frng_ben_amt)] <span class="op">%&gt;%</span></span>
<span id="cb15-40"><a href="#cb15-40"></a><span class="st">    </span>.[, sapto. <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="../reference/sapto.html">sapto</a></span>(rebate_income, <span class="dt">fy.year =</span> <span class="st">"2019-20"</span>, <span class="dt">sapto.eligible =</span> (age_range <span class="op">&lt;=</span><span class="st"> </span><span class="dv">1</span>))] <span class="op">%&gt;%</span></span>
<span id="cb15-41"><a href="#cb15-41"></a><span class="st">    </span>.[, tax_payable <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="../reference/pmaxC.html">pmaxC</a></span>(base_tax. <span class="op">-</span><span class="st"> </span>lito. <span class="op">-</span><span class="st"> </span>sapto., <span class="dv">0</span>) <span class="op">+</span><span class="st"> </span>medicare_levy.] <span class="op">%&gt;%</span></span>
<span id="cb15-42"><a href="#cb15-42"></a><span class="st">    </span>.[, .(<span class="dt">tax =</span> <span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(tax_payable), </span>
<span id="cb15-43"><a href="#cb15-43"></a>          <span class="dt">WEIGHT =</span> WEIGHT[<span class="dv">1</span>])] <span class="op">%$%</span><span class="st"> </span></span>
<span id="cb15-44"><a href="#cb15-44"></a><span class="st">    </span><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(tax <span class="op">*</span><span class="st"> </span>WEIGHT)</span>
<span id="cb15-45"><a href="#cb15-45"></a>  </span>
<span id="cb15-46"><a href="#cb15-46"></a>  current_tax <span class="op">-</span><span class="st"> </span>new_tax</span>
<span id="cb15-47"><a href="#cb15-47"></a>}</span></code></pre></div>
<p>which leads to the sentence and table in the op-ed:</p>
<blockquote>
<p>For example, if the government was to reduce the tax rate only in the middle (37,000-87,000) bracket from 32.5% to 30%, the promised $7.8 billion surplus in 2021 would all but be swallowed up by the res bn revenue loss.</p>
</blockquote>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="kw"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span>(<span class="dt">tax_bracket =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"&lt;18,200"</span>,</span>
<span id="cb16-2"><a href="#cb16-2"></a>                           <span class="st">"18,200-37,000"</span>,</span>
<span id="cb16-3"><a href="#cb16-3"></a>                           <span class="st">"37,000-87,000"</span>,</span>
<span id="cb16-4"><a href="#cb16-4"></a>                           <span class="st">"87,000-180,000"</span>,</span>
<span id="cb16-5"><a href="#cb16-5"></a>                           <span class="st">"180,000+"</span>),</span>
<span id="cb16-6"><a href="#cb16-6"></a>           <span class="dt">budget_impact =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="ot">NA</span>, <span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/lapply.html">vapply</a></span>(<span class="dv">2</span><span class="op">:</span><span class="dv">5</span>, tax_delta, <span class="dt">FUN.VALUE =</span> <span class="kw"><a href="https://rdrr.io/r/base/double.html">double</a></span>(<span class="dv">1</span>)) <span class="op">/</span><span class="st"> </span><span class="fl">1e9</span>, <span class="dv">2</span>))) <span class="op">%&gt;%</span></span>
<span id="cb16-7"><a href="#cb16-7"></a><span class="st">  </span>kable</span></code></pre></div>
</div>
</div>
</div>
<div id="companion-to-the-2013-14-sample-file" class="section level1">
<h1 class="hasAnchor">
<a href="#companion-to-the-2013-14-sample-file" class="anchor"></a>Companion to the 2013-14 sample file</h1>
<div id="prologue" class="section level2">
<h2 class="hasAnchor">
<a href="#prologue" class="anchor"></a>Prologue</h2>
<p>This vignette is a mirror of a small book prepared internally by Grattan Institute. The goal is to demonstrate how to perform simple analysis and create common charts. You will need the <code>taxstats</code> package available via <code><a href="https://rdrr.io/pkg/devtools/man/remote-reexports.html">devtools::install_github('hughparsonage/taxstats')</a></code>.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a><span class="kw"><a href="https://rdrr.io/r/base/options.html">options</a></span>(<span class="st">"scipen"</span> =<span class="st"> </span><span class="dv">99</span>)</span>
<span id="cb17-2"><a href="#cb17-2"></a>opts_chunk<span class="op">$</span><span class="kw"><a href="https://Rdatatable.gitlab.io/data.table/reference/assign.html">set</a></span>(<span class="dt">fig.width =</span> <span class="dv">9</span>,</span>
<span id="cb17-3"><a href="#cb17-3"></a>               <span class="dt">fig.height =</span> <span class="fl">6.5</span>,</span>
<span id="cb17-4"><a href="#cb17-4"></a>               <span class="dt">warn =</span> <span class="ot">FALSE</span>)</span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a>FY.YEAR &lt;-<span class="st"> "2013-14"</span></span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a>wsum &lt;-<span class="st"> </span><span class="cf">function</span>(x, <span class="dt">w =</span> <span class="dv">1</span>){</span>
<span id="cb19-2"><a href="#cb19-2"></a>  <span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>((x) <span class="op">*</span><span class="st"> </span>w)</span>
<span id="cb19-3"><a href="#cb19-3"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a>grattan_dollar &lt;-<span class="st"> </span><span class="cf">function</span> (x, <span class="dt">digits =</span> <span class="dv">0</span>) {</span>
<span id="cb20-2"><a href="#cb20-2"></a>  <span class="co">#</span></span>
<span id="cb20-3"><a href="#cb20-3"></a>  nsmall &lt;-<span class="st"> </span>digits</span>
<span id="cb20-4"><a href="#cb20-4"></a>  commaz &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/format.html">format</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(x), <span class="dt">nsmall =</span> nsmall, <span class="dt">trim =</span> <span class="ot">TRUE</span>, <span class="dt">big.mark =</span> <span class="st">","</span>, </span>
<span id="cb20-5"><a href="#cb20-5"></a>                   <span class="dt">scientific =</span> <span class="ot">FALSE</span>, <span class="dt">digits =</span> 1L)</span>
<span id="cb20-6"><a href="#cb20-6"></a>  </span>
<span id="cb20-7"><a href="#cb20-7"></a>  <span class="kw"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span>(x <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>, </span>
<span id="cb20-8"><a href="#cb20-8"></a>          <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"\U2212"</span>,<span class="st">"$"</span>, commaz),</span>
<span id="cb20-9"><a href="#cb20-9"></a>          <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"$"</span>, commaz))</span>
<span id="cb20-10"><a href="#cb20-10"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a>sample_file &lt;-<span class="st"> </span>sample_files_all[fy.year <span class="op">==</span><span class="st"> </span>FY.YEAR]</span>
<span id="cb21-2"><a href="#cb21-2"></a>sample_file &lt;-<span class="st"> </span><span class="kw"><a href="https://Rdatatable.gitlab.io/data.table/reference/merge.html">merge</a></span>(sample_file, age_range_decoder, <span class="dt">by =</span> <span class="st">"age_range"</span>)</span>
<span id="cb21-3"><a href="#cb21-3"></a>PREV.FY.YEAR &lt;-<span class="st"> </span><span class="kw"><a href="../reference/is.fy.html">yr2fy</a></span>(<span class="kw"><a href="../reference/is.fy.html">fy2yr</a></span>(FY.YEAR) <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)</span>
<span id="cb21-4"><a href="#cb21-4"></a>sample_file_prev &lt;-<span class="st"> </span>sample_files_all[fy.year <span class="op">==</span><span class="st"> </span>PREV.FY.YEAR]</span>
<span id="cb21-5"><a href="#cb21-5"></a>sample_file_prev &lt;-<span class="st"> </span><span class="kw"><a href="https://Rdatatable.gitlab.io/data.table/reference/merge.html">merge</a></span>(sample_file_prev, age_range_decoder, <span class="dt">by =</span> <span class="st">"age_range"</span>)</span></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">48031</span>)</span>
<span id="cb22-2"><a href="#cb22-2"></a>sample_file <span class="op">%&lt;&gt;%</span></span>
<span id="cb22-3"><a href="#cb22-3"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(age_range_description) <span class="op">%&gt;%</span></span>
<span id="cb22-4"><a href="#cb22-4"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">min_age =</span> <span class="kw"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span>(<span class="st">"to"</span>, age_range_description), </span>
<span id="cb22-5"><a href="#cb22-5"></a>                           <span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span>(<span class="st">"^([0-9]{2}).*$"</span>, <span class="st">"</span><span class="ch">\\</span><span class="st">1"</span>, age_range_description)), </span>
<span id="cb22-6"><a href="#cb22-6"></a>                           <span class="kw"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span>(<span class="st">"70"</span>, age_range_description),</span>
<span id="cb22-7"><a href="#cb22-7"></a>                                   <span class="dv">70</span>, </span>
<span id="cb22-8"><a href="#cb22-8"></a>                                   <span class="dv">15</span>)),</span>
<span id="cb22-9"><a href="#cb22-9"></a>         <span class="dt">max_age =</span> min_age <span class="op">+</span><span class="st"> </span><span class="dv">5</span>, </span>
<span id="cb22-10"><a href="#cb22-10"></a>         <span class="dt">age_imp =</span> <span class="kw"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw"><a href="https://dplyr.tidyverse.org/reference/n.html">n</a></span>(), min_age, max_age)) <span class="op">%&gt;%</span></span>
<span id="cb22-11"><a href="#cb22-11"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="op">-</span>min_age, <span class="op">-</span>max_age)</span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a>sample_file <span class="op">%&lt;&gt;%</span></span>
<span id="cb23-2"><a href="#cb23-2"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">Tax_Bracket =</span> <span class="kw"><a href="https://rdrr.io/r/base/cut.html">cut</a></span>(Taxable_Income, </span>
<span id="cb23-3"><a href="#cb23-3"></a>                           <span class="dt">breaks =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="ot">Inf</span>, <span class="dv">18200</span>, <span class="fl">37e3</span>, <span class="fl">80e3</span>, <span class="fl">180e3</span>, <span class="ot">Inf</span>),</span>
<span id="cb23-4"><a href="#cb23-4"></a>                           <span class="dt">include.lowest =</span> <span class="ot">TRUE</span>, </span>
<span id="cb23-5"><a href="#cb23-5"></a>                           <span class="dt">labels =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"$0-$18,200"</span>, </span>
<span id="cb23-6"><a href="#cb23-6"></a>                                      <span class="st">"$18,201-$37,000"</span>, </span>
<span id="cb23-7"><a href="#cb23-7"></a>                                      <span class="st">"37,001-$80,000"</span>, </span>
<span id="cb23-8"><a href="#cb23-8"></a>                                      <span class="st">"$80,001-$180,000"</span>, </span>
<span id="cb23-9"><a href="#cb23-9"></a>                                      <span class="st">"$180,000+"</span>)))</span></code></pre></div>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a>texNum &lt;-<span class="st"> </span><span class="cf">function</span>(number, <span class="dt">sig.figs =</span> 3L, <span class="dt">dollar =</span> <span class="ot">FALSE</span>, <span class="dt">pre.phrase =</span> <span class="ot">NULL</span>, <span class="dt">.suffix =</span> <span class="ot">NULL</span>){</span>
<span id="cb24-2"><a href="#cb24-2"></a>  orig.number &lt;-<span class="st"> </span>number</span>
<span id="cb24-3"><a href="#cb24-3"></a>  <span class="kw"><a href="https://rdrr.io/r/base/stopifnot.html">stopifnot</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/numeric.html">is.numeric</a></span>(number), <span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(number) <span class="op">==</span><span class="st"> </span>1L)</span>
<span id="cb24-4"><a href="#cb24-4"></a>  is.negative &lt;-<span class="st"> </span>number <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span></span>
<span id="cb24-5"><a href="#cb24-5"></a>  number &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(number)</span>
<span id="cb24-6"><a href="#cb24-6"></a>  <span class="cf">if</span> (number <span class="op">==</span><span class="st"> </span><span class="dv">0</span>){</span>
<span id="cb24-7"><a href="#cb24-7"></a>    <span class="kw"><a href="https://rdrr.io/r/base/warning.html">warning</a></span>(<span class="st">"Returning 0"</span>)</span>
<span id="cb24-8"><a href="#cb24-8"></a>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="dv">0</span>)</span>
<span id="cb24-9"><a href="#cb24-9"></a>  } <span class="cf">else</span> {</span>
<span id="cb24-10"><a href="#cb24-10"></a>    <span class="cf">if</span> (<span class="kw"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(.suffix)){</span>
<span id="cb24-11"><a href="#cb24-11"></a>    n.digits &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/Log.html">log10</a></span>(number))</span>
<span id="cb24-12"><a href="#cb24-12"></a>    </span>
<span id="cb24-13"><a href="#cb24-13"></a>    suffix &lt;-<span class="st"> </span><span class="ot">NULL</span></span>
<span id="cb24-14"><a href="#cb24-14"></a>    suffix_val &lt;-<span class="st"> </span><span class="dv">1</span></span>
<span id="cb24-15"><a href="#cb24-15"></a>    </span>
<span id="cb24-16"><a href="#cb24-16"></a>    <span class="cf">if</span> (n.digits <span class="op">&lt;</span><span class="st"> </span>sig.figs){</span>
<span id="cb24-17"><a href="#cb24-17"></a>      prefix &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Round.html">signif</a></span>(<span class="dt">x =</span> number, <span class="dt">digits =</span> sig.figs)</span>
<span id="cb24-18"><a href="#cb24-18"></a>    } <span class="cf">else</span> {</span>
<span id="cb24-19"><a href="#cb24-19"></a>      </span>
<span id="cb24-20"><a href="#cb24-20"></a>      <span class="cf">if</span> (n.digits <span class="op">&lt;=</span><span class="st"> </span><span class="dv">6</span>) {</span>
<span id="cb24-21"><a href="#cb24-21"></a>        prefix_val &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(number, sig.figs <span class="op">-</span><span class="st"> </span>n.digits <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)</span>
<span id="cb24-22"><a href="#cb24-22"></a>        prefix &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/formatc.html">prettyNum</a></span>(prefix_val, <span class="dt">big.mark =</span> <span class="st">","</span>, <span class="dt">scientific =</span> <span class="ot">FALSE</span>)</span>
<span id="cb24-23"><a href="#cb24-23"></a>      } <span class="cf">else</span> {</span>
<span id="cb24-24"><a href="#cb24-24"></a>        <span class="co"># Want to show only the number / 10^(multiple of 3) then the suffix multiplier</span></span>
<span id="cb24-25"><a href="#cb24-25"></a>        suffix_val &lt;-<span class="st"> </span><span class="dv">10</span> <span class="op">^</span><span class="st"> </span>(<span class="dv">3</span> <span class="op">*</span><span class="st"> </span>((n.digits <span class="op">%/%</span><span class="st"> </span><span class="dv">3</span>)))</span>
<span id="cb24-26"><a href="#cb24-26"></a>        prefix_val &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Round.html">signif</a></span>(number<span class="op">/</span>suffix_val, <span class="dt">digits =</span> sig.figs)</span>
<span id="cb24-27"><a href="#cb24-27"></a>        prefix &lt;-<span class="st"> </span>prefix_val</span>
<span id="cb24-28"><a href="#cb24-28"></a>        </span>
<span id="cb24-29"><a href="#cb24-29"></a>        <span class="cf">if</span> (suffix_val <span class="op">&lt;=</span><span class="st"> </span><span class="dv">10</span><span class="op">^</span><span class="dv">12</span>){</span>
<span id="cb24-30"><a href="#cb24-30"></a>          <span class="cf">switch</span>(<span class="kw"><a href="https://rdrr.io/r/base/Log.html">log10</a></span>(suffix_val) <span class="op">/</span><span class="st"> </span><span class="dv">3</span> <span class="op">-</span><span class="st"> </span><span class="dv">1</span>,</span>
<span id="cb24-31"><a href="#cb24-31"></a>                 suffix &lt;-<span class="st"> "~million"</span>, </span>
<span id="cb24-32"><a href="#cb24-32"></a>                 suffix &lt;-<span class="st"> "~billion"</span>, </span>
<span id="cb24-33"><a href="#cb24-33"></a>                 suffix &lt;-<span class="st"> "~trillion"</span>)</span>
<span id="cb24-34"><a href="#cb24-34"></a>        } <span class="cf">else</span> {</span>
<span id="cb24-35"><a href="#cb24-35"></a>          prefix &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Round.html">signif</a></span>(number <span class="op">/</span><span class="st"> </span><span class="dv">10</span><span class="op">^</span><span class="dv">12</span>, <span class="dt">digits =</span> sig.figs)</span>
<span id="cb24-36"><a href="#cb24-36"></a>          suffix &lt;-<span class="st"> "~trillion"</span></span>
<span id="cb24-37"><a href="#cb24-37"></a>        }</span>
<span id="cb24-38"><a href="#cb24-38"></a>      }</span>
<span id="cb24-39"><a href="#cb24-39"></a>    }</span>
<span id="cb24-40"><a href="#cb24-40"></a>    } <span class="cf">else</span> {</span>
<span id="cb24-41"><a href="#cb24-41"></a>      <span class="kw"><a href="https://rdrr.io/r/base/stopifnot.html">stopifnot</a></span>(.suffix <span class="op">%in%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"million"</span>, <span class="st">"billion"</span>, <span class="st">"trillion"</span>))</span>
<span id="cb24-42"><a href="#cb24-42"></a>      <span class="cf">switch</span>(.suffix, </span>
<span id="cb24-43"><a href="#cb24-43"></a>             <span class="st">"million"</span> =<span class="st"> </span>{</span>
<span id="cb24-44"><a href="#cb24-44"></a>              prefix &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Round.html">signif</a></span>(number <span class="op">/</span><span class="st"> </span><span class="dv">10</span><span class="op">^</span><span class="dv">6</span>, <span class="dt">digits =</span> sig.figs)</span>
<span id="cb24-45"><a href="#cb24-45"></a>              suffix &lt;-<span class="st"> "~million"</span></span>
<span id="cb24-46"><a href="#cb24-46"></a>              suffix_val &lt;-<span class="st"> </span><span class="dv">10</span><span class="op">^</span><span class="dv">6</span></span>
<span id="cb24-47"><a href="#cb24-47"></a>             }, </span>
<span id="cb24-48"><a href="#cb24-48"></a>             <span class="st">"billion"</span> =<span class="st"> </span>{</span>
<span id="cb24-49"><a href="#cb24-49"></a>               prefix &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Round.html">signif</a></span>(number <span class="op">/</span><span class="st"> </span><span class="dv">10</span><span class="op">^</span><span class="dv">9</span>, <span class="dt">digits =</span> sig.figs)</span>
<span id="cb24-50"><a href="#cb24-50"></a>               suffix &lt;-<span class="st"> "~billion"</span></span>
<span id="cb24-51"><a href="#cb24-51"></a>               suffix_val &lt;-<span class="st"> </span><span class="dv">10</span><span class="op">^</span><span class="dv">9</span></span>
<span id="cb24-52"><a href="#cb24-52"></a>             }, </span>
<span id="cb24-53"><a href="#cb24-53"></a>             <span class="st">"trillion"</span> =<span class="st"> </span>{</span>
<span id="cb24-54"><a href="#cb24-54"></a>               prefix &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Round.html">signif</a></span>(number <span class="op">/</span><span class="st"> </span><span class="dv">10</span><span class="op">^</span><span class="dv">12</span>, <span class="dt">digits =</span> sig.figs)</span>
<span id="cb24-55"><a href="#cb24-55"></a>               suffix &lt;-<span class="st"> "~trillion"</span></span>
<span id="cb24-56"><a href="#cb24-56"></a>               suffix_val &lt;-<span class="st"> </span><span class="dv">10</span><span class="op">^</span><span class="dv">12</span></span>
<span id="cb24-57"><a href="#cb24-57"></a>             })</span>
<span id="cb24-58"><a href="#cb24-58"></a>      prefix_val &lt;-<span class="st"> </span>prefix</span>
<span id="cb24-59"><a href="#cb24-59"></a>    }</span>
<span id="cb24-60"><a href="#cb24-60"></a>    </span>
<span id="cb24-61"><a href="#cb24-61"></a>    <span class="cf">if</span> (dollar){</span>
<span id="cb24-62"><a href="#cb24-62"></a>      out &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"</span><span class="ch">\\</span><span class="st">$"</span>, prefix, suffix)</span>
<span id="cb24-63"><a href="#cb24-63"></a>    } <span class="cf">else</span> {</span>
<span id="cb24-64"><a href="#cb24-64"></a>      out &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(prefix, suffix)</span>
<span id="cb24-65"><a href="#cb24-65"></a>    }</span>
<span id="cb24-66"><a href="#cb24-66"></a>    </span>
<span id="cb24-67"><a href="#cb24-67"></a>    <span class="cf">if</span> (is.negative){</span>
<span id="cb24-68"><a href="#cb24-68"></a>      <span class="co"># General LaTeX</span></span>
<span id="cb24-69"><a href="#cb24-69"></a>      out &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"</span><span class="ch">\\</span><span class="st">(-</span><span class="ch">\\</span><span class="st">)"</span>, out)</span>
<span id="cb24-70"><a href="#cb24-70"></a>    }</span>
<span id="cb24-71"><a href="#cb24-71"></a>    <span class="co"># is the displayed number larger than the original?</span></span>
<span id="cb24-72"><a href="#cb24-72"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(pre.phrase)){</span>
<span id="cb24-73"><a href="#cb24-73"></a>      out_larger &lt;-<span class="st"> </span>prefix_val <span class="op">*</span><span class="st"> </span>suffix_val <span class="op">&gt;</span><span class="st"> </span>orig.number</span>
<span id="cb24-74"><a href="#cb24-74"></a>      </span>
<span id="cb24-75"><a href="#cb24-75"></a>        <span class="cf">if</span> (out_larger) {</span>
<span id="cb24-76"><a href="#cb24-76"></a>          out &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(pre.phrase[<span class="dv">1</span>], out, <span class="dt">sep =</span> <span class="cf">if</span>(<span class="kw"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span>(<span class="st">"~$"</span>, pre.phrase[<span class="dv">1</span>])) <span class="st">""</span> <span class="cf">else</span> <span class="st">" "</span>)</span>
<span id="cb24-77"><a href="#cb24-77"></a>        } <span class="cf">else</span> {</span>
<span id="cb24-78"><a href="#cb24-78"></a>          <span class="cf">if</span> (<span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/Logic.html">isTRUE</a></span>(<span class="kw"><a href="https://Rdatatable.gitlab.io/data.table/reference/all.equal.data.table.html">all.equal</a></span>(prefix_val <span class="op">*</span><span class="st"> </span>suffix_val, </span>
<span id="cb24-79"><a href="#cb24-79"></a>                                orig.number, </span>
<span id="cb24-80"><a href="#cb24-80"></a>                                <span class="dt">tolerance =</span> .Machine<span class="op">$</span>double.eps)))</span>
<span id="cb24-81"><a href="#cb24-81"></a>            out &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(pre.phrase[<span class="dv">2</span>], out, <span class="dt">sep =</span> <span class="cf">if</span>(<span class="kw"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span>(<span class="st">"~$"</span>, pre.phrase[<span class="dv">2</span>])) <span class="st">""</span> <span class="cf">else</span> <span class="st">" "</span>)</span>
<span id="cb24-82"><a href="#cb24-82"></a>        }</span>
<span id="cb24-83"><a href="#cb24-83"></a>      </span>
<span id="cb24-84"><a href="#cb24-84"></a>    }</span>
<span id="cb24-85"><a href="#cb24-85"></a>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span>(out)</span>
<span id="cb24-86"><a href="#cb24-86"></a>  }</span>
<span id="cb24-87"><a href="#cb24-87"></a>}</span></code></pre></div>
<p>There were res taxpayers in res in Australia. Of those, res had zero taxable income (or a taxable loss). (… and so these ‘’taxpayers’’ naturally paid no tax. Nor did the res individuals below the tax-free threshold. For this vignette, a <em>taxpayer</em> is anyone who lodged a tax return, regardless of their tax liability).</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a>tx_inc_q &lt;-<span class="st"> </span><span class="cf">function</span>(q){</span>
<span id="cb25-2"><a href="#cb25-2"></a>  <span class="kw"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(sample_file<span class="op">$</span>Taxable_Income, <span class="dt">probs =</span> q)</span>
<span id="cb25-3"><a href="#cb25-3"></a>}</span>
<span id="cb25-4"><a href="#cb25-4"></a></span>
<span id="cb25-5"><a href="#cb25-5"></a>my_labs &lt;-<span class="st"> </span><span class="kw">grattan_dollar</span>(<span class="kw">tx_inc_q</span>((<span class="dv">0</span><span class="op">:</span><span class="dv">10</span>)<span class="op">/</span><span class="dv">10</span>))</span>
<span id="cb25-6"><a href="#cb25-6"></a>my_labs[<span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="dv">2</span>, <span class="dv">10</span>, <span class="dv">2</span>)] &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span>, my_labs[<span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="dv">2</span>, <span class="dv">10</span>, <span class="dv">2</span>)])</span>
<span id="cb25-7"><a href="#cb25-7"></a></span>
<span id="cb25-8"><a href="#cb25-8"></a>dens &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/density.html">density</a></span>(sample_file[Taxable_Income <span class="op">&lt;</span><span class="st"> </span><span class="kw">tx_inc_q</span>(<span class="fl">0.95</span>)]<span class="op">$</span>Taxable_Income)</span>
<span id="cb25-9"><a href="#cb25-9"></a>DF &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/with.html">with</a></span>(dens, <span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(x, y))</span>
<span id="cb25-10"><a href="#cb25-10"></a></span>
<span id="cb25-11"><a href="#cb25-11"></a>sample_file <span class="op">%&gt;%</span></span>
<span id="cb25-12"><a href="#cb25-12"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">Taxable_Income_decile =</span> <span class="kw"><a href="https://dplyr.tidyverse.org/reference/ranking.html">ntile</a></span>(Taxable_Income, <span class="dv">10</span>)) <span class="op">%&gt;%</span></span>
<span id="cb25-13"><a href="#cb25-13"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="kw"><a href="https://dplyr.tidyverse.org/reference/between.html">between</a></span>(Taxable_Income, <span class="dv">0</span>, <span class="kw">tx_inc_q</span>(<span class="fl">0.95</span>))) <span class="op">%&gt;%</span></span>
<span id="cb25-14"><a href="#cb25-14"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> Taxable_Income)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb25-15"><a href="#cb25-15"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html">geom_density</a></span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb25-16"><a href="#cb25-16"></a><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/viridis/man/scale_viridis.html">scale_fill_viridis</a></span>(<span class="dt">discrete =</span> <span class="ot">TRUE</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb25-17"><a href="#cb25-17"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span>(<span class="st">"Taxable Income deciles"</span>, </span>
<span id="cb25-18"><a href="#cb25-18"></a>                     <span class="dt">labels =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(my_labs, <span class="kw">grattan_dollar</span>(<span class="kw">tx_inc_q</span>(<span class="fl">0.95</span>))),</span>
<span id="cb25-19"><a href="#cb25-19"></a>                     <span class="co"># limits = c(0, tx_inc_q(0.95)),</span></span>
<span id="cb25-20"><a href="#cb25-20"></a>                     <span class="dt">breaks =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">tx_inc_q</span>((<span class="dv">0</span><span class="op">:</span><span class="dv">10</span>)<span class="op">/</span><span class="dv">10</span>), <span class="kw">tx_inc_q</span>(<span class="fl">0.95</span>))) <span class="op">+</span><span class="st"> </span></span>
<span id="cb25-21"><a href="#cb25-21"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(<span class="dt">expand =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>,<span class="dv">0</span>)) <span class="op">+</span></span>
<span id="cb25-22"><a href="#cb25-22"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="dt">legend.position =</span> <span class="st">"none"</span>, </span>
<span id="cb25-23"><a href="#cb25-23"></a>        <span class="dt">axis.line.y =</span> <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span>(), </span>
<span id="cb25-24"><a href="#cb25-24"></a>        <span class="dt">axis.text.y =</span> <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span>(), </span>
<span id="cb25-25"><a href="#cb25-25"></a>        <span class="dt">axis.title.y =</span> <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span>())</span></code></pre></div>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a>DF <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb26-2"><a href="#cb26-2"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">Taxable_Income_decile =</span> <span class="kw"><a href="https://rdrr.io/r/base/cut.html">cut</a></span>(x, </span>
<span id="cb26-3"><a href="#cb26-3"></a>                                     <span class="dt">breaks =</span> <span class="kw"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(sample_file<span class="op">$</span>Taxable_Income,</span>
<span id="cb26-4"><a href="#cb26-4"></a>                                                       <span class="dt">probs =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span><span class="op">:</span><span class="dv">10</span>)<span class="op">/</span><span class="dv">10</span>), </span>
<span id="cb26-5"><a href="#cb26-5"></a>                                     <span class="dt">right =</span> <span class="ot">TRUE</span>,</span>
<span id="cb26-6"><a href="#cb26-6"></a>                                     <span class="dt">include.lowest =</span> <span class="ot">TRUE</span>)) <span class="op">%&gt;%</span></span>
<span id="cb26-7"><a href="#cb26-7"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="kw"><a href="https://dplyr.tidyverse.org/reference/between.html">between</a></span>(x, <span class="dv">-1</span>, <span class="kw">tx_inc_q</span>(<span class="fl">0.95</span>) <span class="op">*</span><span class="st"> </span><span class="fl">1.05</span>)) <span class="op">%&gt;%</span></span>
<span id="cb26-8"><a href="#cb26-8"></a><span class="st">  </span>{</span>
<span id="cb26-9"><a href="#cb26-9"></a>    <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(., <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb26-10"><a href="#cb26-10"></a><span class="st">      </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_area</a></span>(<span class="dt">color =</span> <span class="st">"black"</span>, <span class="dt">size =</span> <span class="fl">1.45</span>) <span class="op">+</span></span>
<span id="cb26-11"><a href="#cb26-11"></a><span class="st">      </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_area</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y, </span>
<span id="cb26-12"><a href="#cb26-12"></a>                    <span class="dt">group =</span> Taxable_Income_decile, </span>
<span id="cb26-13"><a href="#cb26-13"></a>                    <span class="dt">fill =</span> <span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(Taxable_Income_decile),</span>
<span id="cb26-14"><a href="#cb26-14"></a>                    <span class="dt">color =</span> <span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(Taxable_Income_decile))) <span class="op">+</span><span class="st"> </span></span>
<span id="cb26-15"><a href="#cb26-15"></a><span class="st">      </span><span class="kw"><a href="https://rdrr.io/pkg/viridis/man/scale_viridis.html">scale_color_viridis</a></span>(<span class="dt">discrete =</span> <span class="ot">TRUE</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb26-16"><a href="#cb26-16"></a><span class="st">      </span><span class="kw"><a href="https://rdrr.io/pkg/viridis/man/scale_viridis.html">scale_fill_viridis</a></span>(<span class="dt">discrete =</span> <span class="ot">TRUE</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb26-17"><a href="#cb26-17"></a><span class="st">      </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span>(<span class="st">"Taxable Income deciles"</span>, </span>
<span id="cb26-18"><a href="#cb26-18"></a>                         <span class="dt">labels =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(my_labs, <span class="kw">grattan_dollar</span>(<span class="kw">tx_inc_q</span>(<span class="fl">0.95</span>))),</span>
<span id="cb26-19"><a href="#cb26-19"></a>                         <span class="dt">expand =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>,<span class="dv">0</span>),</span>
<span id="cb26-20"><a href="#cb26-20"></a>                         <span class="co"># limits = c(-1, tx_inc_q(0.95)*1.05),</span></span>
<span id="cb26-21"><a href="#cb26-21"></a>                         <span class="dt">breaks =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">tx_inc_q</span>((<span class="dv">0</span><span class="op">:</span><span class="dv">10</span>)<span class="op">/</span><span class="dv">10</span>), <span class="kw">tx_inc_q</span>(<span class="fl">0.95</span>))) <span class="op">+</span><span class="st"> </span></span>
<span id="cb26-22"><a href="#cb26-22"></a><span class="st">      </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(<span class="dt">expand =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>,<span class="dv">0</span>), <span class="dt">limits =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>, <span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(.<span class="op">$</span>y) <span class="op">*</span><span class="st"> </span><span class="fl">1.05</span>)) <span class="op">+</span></span>
<span id="cb26-23"><a href="#cb26-23"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="dt">legend.position =</span> <span class="st">"none"</span>, </span>
<span id="cb26-24"><a href="#cb26-24"></a>        <span class="dt">axis.line.y =</span> <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span>(), </span>
<span id="cb26-25"><a href="#cb26-25"></a>        <span class="dt">axis.text.y =</span> <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span>(), </span>
<span id="cb26-26"><a href="#cb26-26"></a>        <span class="dt">axis.title.y =</span> <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span>())<span class="op">+</span><span class="st"> </span></span>
<span id="cb26-27"><a href="#cb26-27"></a><span class="st">      </span></span>
<span id="cb26-28"><a href="#cb26-28"></a><span class="st">      </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span>(<span class="st">"text"</span>,</span>
<span id="cb26-29"><a href="#cb26-29"></a>               <span class="dt">x =</span> <span class="kw">tx_inc_q</span>(<span class="fl">0.925</span>), </span>
<span id="cb26-30"><a href="#cb26-30"></a>               <span class="dt">y =</span> <span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(.<span class="op">$</span>y[.<span class="op">$</span>x <span class="op">&gt;</span><span class="st"> </span><span class="kw">tx_inc_q</span>(<span class="fl">0.925</span>)]),</span>
<span id="cb26-31"><a href="#cb26-31"></a>               <span class="dt">size =</span> <span class="dv">10</span><span class="op">/</span>(<span class="dv">14</span><span class="op">/</span><span class="dv">5</span>),</span>
<span id="cb26-32"><a href="#cb26-32"></a>               <span class="dt">label =</span> <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"5% of taxpayers</span><span class="ch">\n</span><span class="st">had incomes</span><span class="ch">\n</span><span class="st">greater than</span><span class="ch">\n</span><span class="st">"</span>, <span class="kw">grattan_dollar</span>(<span class="kw">tx_inc_q</span>(<span class="fl">0.95</span>))),</span>
<span id="cb26-33"><a href="#cb26-33"></a>               <span class="dt">hjust =</span> <span class="dv">0</span>,</span>
<span id="cb26-34"><a href="#cb26-34"></a>               <span class="dt">vjust =</span> <span class="dv">0</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb26-35"><a href="#cb26-35"></a><span class="st">      </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span>(<span class="st">"segment"</span>, </span>
<span id="cb26-36"><a href="#cb26-36"></a>               <span class="dt">arrow =</span> <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/reexports.html">arrow</a></span>(<span class="dt">type =</span> <span class="st">"closed"</span>, <span class="dt">length =</span> <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/reexports.html">unit</a></span>(<span class="dv">11</span>, <span class="st">"pt"</span>), <span class="dt">angle =</span> <span class="dv">20</span>),</span>
<span id="cb26-37"><a href="#cb26-37"></a>               <span class="dt">x =</span> <span class="kw">tx_inc_q</span>(<span class="fl">0.925</span>), </span>
<span id="cb26-38"><a href="#cb26-38"></a>               <span class="dt">y =</span> <span class="fl">1.9</span> <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(.<span class="op">$</span>y[.<span class="op">$</span>x <span class="op">&gt;</span><span class="st"> </span><span class="kw">tx_inc_q</span>(<span class="fl">0.925</span>)]),</span>
<span id="cb26-39"><a href="#cb26-39"></a>               <span class="dt">size =</span> <span class="dv">1</span>,</span>
<span id="cb26-40"><a href="#cb26-40"></a>               <span class="dt">xend =</span> <span class="kw">tx_inc_q</span>(<span class="fl">0.95</span>),</span>
<span id="cb26-41"><a href="#cb26-41"></a>               <span class="dt">yend =</span> <span class="fl">1.9</span> <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(.<span class="op">$</span>y[.<span class="op">$</span>x <span class="op">&gt;</span><span class="st"> </span><span class="kw">tx_inc_q</span>(<span class="fl">0.925</span>)])) </span>
<span id="cb26-42"><a href="#cb26-42"></a>  }</span></code></pre></div>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a>n_CGs &lt;-<span class="st"> </span></span>
<span id="cb27-2"><a href="#cb27-2"></a><span class="st">  </span>sample_file <span class="op">%&gt;%</span></span>
<span id="cb27-3"><a href="#cb27-3"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(Tot_CY_CG_amt <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%$%</span></span>
<span id="cb27-4"><a href="#cb27-4"></a><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(WEIGHT)</span>
<span id="cb27-5"><a href="#cb27-5"></a></span>
<span id="cb27-6"><a href="#cb27-6"></a>n_CGs_prev &lt;-<span class="st"> </span></span>
<span id="cb27-7"><a href="#cb27-7"></a><span class="st">  </span>sample_file_prev <span class="op">%&gt;%</span></span>
<span id="cb27-8"><a href="#cb27-8"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(Tot_CY_CG_amt <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%$%</span></span>
<span id="cb27-9"><a href="#cb27-9"></a><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(WEIGHT)</span>
<span id="cb27-10"><a href="#cb27-10"></a></span>
<span id="cb27-11"><a href="#cb27-11"></a>tot_CG_amt &lt;-<span class="st"> </span></span>
<span id="cb27-12"><a href="#cb27-12"></a><span class="st">  </span>sample_file <span class="op">%$%</span></span>
<span id="cb27-13"><a href="#cb27-13"></a><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(Tot_CY_CG_amt <span class="op">*</span><span class="st"> </span>WEIGHT))</span>
<span id="cb27-14"><a href="#cb27-14"></a></span>
<span id="cb27-15"><a href="#cb27-15"></a>tot_Net_CG_amt &lt;-<span class="st"> </span></span>
<span id="cb27-16"><a href="#cb27-16"></a><span class="st">  </span>sample_file <span class="op">%$%</span></span>
<span id="cb27-17"><a href="#cb27-17"></a><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(Net_CG_amt <span class="op">*</span><span class="st"> </span>WEIGHT))</span>
<span id="cb27-18"><a href="#cb27-18"></a></span>
<span id="cb27-19"><a href="#cb27-19"></a>tax_on_CG &lt;-<span class="st"> </span></span>
<span id="cb27-20"><a href="#cb27-20"></a><span class="st">  </span>sample_file <span class="op">%&gt;%</span></span>
<span id="cb27-21"><a href="#cb27-21"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(Net_CG_amt <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span></span>
<span id="cb27-22"><a href="#cb27-22"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">tax =</span> <span class="kw"><a href="../reference/income_tax.html">income_tax</a></span>(Taxable_Income, <span class="dt">fy.year =</span> FY.YEAR), </span>
<span id="cb27-23"><a href="#cb27-23"></a>         <span class="dt">tax_wo_CG =</span> <span class="kw"><a href="../reference/income_tax.html">income_tax</a></span>(<span class="kw"><a href="../reference/pmaxC.html">pmaxC</a></span>(Taxable_Income <span class="op">-</span><span class="st"> </span>Net_CG_amt, <span class="dv">0</span>), <span class="dt">fy.year =</span> FY.YEAR)) <span class="op">%&gt;%</span></span>
<span id="cb27-24"><a href="#cb27-24"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span>(<span class="dt">total =</span> <span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>((tax <span class="op">-</span><span class="st"> </span>tax_wo_CG) <span class="op">*</span><span class="st"> </span>WEIGHT),</span>
<span id="cb27-25"><a href="#cb27-25"></a>            <span class="dt">avg =</span> <span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(tax <span class="op">-</span><span class="st"> </span>tax_wo_CG))</span>
<span id="cb27-26"><a href="#cb27-26"></a></span>
<span id="cb27-27"><a href="#cb27-27"></a>tax_on_CG_prev &lt;-<span class="st"> </span></span>
<span id="cb27-28"><a href="#cb27-28"></a><span class="st">  </span>sample_file_prev <span class="op">%&gt;%</span></span>
<span id="cb27-29"><a href="#cb27-29"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(Net_CG_amt <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span></span>
<span id="cb27-30"><a href="#cb27-30"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">tax =</span> <span class="kw"><a href="../reference/income_tax.html">income_tax</a></span>(Taxable_Income, <span class="dt">fy.year =</span> FY.YEAR), </span>
<span id="cb27-31"><a href="#cb27-31"></a>         <span class="dt">tax_wo_CG =</span> <span class="kw"><a href="../reference/income_tax.html">income_tax</a></span>(<span class="kw"><a href="../reference/pmaxC.html">pmaxC</a></span>(Taxable_Income <span class="op">-</span><span class="st"> </span>Net_CG_amt, <span class="dv">0</span>), <span class="dt">fy.year =</span> FY.YEAR)) <span class="op">%&gt;%</span></span>
<span id="cb27-32"><a href="#cb27-32"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span>(<span class="dt">total =</span> <span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>((tax <span class="op">-</span><span class="st"> </span>tax_wo_CG) <span class="op">*</span><span class="st"> </span>WEIGHT),</span>
<span id="cb27-33"><a href="#cb27-33"></a>            <span class="dt">avg =</span> <span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(tax <span class="op">-</span><span class="st"> </span>tax_wo_CG))</span>
<span id="cb27-34"><a href="#cb27-34"></a>  </span></code></pre></div>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a>latex_percent &lt;-<span class="st"> </span><span class="cf">function</span>(x) <span class="kw"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span>(<span class="st">"%"</span>, <span class="st">"</span><span class="ch">\\</span><span class="st">%"</span>, <span class="kw"><a href="https://scales.r-lib.org//reference/number_format.html">percent</a></span>(x), <span class="dt">fixed =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<p>The capital gains discount applies to assets sold after more than 12 months’ holding. There were res individuals who sold capital assets, up res from last year. The sale of their assets totalled res of which res comprised part of their taxable income.</p>
<p>The tax on these capital gains totalled res or res per individual with capital gains tax.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a>sample_file &lt;-<span class="st"> </span><span class="kw"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span>(sample_file)</span>
<span id="cb29-2"><a href="#cb29-2"></a>probCG_by_age &lt;-<span class="st"> </span></span>
<span id="cb29-3"><a href="#cb29-3"></a><span class="st">  </span>sample_file[, .(<span class="dt">probCG =</span> <span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(Net_CG_amt <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>)),</span>
<span id="cb29-4"><a href="#cb29-4"></a>              keyby =<span class="st"> "age_range_description"</span>]</span>
<span id="cb29-5"><a href="#cb29-5"></a></span>
<span id="cb29-6"><a href="#cb29-6"></a>probCG_twenties &lt;-<span class="st"> </span></span>
<span id="cb29-7"><a href="#cb29-7"></a><span class="st">  </span>sample_file[age_imp <span class="op">&lt;</span><span class="st"> </span><span class="dv">30</span>, <span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(Net_CG_amt <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>)]</span>
<span id="cb29-8"><a href="#cb29-8"></a></span>
<span id="cb29-9"><a href="#cb29-9"></a>probCG_65p &lt;-<span class="st"> </span></span>
<span id="cb29-10"><a href="#cb29-10"></a><span class="st">  </span>sample_file[age_imp <span class="op">&gt;=</span><span class="st"> </span><span class="dv">65</span>, <span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(Net_CG_amt <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>)]</span>
<span id="cb29-11"><a href="#cb29-11"></a></span>
<span id="cb29-12"><a href="#cb29-12"></a>avg_marginal_rate_CG &lt;-<span class="st"> </span></span>
<span id="cb29-13"><a href="#cb29-13"></a><span class="st">  </span>sample_file[Net_CG_amt <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, .(Taxable_Income)] <span class="op">%&gt;%</span></span>
<span id="cb29-14"><a href="#cb29-14"></a><span class="st">  </span>.[, <span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="kw"><a href="../reference/income_tax.html">income_tax</a></span>(Taxable_Income <span class="op">+</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">fy.year =</span> FY.YEAR) <span class="op">-</span><span class="st"> </span><span class="kw"><a href="../reference/income_tax.html">income_tax</a></span>(Taxable_Income, <span class="dt">fy.year =</span> FY.YEAR))]</span>
<span id="cb29-15"><a href="#cb29-15"></a></span>
<span id="cb29-16"><a href="#cb29-16"></a>avg_marginal_rate_CG_weighted_by_CG &lt;-<span class="st"> </span></span>
<span id="cb29-17"><a href="#cb29-17"></a><span class="st">  </span>sample_file[Net_CG_amt <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, .(Net_CG_amt, Taxable_Income)] <span class="op">%&gt;%</span></span>
<span id="cb29-18"><a href="#cb29-18"></a><span class="st">  </span>.[, marginal_rate <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="../reference/income_tax.html">income_tax</a></span>(Taxable_Income <span class="op">+</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">fy.year =</span> FY.YEAR) <span class="op">-</span><span class="st"> </span><span class="kw"><a href="../reference/income_tax.html">income_tax</a></span>(Taxable_Income, <span class="dt">fy.year =</span> FY.YEAR)] <span class="op">%&gt;%</span></span>
<span id="cb29-19"><a href="#cb29-19"></a><span class="st">  </span>.[, <span class="kw"><a href="https://rdrr.io/r/stats/weighted.mean.html">weighted.mean</a></span>(marginal_rate, Net_CG_amt)]</span>
<span id="cb29-20"><a href="#cb29-20"></a></span>
<span id="cb29-21"><a href="#cb29-21"></a>avg_marginal_rate_b4_CG &lt;-<span class="st"> </span></span>
<span id="cb29-22"><a href="#cb29-22"></a><span class="st">  </span>sample_file[Net_CG_amt <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span>age_imp <span class="op">&gt;=</span><span class="st"> </span><span class="dv">20</span>] <span class="op">%&gt;%</span></span>
<span id="cb29-23"><a href="#cb29-23"></a><span class="st">  </span>.[, Taxable_Income_b4_CG <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="../reference/pmaxC.html">pmaxC</a></span>(Taxable_Income <span class="op">-</span><span class="st"> </span>Net_CG_amt, <span class="dv">0</span>)] <span class="op">%&gt;%</span></span>
<span id="cb29-24"><a href="#cb29-24"></a><span class="st">  </span>.[, marginal_rate_b4_CG <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="../reference/income_tax.html">income_tax</a></span>(Taxable_Income_b4_CG <span class="op">+</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">fy.year =</span> FY.YEAR) <span class="op">-</span><span class="st"> </span><span class="kw"><a href="../reference/income_tax.html">income_tax</a></span>(Taxable_Income_b4_CG, <span class="dt">fy.year =</span> FY.YEAR)] <span class="op">%&gt;%</span></span>
<span id="cb29-25"><a href="#cb29-25"></a><span class="st">  </span>.[, is_in_workforce <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/between.html">between</a></span>(age_imp, <span class="dv">20</span>, <span class="dv">65</span>)] <span class="op">%&gt;%</span></span>
<span id="cb29-26"><a href="#cb29-26"></a><span class="st">  </span>.[, .(<span class="dt">avg_marginal_rate_weighted =</span> <span class="kw"><a href="https://rdrr.io/r/stats/weighted.mean.html">weighted.mean</a></span>(marginal_rate_b4_CG, Net_CG_amt), </span>
<span id="cb29-27"><a href="#cb29-27"></a>        <span class="dt">avg_marginal_Rate =</span> <span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(marginal_rate_b4_CG)),</span>
<span id="cb29-28"><a href="#cb29-28"></a>    keyby =<span class="st"> "is_in_workforce"</span>]</span>
<span id="cb29-29"><a href="#cb29-29"></a></span>
<span id="cb29-30"><a href="#cb29-30"></a>.prob_no_CGT_discounts &lt;-<span class="st"> </span></span>
<span id="cb29-31"><a href="#cb29-31"></a><span class="st">  </span>sample_file[Tot_CY_CG_amt <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, .(Net_CG_amt, Tot_CY_CG_amt)] <span class="op">%&gt;%</span></span>
<span id="cb29-32"><a href="#cb29-32"></a><span class="st">  </span>.[, apparent_discount <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">1</span> <span class="op">-</span><span class="st"> </span>Net_CG_amt <span class="op">/</span><span class="st"> </span>Tot_CY_CG_amt] <span class="op">%&gt;%</span></span>
<span id="cb29-33"><a href="#cb29-33"></a><span class="st">  </span>.[, apparent_discount0 <span class="op">:</span><span class="er">=</span><span class="st"> </span>apparent_discount <span class="op">==</span><span class="st"> </span><span class="dv">0</span>] <span class="op">%&gt;%</span></span>
<span id="cb29-34"><a href="#cb29-34"></a><span class="st">  </span>.[, apparent_discount1 <span class="op">:</span><span class="er">=</span><span class="st"> </span>apparent_discount <span class="op">==</span><span class="st"> </span><span class="dv">1</span>] <span class="op">%&gt;%</span></span>
<span id="cb29-35"><a href="#cb29-35"></a><span class="st">  </span>.[, apparent_discount50 <span class="op">:</span><span class="er">=</span><span class="st"> </span>apparent_discount <span class="op">%between%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.45</span>, <span class="fl">0.55</span>)] <span class="op">%&gt;%</span></span>
<span id="cb29-36"><a href="#cb29-36"></a><span class="st">  </span>.[, <span class="kw"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(.SD, mean),</span>
<span id="cb29-37"><a href="#cb29-37"></a>    .SDcols =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"apparent_discount0"</span>,</span>
<span id="cb29-38"><a href="#cb29-38"></a>                <span class="st">"apparent_discount50"</span>,</span>
<span id="cb29-39"><a href="#cb29-39"></a>                <span class="st">"apparent_discount1"</span>)]</span>
<span id="cb29-40"><a href="#cb29-40"></a></span>
<span id="cb29-41"><a href="#cb29-41"></a>prop_no_CGT_discount &lt;-<span class="st"> </span>.prob_no_CGT_discounts[[<span class="st">"apparent_discount0"</span>]]</span>
<span id="cb29-42"><a href="#cb29-42"></a></span>
<span id="cb29-43"><a href="#cb29-43"></a>prop_100pc_CGT_discount &lt;-<span class="st"> </span>.prob_no_CGT_discounts[[<span class="st">"apparent_discount1"</span>]]</span>
<span id="cb29-44"><a href="#cb29-44"></a></span>
<span id="cb29-45"><a href="#cb29-45"></a>prop_50pc_CGT_discount &lt;-<span class="st"> </span>.prob_no_CGT_discounts[[<span class="st">"apparent_discount50"</span>]]</span>
<span id="cb29-46"><a href="#cb29-46"></a></span>
<span id="cb29-47"><a href="#cb29-47"></a>prop_no_CGT_discount_by_val &lt;-<span class="st"> </span></span>
<span id="cb29-48"><a href="#cb29-48"></a><span class="st">  </span>sample_file[Tot_CY_CG_amt <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, .(Net_CG_amt, Tot_CY_CG_amt)] <span class="op">%&gt;%</span></span>
<span id="cb29-49"><a href="#cb29-49"></a><span class="st">  </span>.[, apparent_discount <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">1</span> <span class="op">-</span><span class="st"> </span>Net_CG_amt <span class="op">/</span><span class="st"> </span>Tot_CY_CG_amt] <span class="op">%$%</span></span>
<span id="cb29-50"><a href="#cb29-50"></a><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/stats/weighted.mean.html">weighted.mean</a></span>(apparent_discount <span class="op">==</span><span class="st"> </span><span class="dv">0</span>, Tot_CY_CG_amt)</span>
<span id="cb29-51"><a href="#cb29-51"></a></span>
<span id="cb29-52"><a href="#cb29-52"></a>cgt_ratio_res &lt;-<span class="st"> </span><span class="dv">50</span></span></code></pre></div>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a>sample_file <span class="op">%&gt;%</span></span>
<span id="cb30-2"><a href="#cb30-2"></a><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/hutils/man/selector.html">selector</a></span>(Tot_CY_CG_amt, Net_CG_amt, WEIGHT) <span class="op">%&gt;%</span></span>
<span id="cb30-3"><a href="#cb30-3"></a><span class="st">  </span>.[Tot_CY_CG_amt <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>] <span class="op">%&gt;%</span></span>
<span id="cb30-4"><a href="#cb30-4"></a><span class="st">  </span>.[, apparent_discount <span class="op">:</span><span class="er">=</span><span class="st"> </span>Net_CG_amt <span class="op">/</span><span class="st"> </span>Tot_CY_CG_amt] <span class="op">%&gt;%</span></span>
<span id="cb30-5"><a href="#cb30-5"></a><span class="st">  </span>.[, apparent_discount_round <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(apparent_discount <span class="op">*</span><span class="st"> </span>cgt_ratio_res) <span class="op">/</span><span class="st"> </span>cgt_ratio_res] <span class="op">%&gt;%</span></span>
<span id="cb30-6"><a href="#cb30-6"></a><span class="st">  </span>.[, keyby =<span class="st"> </span>.(apparent_discount_round), </span>
<span id="cb30-7"><a href="#cb30-7"></a>    .(<span class="dt">n_taxpayers =</span> <span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(WEIGHT), </span>
<span id="cb30-8"><a href="#cb30-8"></a>      <span class="dt">n_taxpayers_by_val =</span> <span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/double.html">as.double</a></span>(WEIGHT <span class="op">*</span><span class="st"> </span>Tot_CY_CG_amt)))] <span class="op">%&gt;%</span></span>
<span id="cb30-9"><a href="#cb30-9"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> apparent_discount_round, <span class="dt">y =</span> n_taxpayers_by_val)) <span class="op">+</span></span>
<span id="cb30-10"><a href="#cb30-10"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">"Ratio of Net capital gains to Total capital gains"</span>) <span class="op">+</span></span>
<span id="cb30-11"><a href="#cb30-11"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="dt">stat =</span> <span class="st">"identity"</span>, <span class="dt">width =</span> <span class="dv">1</span><span class="op">/</span>cgt_ratio_res) <span class="op">+</span><span class="st"> </span></span>
<span id="cb30-12"><a href="#cb30-12"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="dt">axis.title.y =</span> <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span>(),</span>
<span id="cb30-13"><a href="#cb30-13"></a>        <span class="dt">axis.ticks.y =</span> <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span>(),</span>
<span id="cb30-14"><a href="#cb30-14"></a>        <span class="dt">axis.text.y =</span> <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span>())</span></code></pre></div>
<p>Taxable capital gains are typically realized later in life. This is unsurprising: a capital gain can only be realized when one has an asset to sell. Further, the capital gains tax makes the sale of assets less attractive when incomes are high. Taxpayers in their twenties have a res chance of incurring capital gains tax, whereas res of those of retirement age have capital gains.  shows that although capital gains have been more common with older taxpayers, the age skew is slightly more pronounced in res than in previous years.</p>
<p>The average marginal tax rate of those with capital gains tax was res; however, this weights an individual with a capital gain of $1 equally as someone with a capital gain of $500,000. Weighting by the value of capital gain, the average marginal tax rate was res.</p>
<p>The net capital gains includes the CGT discount (and other discounts) applied to: <span class="math display">\[\text{Total capital gains} - \text{Total capital losses (incl. from prev. years)}\]</span> Comparing the ratio  of  can shed some light on the value of the discount and the impact of capital losses on tax and tax revenue. Of those with nonzero total capital gains, res had no discount and res paid no tax (or a 100% discount). Some res had net capital gains of around 50% of their total gains. Weighting these numbers by the value of total capital gains, res of capital gains are taxed at the full marginal rate.  shows the distribution of this ratio. The deviance from 50% is due to some gains being realized within 12 months and (more commonly) capital losses.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a>CG_descriptive_by_bracket &lt;-<span class="st"> </span></span>
<span id="cb31-2"><a href="#cb31-2"></a>sample_file <span class="op">%&gt;%</span></span>
<span id="cb31-3"><a href="#cb31-3"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">tax =</span> <span class="kw"><a href="../reference/income_tax.html">income_tax</a></span>(Taxable_Income, <span class="dt">fy.year =</span> FY.YEAR), </span>
<span id="cb31-4"><a href="#cb31-4"></a>         <span class="dt">tax_wo_CG =</span> <span class="kw"><a href="../reference/income_tax.html">income_tax</a></span>(<span class="kw"><a href="../reference/pmaxC.html">pmaxC</a></span>(Taxable_Income <span class="op">-</span><span class="st"> </span>Net_CG_amt, <span class="dv">0</span>), <span class="dt">fy.year =</span> FY.YEAR)) <span class="op">%&gt;%</span></span>
<span id="cb31-5"><a href="#cb31-5"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(Tax_Bracket) <span class="op">%&gt;%</span></span>
<span id="cb31-6"><a href="#cb31-6"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span>(<span class="dt">n_taxpayers =</span> <span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(WEIGHT),</span>
<span id="cb31-7"><a href="#cb31-7"></a>            <span class="dt">n_CG =</span> <span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(WEIGHT[Net_CG_amt <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>]),</span>
<span id="cb31-8"><a href="#cb31-8"></a>            <span class="dt">val_CG =</span> <span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/double.html">as.double</a></span>(Tot_CY_CG_amt <span class="op">*</span><span class="st"> </span>WEIGHT)), </span>
<span id="cb31-9"><a href="#cb31-9"></a>            <span class="dt">total_CGT =</span> <span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/double.html">as.double</a></span>((tax <span class="op">-</span><span class="st"> </span>tax_wo_CG) <span class="op">*</span><span class="st"> </span>WEIGHT))) <span class="op">%&gt;%</span></span>
<span id="cb31-10"><a href="#cb31-10"></a><span class="st">  </span>ungroup <span class="op">%&gt;%</span></span>
<span id="cb31-11"><a href="#cb31-11"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(Tax_Bracket) </span></code></pre></div>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1"></a>CG_descriptive_by_bracket <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb32-2"><a href="#cb32-2"></a><span class="st">  </span><span class="co"># cosmetic</span></span>
<span id="cb32-3"><a href="#cb32-3"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">Taxpayers =</span> <span class="kw"><a href="https://scales.r-lib.org//reference/number_format.html">comma</a></span>(n_taxpayers),</span>
<span id="cb32-4"><a href="#cb32-4"></a>         <span class="st">`</span><span class="dt">with CG</span><span class="st">`</span> =<span class="st"> </span><span class="kw"><a href="https://scales.r-lib.org//reference/number_format.html">comma</a></span>(n_CG),</span>
<span id="cb32-5"><a href="#cb32-5"></a>         <span class="st">`</span><span class="dt">Total cap. gains ($)</span><span class="st">`</span> =<span class="st"> </span><span class="kw">grattan_dollar</span>(val_CG),</span>
<span id="cb32-6"><a href="#cb32-6"></a>         <span class="st">`</span><span class="dt">Total CGT ($)</span><span class="st">`</span> =<span class="st"> </span><span class="kw">grattan_dollar</span>(total_CGT)) <span class="op">%&gt;%</span></span>
<span id="cb32-7"><a href="#cb32-7"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="st">`</span><span class="dt">Tax bracket</span><span class="st">`</span> =<span class="st"> </span>Tax_Bracket,</span>
<span id="cb32-8"><a href="#cb32-8"></a>         <span class="st">`</span><span class="dt">Taxpayers</span><span class="st">`</span>, <span class="st">`</span><span class="dt">with CG</span><span class="st">`</span>, <span class="st">`</span><span class="dt">Total cap. gains ($)</span><span class="st">`</span>, <span class="st">`</span><span class="dt">Total CGT ($)</span><span class="st">`</span>) <span class="op">%&gt;%</span></span>
<span id="cb32-9"><a href="#cb32-9"></a><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>(<span class="dt">align =</span> <span class="st">"rrrrrr"</span>) </span></code></pre></div>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1"></a>sample_file <span class="op">%&gt;%</span></span>
<span id="cb33-2"><a href="#cb33-2"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> age_imp, <span class="dt">y =</span> <span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(Net_CG_amt <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>))) <span class="op">+</span><span class="st"> </span></span>
<span id="cb33-3"><a href="#cb33-3"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span>(<span class="dt">color =</span> <span class="kw"><a href="https://rdrr.io/pkg/viridis/man/reexports.html">viridis</a></span>(<span class="dv">1</span>), <span class="dt">size =</span> <span class="fl">1.2</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb33-4"><a href="#cb33-4"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(<span class="dt">label =</span> percent) </span></code></pre></div>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1"></a></span>
<span id="cb34-2"><a href="#cb34-2"></a><span class="co"># faster than ifelseing over the whole table</span></span>
<span id="cb34-3"><a href="#cb34-3"></a>desc2min_age &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</span>
<span id="cb34-4"><a href="#cb34-4"></a>  <span class="cf">if</span> (<span class="kw"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span>(<span class="st">"to"</span>, x)) { </span>
<span id="cb34-5"><a href="#cb34-5"></a>    <span class="kw"><a href="https://rdrr.io/r/base/grep.html">sub</a></span>(<span class="st">"^([0-9]{2}).*$"</span>, <span class="st">"</span><span class="ch">\\</span><span class="st">1"</span>, x) </span>
<span id="cb34-6"><a href="#cb34-6"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="kw"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span>(<span class="st">"70"</span>, x)) {</span>
<span id="cb34-7"><a href="#cb34-7"></a>    <span class="st">"70"</span> </span>
<span id="cb34-8"><a href="#cb34-8"></a>  } <span class="cf">else</span> {</span>
<span id="cb34-9"><a href="#cb34-9"></a>    <span class="st">"15"</span></span>
<span id="cb34-10"><a href="#cb34-10"></a>  }</span>
<span id="cb34-11"><a href="#cb34-11"></a>}</span>
<span id="cb34-12"><a href="#cb34-12"></a></span>
<span id="cb34-13"><a href="#cb34-13"></a>sample_files_all <span class="op">%&gt;%</span></span>
<span id="cb34-14"><a href="#cb34-14"></a><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/hutils/man/selector.html">selector</a></span>(age_range, Net_CG_amt, fy.year, <span class="dt">shallow =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span></span>
<span id="cb34-15"><a href="#cb34-15"></a><span class="st">  </span><span class="kw"><a href="https://Rdatatable.gitlab.io/data.table/reference/merge.html">merge</a></span>(age_range_decoder, <span class="dt">by =</span> <span class="st">"age_range"</span>) <span class="op">%&gt;%</span></span>
<span id="cb34-16"><a href="#cb34-16"></a><span class="st">  </span>.[, min_age <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">desc2min_age</span>(.BY[[1L]]),</span>
<span id="cb34-17"><a href="#cb34-17"></a>    keyby =<span class="st"> "age_range_description"</span>] <span class="op">%&gt;%</span></span>
<span id="cb34-18"><a href="#cb34-18"></a><span class="st">  </span>.[, min_age <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/double.html">as.double</a></span>(min_age)] <span class="op">%&gt;%</span></span>
<span id="cb34-19"><a href="#cb34-19"></a><span class="st">  </span>.[, max_age <span class="op">:</span><span class="er">=</span><span class="st"> </span>min_age <span class="op">+</span><span class="st"> </span><span class="dv">5</span>] <span class="op">%&gt;%</span></span>
<span id="cb34-20"><a href="#cb34-20"></a><span class="st">  </span>.[, age_imp <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep_len</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="dt">from =</span> .BY[[<span class="st">"min_age"</span>]],</span>
<span id="cb34-21"><a href="#cb34-21"></a>                             <span class="dt">to =</span> .BY[[<span class="st">"max_age"</span>]],</span>
<span id="cb34-22"><a href="#cb34-22"></a>                             <span class="co"># must be reasonably high to capture (infreq.)</span></span>
<span id="cb34-23"><a href="#cb34-23"></a>                             <span class="co"># capital gains events</span></span>
<span id="cb34-24"><a href="#cb34-24"></a>                             <span class="dt">length.out =</span> <span class="dv">2000</span>),</span>
<span id="cb34-25"><a href="#cb34-25"></a>                         .N),</span>
<span id="cb34-26"><a href="#cb34-26"></a>    keyby =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"min_age"</span>, <span class="st">"max_age"</span>)] <span class="op">%&gt;%</span></span>
<span id="cb34-27"><a href="#cb34-27"></a><span class="st">  </span><span class="kw"><a href="https://Rdatatable.gitlab.io/data.table/reference/duplicated.html">unique</a></span>(<span class="dt">by =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"fy.year"</span>, <span class="st">"age_imp"</span>)) <span class="op">%&gt;%</span></span>
<span id="cb34-28"><a href="#cb34-28"></a><span class="st">  </span>.[, last_fy <span class="op">:</span><span class="er">=</span><span class="st"> </span>fy.year <span class="op">==</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(fy.year)] <span class="op">%&gt;%</span></span>
<span id="cb34-29"><a href="#cb34-29"></a><span class="st">  </span>.[, Tax_year <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(fy.year)] <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb34-30"><a href="#cb34-30"></a><span class="st">  </span>.[, is_CG <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/double.html">as.double</a></span>(Net_CG_amt <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>)] <span class="op">%&gt;%</span></span>
<span id="cb34-31"><a href="#cb34-31"></a><span class="st">  </span>.[, y <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/fitted.values.html">fitted</a></span>(<span class="kw"><a href="https://rdrr.io/pkg/mgcv/man/gam.html">gam</a></span>(is_CG <span class="op">~</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/mgcv/man/s.html">s</a></span>(age_imp, <span class="dt">bs =</span> <span class="st">"cs"</span>), <span class="dt">data =</span> .SD)), keyby =<span class="st"> "Tax_year"</span>] <span class="op">%&gt;%</span></span>
<span id="cb34-32"><a href="#cb34-32"></a><span class="st">  </span>.[, Age <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(age_imp, <span class="dv">1</span>)] <span class="op">%&gt;%</span></span>
<span id="cb34-33"><a href="#cb34-33"></a><span class="st">  </span>.[, .(<span class="dt">y =</span> <span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(y)), keyby =<span class="st"> </span>.(Tax_year, Age)] <span class="op">%&gt;%</span></span>
<span id="cb34-34"><a href="#cb34-34"></a><span class="st">  </span>.[, label <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span>(Age <span class="op">==</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(Age), Tax_year, <span class="ot">NA_character_</span>), keyby =<span class="st"> "Tax_year"</span>] <span class="op">%&gt;%</span></span>
<span id="cb34-35"><a href="#cb34-35"></a><span class="st">  </span>.[] <span class="op">%&gt;%</span></span>
<span id="cb34-36"><a href="#cb34-36"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> Age, </span>
<span id="cb34-37"><a href="#cb34-37"></a>             <span class="dt">y =</span> y, </span>
<span id="cb34-38"><a href="#cb34-38"></a>             <span class="dt">color =</span> Tax_year, </span>
<span id="cb34-39"><a href="#cb34-39"></a>             <span class="dt">group =</span> Tax_year)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb34-40"><a href="#cb34-40"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(<span class="dt">label =</span> percent) <span class="op">+</span><span class="st"> </span></span>
<span id="cb34-41"><a href="#cb34-41"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"Incidence of capital gains"</span>) <span class="op">+</span></span>
<span id="cb34-42"><a href="#cb34-42"></a><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/viridis/man/scale_viridis.html">scale_color_viridis</a></span>(<span class="st">"Tax year"</span>, <span class="dt">discrete =</span> <span class="ot">TRUE</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb34-43"><a href="#cb34-43"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="dt">size =</span> <span class="fl">1.2</span>) <span class="op">+</span></span>
<span id="cb34-44"><a href="#cb34-44"></a><span class="st">  </span><span class="co"># geom_line(stat = "smooth", method = "auto", se = FALSE, size = 1.2) +</span></span>
<span id="cb34-45"><a href="#cb34-45"></a><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/ggrepel/man/geom_text_repel.html">geom_label_repel</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">label =</span> label),</span>
<span id="cb34-46"><a href="#cb34-46"></a>                   <span class="dt">fill =</span> <span class="ot">NA</span>,</span>
<span id="cb34-47"><a href="#cb34-47"></a>                   <span class="dt">nudge_x =</span> <span class="dv">1</span>,</span>
<span id="cb34-48"><a href="#cb34-48"></a>                   <span class="dt">xlim =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">75</span>, <span class="ot">NA</span>),</span>
<span id="cb34-49"><a href="#cb34-49"></a>                   <span class="dt">hjust =</span> <span class="dv">0</span>, </span>
<span id="cb34-50"><a href="#cb34-50"></a>                   <span class="dt">vjust =</span> <span class="dv">0</span>, </span>
<span id="cb34-51"><a href="#cb34-51"></a>                   <span class="dt">fontface =</span> <span class="st">"bold"</span>, </span>
<span id="cb34-52"><a href="#cb34-52"></a>                   <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb34-53"><a href="#cb34-53"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_blank.html">geom_blank</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> <span class="dv">80</span>, <span class="dt">y =</span> <span class="dv">0</span>)) <span class="op">+</span></span>
<span id="cb34-54"><a href="#cb34-54"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_dark</a></span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb34-55"><a href="#cb34-55"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="dt">axis.title.y =</span> <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span>())</span></code></pre></div>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1"></a><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">24841</span>)</span>
<span id="cb35-2"><a href="#cb35-2"></a>sample_files_all <span class="op">%&gt;%</span></span>
<span id="cb35-3"><a href="#cb35-3"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(age_range, Net_CG_amt, fy.year) <span class="op">%&gt;%</span></span>
<span id="cb35-4"><a href="#cb35-4"></a><span class="st">  </span><span class="kw"><a href="https://Rdatatable.gitlab.io/data.table/reference/merge.html">merge</a></span>(age_range_decoder, <span class="dt">by =</span> <span class="st">"age_range"</span>) <span class="op">%&gt;%</span></span>
<span id="cb35-5"><a href="#cb35-5"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(age_range_description) <span class="op">%&gt;%</span></span>
<span id="cb35-6"><a href="#cb35-6"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">min_age =</span> <span class="kw"><a href="https://Rdatatable.gitlab.io/data.table/reference/fifelse.html">ifelse</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span>(<span class="st">"to"</span>, age_range_description), </span>
<span id="cb35-7"><a href="#cb35-7"></a>                          <span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span>(<span class="st">"^([0-9]{2}).*$"</span>, <span class="st">"</span><span class="ch">\\</span><span class="st">1"</span>, age_range_description)), </span>
<span id="cb35-8"><a href="#cb35-8"></a>                          <span class="kw"><a href="https://Rdatatable.gitlab.io/data.table/reference/fifelse.html">ifelse</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span>(<span class="st">"70"</span>, age_range_description),</span>
<span id="cb35-9"><a href="#cb35-9"></a>                                 <span class="dv">70</span>, </span>
<span id="cb35-10"><a href="#cb35-10"></a>                                 <span class="dv">15</span>)),</span>
<span id="cb35-11"><a href="#cb35-11"></a>         <span class="dt">max_age =</span> min_age <span class="op">+</span><span class="st"> </span><span class="dv">5</span>, </span>
<span id="cb35-12"><a href="#cb35-12"></a>         <span class="dt">age_imp =</span> <span class="kw"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw"><a href="https://dplyr.tidyverse.org/reference/n.html">n</a></span>(), min_age, max_age)) <span class="op">%&gt;%</span></span>
<span id="cb35-13"><a href="#cb35-13"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="op">-</span>min_age, <span class="op">-</span>max_age) <span class="op">%&gt;%</span></span>
<span id="cb35-14"><a href="#cb35-14"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(Net_CG_amt <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span></span>
<span id="cb35-15"><a href="#cb35-15"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">Age =</span> <span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(age_imp)) <span class="op">%&gt;%</span></span>
<span id="cb35-16"><a href="#cb35-16"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(fy.year, Age) <span class="op">%&gt;%</span></span>
<span id="cb35-17"><a href="#cb35-17"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span>(<span class="dt">mean_Net_CG =</span> <span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(Net_CG_amt), </span>
<span id="cb35-18"><a href="#cb35-18"></a>            <span class="dt">sd_Net_CG =</span> <span class="kw"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span>(Net_CG_amt)) <span class="op">%&gt;%</span></span>
<span id="cb35-19"><a href="#cb35-19"></a><span class="st">  </span>ungroup <span class="op">%&gt;%</span></span>
<span id="cb35-20"><a href="#cb35-20"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">last_fy =</span> fy.year <span class="op">==</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(fy.year) <span class="op">|</span><span class="st"> </span>fy.year <span class="op">==</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(fy.year[fy.year <span class="op">!=</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(fy.year)])) <span class="op">%&gt;%</span></span>
<span id="cb35-21"><a href="#cb35-21"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(fy.year) <span class="op">%&gt;%</span></span>
<span id="cb35-22"><a href="#cb35-22"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">label =</span> <span class="kw"><a href="https://Rdatatable.gitlab.io/data.table/reference/fifelse.html">ifelse</a></span>(Age <span class="op">==</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(Age), fy.year, <span class="ot">NA_character_</span>), </span>
<span id="cb35-23"><a href="#cb35-23"></a>         <span class="dt">label.y =</span> <span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(mean_Net_CG[Age <span class="op">&gt;</span><span class="st"> </span><span class="dv">70</span>])) <span class="op">%&gt;%</span></span>
<span id="cb35-24"><a href="#cb35-24"></a><span class="st">         </span>{</span>
<span id="cb35-25"><a href="#cb35-25"></a>           <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(., <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> Age, <span class="dt">y =</span> mean_Net_CG, <span class="dt">color =</span> <span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(fy.year), <span class="dt">group =</span> <span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(fy.year))) <span class="op">+</span><span class="st"> </span></span>
<span id="cb35-26"><a href="#cb35-26"></a><span class="st">             </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(<span class="dt">label =</span> dollar) <span class="op">+</span><span class="st"> </span></span>
<span id="cb35-27"><a href="#cb35-27"></a><span class="st">             </span><span class="kw"><a href="https://rdrr.io/pkg/viridis/man/scale_viridis.html">scale_color_viridis</a></span>(<span class="dt">discrete =</span> <span class="ot">TRUE</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb35-28"><a href="#cb35-28"></a><span class="st">             </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="dt">stat =</span> <span class="st">"smooth"</span>, <span class="dt">method =</span> <span class="st">"auto"</span>, <span class="dt">se =</span> <span class="ot">FALSE</span>, <span class="dt">size =</span> <span class="fl">1.2</span>) <span class="op">+</span></span>
<span id="cb35-29"><a href="#cb35-29"></a><span class="st">             </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_alpha.html">scale_alpha_discrete</a></span>(<span class="dt">range =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.5</span>, <span class="dv">1</span>)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb35-30"><a href="#cb35-30"></a><span class="st">             </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_text</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">label =</span> label, <span class="dt">y =</span> label.y, <span class="dt">size =</span> <span class="kw"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span>(last_fy <span class="op">%in%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"2012-13"</span>, <span class="st">"2013-14"</span>), <span class="dv">2</span>, <span class="dv">1</span>),</span>
<span id="cb35-31"><a href="#cb35-31"></a>                                                                      <span class="dt">nudge_x =</span> <span class="kw"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span>(last_fy, <span class="dv">1</span>, <span class="dv">0</span>)),</span>
<span id="cb35-32"><a href="#cb35-32"></a>                       <span class="dt">hjust =</span> <span class="dv">0</span>, </span>
<span id="cb35-33"><a href="#cb35-33"></a>                       <span class="dt">vjust =</span> <span class="dv">0</span>, </span>
<span id="cb35-34"><a href="#cb35-34"></a>                       <span class="dt">fontface =</span> <span class="st">"bold"</span>, </span>
<span id="cb35-35"><a href="#cb35-35"></a>                       <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb35-36"><a href="#cb35-36"></a><span class="st">             </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span>(<span class="dt">expand =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>,<span class="dv">0</span>)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb35-37"><a href="#cb35-37"></a><span class="st">             </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_dark</a></span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb35-38"><a href="#cb35-38"></a><span class="st">             </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span>(<span class="st">"blank"</span>, </span>
<span id="cb35-39"><a href="#cb35-39"></a>                      <span class="dt">x =</span> <span class="dv">85</span>, <span class="dt">y =</span> <span class="dv">0</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb35-40"><a href="#cb35-40"></a><span class="st">             </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="dt">axis.title.y =</span> <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span>(), </span>
<span id="cb35-41"><a href="#cb35-41"></a>                   <span class="dt">plot.margin =</span> <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/reexports.html">unit</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">5</span>,<span class="dv">0</span>), <span class="st">"pt"</span>))</span>
<span id="cb35-42"><a href="#cb35-42"></a>         }</span></code></pre></div>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1"></a>sample_file <span class="op">%&gt;%</span></span>
<span id="cb36-2"><a href="#cb36-2"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">Tot_inc_amt_noCG =</span> Tot_inc_amt <span class="op">-</span><span class="st"> </span>Net_CG_amt, </span>
<span id="cb36-3"><a href="#cb36-3"></a>         <span class="dt">Taxable_Income_noCG =</span> <span class="kw"><a href="../reference/pmaxC.html">pmaxC</a></span>(Tot_inc_amt_noCG <span class="op">-</span><span class="st"> </span>Tot_ded_amt <span class="op">-</span><span class="st"> </span>NPP_loss_claimed <span class="op">-</span><span class="st"> </span>PP_loss_claimed, <span class="dv">0</span>)) <span class="op">%&gt;%</span></span>
<span id="cb36-4"><a href="#cb36-4"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">Taxable_Income_noCG_decile =</span> <span class="kw"><a href="https://dplyr.tidyverse.org/reference/ranking.html">ntile</a></span>(Taxable_Income_noCG, <span class="dv">10</span>)) <span class="op">%&gt;%</span></span>
<span id="cb36-5"><a href="#cb36-5"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(Taxable_Income_noCG_decile <span class="op">%in%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span>, <span class="dv">5</span>, <span class="dv">10</span>)) <span class="op">%&gt;%</span></span>
<span id="cb36-6"><a href="#cb36-6"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(Net_CG_amt <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span></span>
<span id="cb36-7"><a href="#cb36-7"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">rename</a></span>(<span class="dt">Age =</span> age_imp) <span class="op">%&gt;%</span></span>
<span id="cb36-8"><a href="#cb36-8"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="st">`</span><span class="dt">Taxable Income</span><span class="ch">\n</span><span class="dt">(excl CG) decile</span><span class="st">`</span> =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(Taxable_Income_noCG_decile)) <span class="op">%&gt;%</span></span>
<span id="cb36-9"><a href="#cb36-9"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> Age, <span class="dt">fill =</span> <span class="st">`</span><span class="dt">Taxable Income</span><span class="ch">\n</span><span class="dt">(excl CG) decile</span><span class="st">`</span>)) <span class="op">+</span></span>
<span id="cb36-10"><a href="#cb36-10"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html">geom_density</a></span>(<span class="dt">alpha =</span> <span class="fl">0.7</span>) <span class="op">+</span></span>
<span id="cb36-11"><a href="#cb36-11"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="dt">legend.position =</span> <span class="st">"right"</span>)</span></code></pre></div>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a><span class="cf">if</span> (FY.YEAR <span class="op">!=</span><span class="st"> "2013-14"</span>){</span>
<span id="cb37-2"><a href="#cb37-2"></a>  <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span>(<span class="st">"Check annotations in this chart before compiling"</span>)</span>
<span id="cb37-3"><a href="#cb37-3"></a>}</span>
<span id="cb37-4"><a href="#cb37-4"></a>sample_file <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb37-5"><a href="#cb37-5"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(Net_CG_amt <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, age_imp <span class="op">&gt;</span><span class="st"> </span><span class="dv">20</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb37-6"><a href="#cb37-6"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">marginal_rate =</span> <span class="kw"><a href="../reference/income_tax.html">income_tax</a></span>(Taxable_Income <span class="op">+</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">fy.year =</span> FY.YEAR) <span class="op">-</span><span class="st"> </span><span class="kw"><a href="../reference/income_tax.html">income_tax</a></span>(Taxable_Income, <span class="dt">fy.year =</span> FY.YEAR)) <span class="op">%&gt;%</span></span>
<span id="cb37-7"><a href="#cb37-7"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">rename</a></span>(<span class="dt">Age =</span> age_imp) <span class="op">%&gt;%</span></span>
<span id="cb37-8"><a href="#cb37-8"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> Age, <span class="dt">y =</span> marginal_rate)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb37-9"><a href="#cb37-9"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(<span class="dt">label =</span> percent) <span class="op">+</span><span class="st"> </span></span>
<span id="cb37-10"><a href="#cb37-10"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">weight =</span> <span class="dv">1</span>), <span class="dt">colour =</span> <span class="kw"><a href="https://rdrr.io/pkg/viridis/man/reexports.html">viridis</a></span>(<span class="dv">2</span>)[<span class="dv">1</span>], <span class="dt">size =</span> <span class="fl">1.2</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb37-11"><a href="#cb37-11"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">weight =</span> Net_CG_amt), <span class="dt">colour =</span> <span class="kw"><a href="https://rdrr.io/pkg/viridis/man/reexports.html">viridis</a></span>(<span class="dv">2</span>)[<span class="dv">2</span>], <span class="dt">size =</span> <span class="fl">1.2</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb37-12"><a href="#cb37-12"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span>(<span class="st">"text"</span>, </span>
<span id="cb37-13"><a href="#cb37-13"></a>           <span class="dt">x =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">57</span>, <span class="dv">57</span>), </span>
<span id="cb37-14"><a href="#cb37-14"></a>           <span class="dt">y =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.335</span>, <span class="fl">0.435</span>), </span>
<span id="cb37-15"><a href="#cb37-15"></a>           <span class="dt">label =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Unweighted"</span>, <span class="st">"Weighted by CG amt"</span>), </span>
<span id="cb37-16"><a href="#cb37-16"></a>           <span class="dt">colour =</span> <span class="kw"><a href="https://rdrr.io/pkg/viridis/man/reexports.html">viridis</a></span>(<span class="dv">2</span>), </span>
<span id="cb37-17"><a href="#cb37-17"></a>           <span class="dt">fontface =</span> <span class="st">"bold"</span>, </span>
<span id="cb37-18"><a href="#cb37-18"></a>           <span class="dt">hjust =</span> <span class="dv">0</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb37-19"><a href="#cb37-19"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="dt">axis.title.y =</span> <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span>())</span></code></pre></div>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1"></a><span class="cf">if</span> (FY.YEAR <span class="op">!=</span><span class="st"> "2013-14"</span>){</span>
<span id="cb38-2"><a href="#cb38-2"></a>  <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span>(<span class="st">"Check annotations in this chart before compiling"</span>)</span>
<span id="cb38-3"><a href="#cb38-3"></a>}</span>
<span id="cb38-4"><a href="#cb38-4"></a>sample_file <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb38-5"><a href="#cb38-5"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(Net_CG_amt <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, age_imp <span class="op">&gt;</span><span class="st"> </span><span class="dv">20</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb38-6"><a href="#cb38-6"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">Taxable_Income_b4_CG =</span> <span class="kw"><a href="../reference/pmaxC.html">pmaxC</a></span>(Taxable_Income <span class="op">-</span><span class="st"> </span>Net_CG_amt, <span class="dv">0</span>),</span>
<span id="cb38-7"><a href="#cb38-7"></a>         <span class="dt">marginal_rate_b4_CG =</span> <span class="kw"><a href="../reference/income_tax.html">income_tax</a></span>(Taxable_Income_b4_CG <span class="op">+</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">fy.year =</span> FY.YEAR) <span class="op">-</span><span class="st"> </span><span class="kw"><a href="../reference/income_tax.html">income_tax</a></span>(Taxable_Income_b4_CG, <span class="dt">fy.year =</span> FY.YEAR)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb38-8"><a href="#cb38-8"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">rename</a></span>(<span class="dt">Age =</span> age_imp) <span class="op">%&gt;%</span></span>
<span id="cb38-9"><a href="#cb38-9"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> Age, <span class="dt">y =</span> marginal_rate_b4_CG)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb38-10"><a href="#cb38-10"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(<span class="dt">label =</span> percent) <span class="op">+</span></span>
<span id="cb38-11"><a href="#cb38-11"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">weight =</span> <span class="dv">1</span>),  <span class="dt">colour =</span> <span class="kw"><a href="https://rdrr.io/pkg/viridis/man/reexports.html">viridis</a></span>(<span class="dv">2</span>)[<span class="dv">2</span>], <span class="dt">size =</span> <span class="fl">1.2</span>) <span class="op">+</span></span>
<span id="cb38-12"><a href="#cb38-12"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">weight =</span> Net_CG_amt), <span class="dt">colour =</span> <span class="kw"><a href="https://rdrr.io/pkg/viridis/man/reexports.html">viridis</a></span>(<span class="dv">2</span>)[<span class="dv">1</span>], <span class="dt">size =</span> <span class="fl">1.2</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb38-13"><a href="#cb38-13"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span>(<span class="st">"text"</span>, </span>
<span id="cb38-14"><a href="#cb38-14"></a>           <span class="dt">x =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">31</span>, <span class="dv">35</span>), </span>
<span id="cb38-15"><a href="#cb38-15"></a>           <span class="dt">y =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.315</span>, <span class="fl">0.225</span>), </span>
<span id="cb38-16"><a href="#cb38-16"></a>           <span class="dt">label =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Unweighted"</span>, <span class="st">"Weighted by CG amt"</span>), </span>
<span id="cb38-17"><a href="#cb38-17"></a>           <span class="dt">colour =</span> <span class="kw"><a href="https://rdrr.io/pkg/viridis/man/reexports.html">viridis</a></span>(<span class="dv">2</span>), </span>
<span id="cb38-18"><a href="#cb38-18"></a>           <span class="dt">fontface =</span> <span class="st">"bold"</span>, </span>
<span id="cb38-19"><a href="#cb38-19"></a>           <span class="dt">hjust =</span> <span class="dv">0</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb38-20"><a href="#cb38-20"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="dt">axis.title.y =</span> <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span>())</span></code></pre></div>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1"></a>n_prop_invstrs &lt;-</span>
<span id="cb39-2"><a href="#cb39-2"></a><span class="st">  </span>sample_file <span class="op">%$%</span></span>
<span id="cb39-3"><a href="#cb39-3"></a><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>((Gross_rent_amt <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">*</span><span class="st"> </span>WEIGHT)</span>
<span id="cb39-4"><a href="#cb39-4"></a></span>
<span id="cb39-5"><a href="#cb39-5"></a>n_NGs &lt;-<span class="st"> </span></span>
<span id="cb39-6"><a href="#cb39-6"></a><span class="st">  </span>sample_file <span class="op">%$%</span></span>
<span id="cb39-7"><a href="#cb39-7"></a><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>((Net_rent_amt <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">*</span><span class="st"> </span>WEIGHT)</span>
<span id="cb39-8"><a href="#cb39-8"></a></span>
<span id="cb39-9"><a href="#cb39-9"></a>val_NG_losses &lt;-<span class="st"> </span></span>
<span id="cb39-10"><a href="#cb39-10"></a><span class="st">  </span>sample_file <span class="op">%$%</span></span>
<span id="cb39-11"><a href="#cb39-11"></a><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw"><a href="../reference/pminC.html">pminC</a></span>(Net_rent_amt, <span class="dv">0</span>) <span class="op">*</span><span class="st"> </span>WEIGHT))</span>
<span id="cb39-12"><a href="#cb39-12"></a></span>
<span id="cb39-13"><a href="#cb39-13"></a>NG_tax_exp &lt;-<span class="st"> </span></span>
<span id="cb39-14"><a href="#cb39-14"></a><span class="st">  </span>sample_file <span class="op">%&gt;%</span></span>
<span id="cb39-15"><a href="#cb39-15"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">tax =</span> <span class="kw"><a href="../reference/income_tax.html">income_tax</a></span>(Taxable_Income, <span class="dt">fy.year =</span> FY.YEAR),</span>
<span id="cb39-16"><a href="#cb39-16"></a>         <span class="dt">new_tax =</span> <span class="kw"><a href="../reference/income_tax.html">income_tax</a></span>(Taxable_Income <span class="op">-</span><span class="st"> </span><span class="kw"><a href="../reference/pminC.html">pminC</a></span>(Net_rent_amt, <span class="dv">0</span>), <span class="dt">fy.year =</span> FY.YEAR),</span>
<span id="cb39-17"><a href="#cb39-17"></a>         <span class="dt">diff =</span> new_tax <span class="op">-</span><span class="st"> </span>tax) <span class="op">%$%</span></span>
<span id="cb39-18"><a href="#cb39-18"></a><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(diff <span class="op">*</span><span class="st"> </span>WEIGHT)</span></code></pre></div>
<p>There were res property investors. Of these, res were negative gearing. Losses claimed totaled res. This delivered a tax expenditure (by revenue foregone) of res.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1"></a>sample_file <span class="op">%&gt;%</span></span>
<span id="cb40-2"><a href="#cb40-2"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="kw"><a href="https://dplyr.tidyverse.org/reference/between.html">between</a></span>(Sw_amt, <span class="dv">0</span>, <span class="fl">250e3</span>)) <span class="op">%&gt;%</span></span>
<span id="cb40-3"><a href="#cb40-3"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">rename</a></span>(<span class="dt">Salary =</span> Sw_amt) <span class="op">%&gt;%</span></span>
<span id="cb40-4"><a href="#cb40-4"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> Salary, <span class="dt">y =</span> <span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(Net_rent_amt <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>))) <span class="op">+</span><span class="st"> </span></span>
<span id="cb40-5"><a href="#cb40-5"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span>(<span class="dt">colour =</span> <span class="kw"><a href="https://rdrr.io/pkg/viridis/man/reexports.html">viridis</a></span>(<span class="dv">2</span>)[<span class="dv">2</span>], <span class="dt">size =</span> <span class="fl">1.5</span>) <span class="op">+</span></span>
<span id="cb40-6"><a href="#cb40-6"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(<span class="dt">label =</span> percent) <span class="op">+</span><span class="st"> </span></span>
<span id="cb40-7"><a href="#cb40-7"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span>(<span class="dt">label =</span> dollar) <span class="op">+</span><span class="st"> </span></span>
<span id="cb40-8"><a href="#cb40-8"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="dt">axis.title.y =</span> <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span>())</span></code></pre></div>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1"></a>NG_by_taxBracket &lt;-</span>
<span id="cb41-2"><a href="#cb41-2"></a><span class="st">  </span>sample_file <span class="op">%&gt;%</span></span>
<span id="cb41-3"><a href="#cb41-3"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">Tax_bracket =</span> <span class="kw"><a href="https://rdrr.io/r/base/cut.html">cut</a></span>(Taxable_Income, </span>
<span id="cb41-4"><a href="#cb41-4"></a>                             <span class="dt">breaks =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="ot">Inf</span>, <span class="dv">18200</span>, <span class="fl">37e3</span>, <span class="fl">80e3</span>, <span class="fl">180e3</span>, <span class="ot">Inf</span>),</span>
<span id="cb41-5"><a href="#cb41-5"></a>                             <span class="dt">labels =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"$0-$18,200"</span>, <span class="st">"$18,201-$37,000"</span>, </span>
<span id="cb41-6"><a href="#cb41-6"></a>                                        <span class="st">"$37,001-$80,000"</span>, <span class="st">"$80,001-$180,000"</span>, </span>
<span id="cb41-7"><a href="#cb41-7"></a>                                        <span class="st">"Over $180,000"</span>),</span>
<span id="cb41-8"><a href="#cb41-8"></a>                             <span class="dt">ordered_results =</span> <span class="ot">TRUE</span>,</span>
<span id="cb41-9"><a href="#cb41-9"></a>                             <span class="dt">include.lowest =</span> <span class="ot">TRUE</span>)) <span class="op">%&gt;%</span></span>
<span id="cb41-10"><a href="#cb41-10"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(Tax_bracket) <span class="op">%&gt;%</span></span>
<span id="cb41-11"><a href="#cb41-11"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span>(<span class="dt">n_NG =</span> <span class="kw">wsum</span>(Net_rent_amt <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>, WEIGHT), </span>
<span id="cb41-12"><a href="#cb41-12"></a>            <span class="dt">n =</span> <span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(WEIGHT)) <span class="op">%&gt;%</span></span>
<span id="cb41-13"><a href="#cb41-13"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(Tax_bracket)</span></code></pre></div>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1"></a>NG_by_taxBracket <span class="op">%&gt;%</span></span>
<span id="cb42-2"><a href="#cb42-2"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="st">`</span><span class="dt">Number negative gearing</span><span class="st">`</span> =<span class="st"> </span><span class="kw"><a href="https://scales.r-lib.org//reference/number_format.html">comma</a></span>(n_NG), </span>
<span id="cb42-3"><a href="#cb42-3"></a>         <span class="st">`</span><span class="ch">\\</span><span class="dt">%</span><span class="st">`</span> =<span class="st"> </span><span class="kw"><a href="https://scales.r-lib.org//reference/number_format.html">percent</a></span>(n_NG <span class="op">/</span><span class="st"> </span>n)) <span class="op">%&gt;%</span></span>
<span id="cb42-4"><a href="#cb42-4"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="st">`</span><span class="dt">Tax bracket</span><span class="st">`</span> =<span class="st"> </span>Tax_bracket, </span>
<span id="cb42-5"><a href="#cb42-5"></a>         <span class="st">`</span><span class="dt">Number negative gearing</span><span class="st">`</span>, </span>
<span id="cb42-6"><a href="#cb42-6"></a>         <span class="st">`</span><span class="ch">\\</span><span class="dt">%</span><span class="st">`</span>) <span class="op">%&gt;%</span></span>
<span id="cb42-7"><a href="#cb42-7"></a><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>(<span class="dt">align =</span> <span class="st">"rrr"</span>) </span></code></pre></div>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1"></a>NG_by_taxBracket_tax_benefit &lt;-<span class="st"> </span></span>
<span id="cb43-2"><a href="#cb43-2"></a><span class="st">  </span>sample_file <span class="op">%&gt;%</span></span>
<span id="cb43-3"><a href="#cb43-3"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">Tot_inc_amt_NoNG =</span> Tot_inc_amt <span class="op">-</span><span class="st"> </span>Net_rent_amt <span class="op">+</span><span class="st"> </span><span class="kw"><a href="../reference/pmaxC.html">pmaxC</a></span>(Net_rent_amt, <span class="dv">0</span>),</span>
<span id="cb43-4"><a href="#cb43-4"></a>         <span class="dt">Taxable_Income_noNG =</span> <span class="kw"><a href="../reference/pmaxC.html">pmaxC</a></span>(Tot_inc_amt_NoNG <span class="op">-</span><span class="st"> </span>Tot_ded_amt <span class="op">-</span><span class="st"> </span>NPP_loss_claimed <span class="op">-</span><span class="st"> </span>PP_loss_claimed, <span class="dv">0</span>),</span>
<span id="cb43-5"><a href="#cb43-5"></a>         <span class="dt">tax_current =</span> <span class="kw"><a href="../reference/income_tax.html">income_tax</a></span>(Taxable_Income, <span class="dt">fy.year =</span> FY.YEAR),</span>
<span id="cb43-6"><a href="#cb43-6"></a>         <span class="dt">tax_noNG =</span> <span class="kw"><a href="../reference/income_tax.html">income_tax</a></span>(Taxable_Income_noNG, <span class="dt">fy.year =</span> FY.YEAR),</span>
<span id="cb43-7"><a href="#cb43-7"></a>         <span class="dt">change =</span> tax_noNG <span class="op">-</span><span class="st"> </span>tax_current) <span class="op">%&gt;%</span></span>
<span id="cb43-8"><a href="#cb43-8"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">Tax_bracket =</span> <span class="kw"><a href="https://rdrr.io/r/base/cut.html">cut</a></span>(Taxable_Income, </span>
<span id="cb43-9"><a href="#cb43-9"></a>                             <span class="dt">breaks =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="ot">Inf</span>, <span class="dv">18200</span>, <span class="fl">37e3</span>, <span class="fl">80e3</span>, <span class="fl">180e3</span>, <span class="ot">Inf</span>),</span>
<span id="cb43-10"><a href="#cb43-10"></a>                             <span class="dt">labels =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"$0-$18,200"</span>, </span>
<span id="cb43-11"><a href="#cb43-11"></a>                                        <span class="st">"$18,201-$37,000"</span>, </span>
<span id="cb43-12"><a href="#cb43-12"></a>                                        <span class="st">"$37,001-$80,000"</span>, </span>
<span id="cb43-13"><a href="#cb43-13"></a>                                        <span class="st">"$80,001-$180,000"</span>, </span>
<span id="cb43-14"><a href="#cb43-14"></a>                                        <span class="st">"Over $180,000"</span>),</span>
<span id="cb43-15"><a href="#cb43-15"></a>                             <span class="dt">ordered_results =</span> <span class="ot">TRUE</span>,</span>
<span id="cb43-16"><a href="#cb43-16"></a>                             <span class="dt">include.lowest =</span> <span class="ot">TRUE</span>)) <span class="op">%&gt;%</span></span>
<span id="cb43-17"><a href="#cb43-17"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(Tax_bracket) <span class="op">%&gt;%</span></span>
<span id="cb43-18"><a href="#cb43-18"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span>(<span class="dt">total_tax_change =</span> <span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(change <span class="op">*</span><span class="st"> </span>WEIGHT),</span>
<span id="cb43-19"><a href="#cb43-19"></a>            <span class="dt">avg_tax_change =</span> <span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(change)) <span class="op">%&gt;%</span></span>
<span id="cb43-20"><a href="#cb43-20"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(Tax_bracket)</span></code></pre></div>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1"></a>NG_by_taxBracket_tax_benefit <span class="op">%&gt;%</span></span>
<span id="cb44-2"><a href="#cb44-2"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="st">`</span><span class="dt">Total tax change</span><span class="st">`</span> =<span class="st"> </span><span class="kw">grattan_dollar</span>(total_tax_change), </span>
<span id="cb44-3"><a href="#cb44-3"></a>         <span class="st">`</span><span class="dt">Average tax change</span><span class="st">`</span> =<span class="st"> </span><span class="kw">grattan_dollar</span>(avg_tax_change)) <span class="op">%&gt;%</span></span>
<span id="cb44-4"><a href="#cb44-4"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="st">`</span><span class="dt">Tax bracket</span><span class="st">`</span> =<span class="st"> </span>Tax_bracket, </span>
<span id="cb44-5"><a href="#cb44-5"></a>         <span class="st">`</span><span class="dt">Total tax change</span><span class="st">`</span>, </span>
<span id="cb44-6"><a href="#cb44-6"></a>         <span class="st">`</span><span class="dt">Average tax change</span><span class="st">`</span>) <span class="op">%&gt;%</span></span>
<span id="cb44-7"><a href="#cb44-7"></a><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>(<span class="dt">align =</span> <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="st">"r"</span>, <span class="kw"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(.)), <span class="dt">collapse =</span> <span class="st">""</span>))</span></code></pre></div>

<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1"></a>NG_by_taxable_income_decile &lt;-<span class="st"> </span></span>
<span id="cb45-2"><a href="#cb45-2"></a><span class="st">  </span>sample_file <span class="op">%&gt;%</span></span>
<span id="cb45-3"><a href="#cb45-3"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">Taxable_Income_decile =</span> <span class="kw"><a href="https://dplyr.tidyverse.org/reference/ranking.html">ntile</a></span>(Taxable_Income, <span class="dv">10</span>)) <span class="op">%&gt;%</span></span>
<span id="cb45-4"><a href="#cb45-4"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(Taxable_Income_decile) <span class="op">%&gt;%</span></span>
<span id="cb45-5"><a href="#cb45-5"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span>(<span class="dt">n_NG =</span> <span class="kw">wsum</span>(Net_rent_amt <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>, WEIGHT), </span>
<span id="cb45-6"><a href="#cb45-6"></a>            <span class="dt">n =</span> <span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(WEIGHT)) <span class="op">%&gt;%</span></span>
<span id="cb45-7"><a href="#cb45-7"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(Taxable_Income_decile) </span></code></pre></div>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1"></a>NG_by_taxable_income_decile <span class="op">%&gt;%</span></span>
<span id="cb46-2"><a href="#cb46-2"></a><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="st">`</span><span class="dt">Number negative gearing</span><span class="st">`</span> =<span class="st"> </span><span class="kw"><a href="https://scales.r-lib.org//reference/number_format.html">comma</a></span>(n_NG), </span>
<span id="cb46-3"><a href="#cb46-3"></a>         <span class="st">`</span><span class="ch">\\</span><span class="dt">%</span><span class="st">`</span> =<span class="st"> </span><span class="kw"><a href="https://scales.r-lib.org//reference/number_format.html">percent</a></span>(n_NG <span class="op">/</span><span class="st"> </span>n)) <span class="op">%&gt;%</span></span>
<span id="cb46-4"><a href="#cb46-4"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="st">`</span><span class="dt">Taxable Income decile</span><span class="st">`</span> =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(Taxable_Income_decile)) <span class="op">%&gt;%</span></span>
<span id="cb46-5"><a href="#cb46-5"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="st">`</span><span class="dt">Taxable Income decile</span><span class="st">`</span>, </span>
<span id="cb46-6"><a href="#cb46-6"></a>         <span class="st">`</span><span class="dt">Number negative gearing</span><span class="st">`</span>, </span>
<span id="cb46-7"><a href="#cb46-7"></a>         <span class="st">`</span><span class="ch">\\</span><span class="dt">%</span><span class="st">`</span>) <span class="op">%&gt;%</span></span>
<span id="cb46-8"><a href="#cb46-8"></a><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>(<span class="dt">align =</span> <span class="st">"rrrr"</span>) </span></code></pre></div>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1"></a>NG_tax_benefit_taxable_income_decile &lt;-</span>
<span id="cb47-2"><a href="#cb47-2"></a><span class="st">  </span>sample_file <span class="op">%&gt;%</span></span>
<span id="cb47-3"><a href="#cb47-3"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">Tot_inc_amt_NoNG =</span> Tot_inc_amt <span class="op">-</span><span class="st"> </span>Net_rent_amt <span class="op">+</span><span class="st"> </span><span class="kw"><a href="../reference/pmaxC.html">pmaxC</a></span>(Net_rent_amt, <span class="dv">0</span>),</span>
<span id="cb47-4"><a href="#cb47-4"></a>         <span class="dt">Taxable_Income_noNG =</span> <span class="kw"><a href="../reference/pmaxC.html">pmaxC</a></span>(Tot_inc_amt_NoNG <span class="op">-</span><span class="st"> </span>Tot_ded_amt <span class="op">-</span><span class="st"> </span>NPP_loss_claimed <span class="op">-</span><span class="st"> </span>PP_loss_claimed, <span class="dv">0</span>),</span>
<span id="cb47-5"><a href="#cb47-5"></a>         <span class="dt">tax_current =</span> <span class="kw"><a href="../reference/income_tax.html">income_tax</a></span>(Taxable_Income, <span class="dt">fy.year =</span> FY.YEAR),</span>
<span id="cb47-6"><a href="#cb47-6"></a>         <span class="dt">tax_noNG =</span> <span class="kw"><a href="../reference/income_tax.html">income_tax</a></span>(Taxable_Income_noNG, <span class="dt">fy.year =</span> FY.YEAR),</span>
<span id="cb47-7"><a href="#cb47-7"></a>         <span class="dt">change =</span> tax_noNG <span class="op">-</span><span class="st"> </span>tax_current) <span class="op">%&gt;%</span></span>
<span id="cb47-8"><a href="#cb47-8"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">Taxable_Income_decile =</span> <span class="kw"><a href="https://dplyr.tidyverse.org/reference/ranking.html">ntile</a></span>(Taxable_Income, <span class="dv">10</span>)) <span class="op">%&gt;%</span></span>
<span id="cb47-9"><a href="#cb47-9"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(Taxable_Income_decile) <span class="op">%&gt;%</span></span>
<span id="cb47-10"><a href="#cb47-10"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span>(<span class="dt">tax_diff =</span> <span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(change <span class="op">*</span><span class="st"> </span>WEIGHT)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb47-11"><a href="#cb47-11"></a><span class="st">  </span>ungroup <span class="op">%&gt;%</span></span>
<span id="cb47-12"><a href="#cb47-12"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">tax_diff_prop =</span> tax_diff <span class="op">/</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(tax_diff)) <span class="op">%&gt;%</span></span>
<span id="cb47-13"><a href="#cb47-13"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(Taxable_Income_decile) <span class="op">%&gt;%</span></span>
<span id="cb47-14"><a href="#cb47-14"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">decile_by =</span> <span class="st">"Taxable income"</span>)</span>
<span id="cb47-15"><a href="#cb47-15"></a></span>
<span id="cb47-16"><a href="#cb47-16"></a>NG_tax_benefit_taxable_income_decile_noNG &lt;-</span>
<span id="cb47-17"><a href="#cb47-17"></a><span class="st">  </span>sample_file <span class="op">%&gt;%</span></span>
<span id="cb47-18"><a href="#cb47-18"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">Tot_inc_amt_NoNG =</span> Tot_inc_amt <span class="op">-</span><span class="st"> </span>Net_rent_amt <span class="op">+</span><span class="st"> </span><span class="kw"><a href="../reference/pmaxC.html">pmaxC</a></span>(Net_rent_amt, <span class="dv">0</span>),</span>
<span id="cb47-19"><a href="#cb47-19"></a>         <span class="dt">Taxable_Income_noNG =</span> <span class="kw"><a href="../reference/pmaxC.html">pmaxC</a></span>(Tot_inc_amt_NoNG <span class="op">-</span><span class="st"> </span>Tot_ded_amt <span class="op">-</span><span class="st"> </span>NPP_loss_claimed <span class="op">-</span><span class="st"> </span>PP_loss_claimed, <span class="dv">0</span>),</span>
<span id="cb47-20"><a href="#cb47-20"></a>         <span class="dt">tax_current =</span> <span class="kw"><a href="../reference/income_tax.html">income_tax</a></span>(Taxable_Income, <span class="dt">fy.year =</span> FY.YEAR),</span>
<span id="cb47-21"><a href="#cb47-21"></a>         <span class="dt">tax_noNG =</span> <span class="kw"><a href="../reference/income_tax.html">income_tax</a></span>(Taxable_Income_noNG, <span class="dt">fy.year =</span> FY.YEAR),</span>
<span id="cb47-22"><a href="#cb47-22"></a>         <span class="dt">change =</span> tax_noNG <span class="op">-</span><span class="st"> </span>tax_current) <span class="op">%&gt;%</span></span>
<span id="cb47-23"><a href="#cb47-23"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">Taxable_Income_decile =</span> <span class="kw"><a href="https://dplyr.tidyverse.org/reference/ranking.html">ntile</a></span>(Taxable_Income_noNG, <span class="dv">10</span>)) <span class="op">%&gt;%</span></span>
<span id="cb47-24"><a href="#cb47-24"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(Taxable_Income_decile) <span class="op">%&gt;%</span></span>
<span id="cb47-25"><a href="#cb47-25"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span>(<span class="dt">tax_diff =</span> <span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(change <span class="op">*</span><span class="st"> </span>WEIGHT)) <span class="op">%&gt;%</span></span>
<span id="cb47-26"><a href="#cb47-26"></a><span class="st">  </span>ungroup <span class="op">%&gt;%</span></span>
<span id="cb47-27"><a href="#cb47-27"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">tax_diff_prop =</span> tax_diff <span class="op">/</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(tax_diff)) <span class="op">%&gt;%</span></span>
<span id="cb47-28"><a href="#cb47-28"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(Taxable_Income_decile) <span class="op">%&gt;%</span></span>
<span id="cb47-29"><a href="#cb47-29"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">decile_by =</span> <span class="st">"Taxable income before NG"</span>)</span>
<span id="cb47-30"><a href="#cb47-30"></a></span>
<span id="cb47-31"><a href="#cb47-31"></a><span class="kw"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span>(<span class="st">"Current"</span> =<span class="st"> </span>NG_tax_benefit_taxable_income_decile, </span>
<span id="cb47-32"><a href="#cb47-32"></a>          <span class="st">"Before NG"</span> =<span class="st"> </span>NG_tax_benefit_taxable_income_decile_noNG) <span class="op">%&gt;%</span></span>
<span id="cb47-33"><a href="#cb47-33"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="st">`</span><span class="dt">Taxable income decile</span><span class="st">`</span> =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(Taxable_Income_decile)) <span class="op">%&gt;%</span></span>
<span id="cb47-34"><a href="#cb47-34"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> <span class="st">`</span><span class="dt">Taxable income decile</span><span class="st">`</span>, <span class="dt">y =</span> tax_diff_prop, <span class="dt">fill =</span> decile_by)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb47-35"><a href="#cb47-35"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="dt">stat =</span> <span class="st">"identity"</span>) <span class="op">+</span></span>
<span id="cb47-36"><a href="#cb47-36"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span>(<span class="op">~</span>decile_by) <span class="op">+</span><span class="st"> </span></span>
<span id="cb47-37"><a href="#cb47-37"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(<span class="dt">label =</span> percent, </span>
<span id="cb47-38"><a href="#cb47-38"></a>                     <span class="dt">expand =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>,<span class="dv">0</span>),</span>
<span id="cb47-39"><a href="#cb47-39"></a>                     <span class="dt">limits =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>, <span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(NG_tax_benefit_taxable_income_decile_noNG<span class="op">$</span>tax_diff_prop, </span>
<span id="cb47-40"><a href="#cb47-40"></a>                                               NG_tax_benefit_taxable_income_decile<span class="op">$</span>tax_diff_prop)), <span class="dv">1</span>)))</span>
<span id="cb47-41"><a href="#cb47-41"></a>  </span></code></pre></div>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1"></a>NG_tax_benefit_taxable_income_decile_prev &lt;-</span>
<span id="cb48-2"><a href="#cb48-2"></a><span class="st">  </span>sample_file_prev <span class="op">%&gt;%</span></span>
<span id="cb48-3"><a href="#cb48-3"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">Tot_inc_amt_NoNG =</span> Tot_inc_amt <span class="op">-</span><span class="st"> </span>Net_rent_amt <span class="op">+</span><span class="st"> </span><span class="kw"><a href="../reference/pmaxC.html">pmaxC</a></span>(Net_rent_amt, <span class="dv">0</span>),</span>
<span id="cb48-4"><a href="#cb48-4"></a>         <span class="dt">Taxable_Income_noNG =</span> <span class="kw"><a href="../reference/pmaxC.html">pmaxC</a></span>(Tot_inc_amt_NoNG <span class="op">-</span><span class="st"> </span>Tot_ded_amt <span class="op">-</span><span class="st"> </span>NPP_loss_claimed <span class="op">-</span><span class="st"> </span>PP_loss_claimed, <span class="dv">0</span>),</span>
<span id="cb48-5"><a href="#cb48-5"></a>         <span class="dt">tax_current =</span> <span class="kw"><a href="../reference/income_tax.html">income_tax</a></span>(Taxable_Income, <span class="dt">fy.year =</span> FY.YEAR),</span>
<span id="cb48-6"><a href="#cb48-6"></a>         <span class="dt">tax_noNG =</span> <span class="kw"><a href="../reference/income_tax.html">income_tax</a></span>(Taxable_Income_noNG, <span class="dt">fy.year =</span> FY.YEAR),</span>
<span id="cb48-7"><a href="#cb48-7"></a>         <span class="dt">change =</span> tax_noNG <span class="op">-</span><span class="st"> </span>tax_current) <span class="op">%&gt;%</span></span>
<span id="cb48-8"><a href="#cb48-8"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">Taxable_Income_decile =</span> <span class="kw"><a href="https://dplyr.tidyverse.org/reference/ranking.html">ntile</a></span>(Taxable_Income, <span class="dv">10</span>)) <span class="op">%&gt;%</span></span>
<span id="cb48-9"><a href="#cb48-9"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(Taxable_Income_decile) <span class="op">%&gt;%</span></span>
<span id="cb48-10"><a href="#cb48-10"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span>(<span class="dt">tax_diff =</span> <span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(change <span class="op">*</span><span class="st"> </span>WEIGHT)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb48-11"><a href="#cb48-11"></a><span class="st">  </span>ungroup <span class="op">%&gt;%</span></span>
<span id="cb48-12"><a href="#cb48-12"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">tax_diff_prop =</span> tax_diff <span class="op">/</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(tax_diff)) <span class="op">%&gt;%</span></span>
<span id="cb48-13"><a href="#cb48-13"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(Taxable_Income_decile) <span class="op">%&gt;%</span></span>
<span id="cb48-14"><a href="#cb48-14"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">decile_by =</span> <span class="st">"Taxable income"</span>)</span>
<span id="cb48-15"><a href="#cb48-15"></a></span>
<span id="cb48-16"><a href="#cb48-16"></a>NG_tax_benefit_taxable_income_decile_noNG_prev &lt;-</span>
<span id="cb48-17"><a href="#cb48-17"></a><span class="st">  </span>sample_file_prev <span class="op">%&gt;%</span></span>
<span id="cb48-18"><a href="#cb48-18"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">Tot_inc_amt_NoNG =</span> Tot_inc_amt <span class="op">-</span><span class="st"> </span>Net_rent_amt <span class="op">+</span><span class="st"> </span><span class="kw"><a href="../reference/pmaxC.html">pmaxC</a></span>(Net_rent_amt, <span class="dv">0</span>),</span>
<span id="cb48-19"><a href="#cb48-19"></a>         <span class="dt">Taxable_Income_noNG =</span> <span class="kw"><a href="../reference/pmaxC.html">pmaxC</a></span>(Tot_inc_amt_NoNG <span class="op">-</span><span class="st"> </span>Tot_ded_amt <span class="op">-</span><span class="st"> </span>NPP_loss_claimed <span class="op">-</span><span class="st"> </span>PP_loss_claimed, <span class="dv">0</span>),</span>
<span id="cb48-20"><a href="#cb48-20"></a>         <span class="dt">tax_current =</span> <span class="kw"><a href="../reference/income_tax.html">income_tax</a></span>(Taxable_Income, <span class="dt">fy.year =</span> FY.YEAR),</span>
<span id="cb48-21"><a href="#cb48-21"></a>         <span class="dt">tax_noNG =</span> <span class="kw"><a href="../reference/income_tax.html">income_tax</a></span>(Taxable_Income_noNG, <span class="dt">fy.year =</span> FY.YEAR),</span>
<span id="cb48-22"><a href="#cb48-22"></a>         <span class="dt">change =</span> tax_noNG <span class="op">-</span><span class="st"> </span>tax_current) <span class="op">%&gt;%</span></span>
<span id="cb48-23"><a href="#cb48-23"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">Taxable_Income_decile =</span> <span class="kw"><a href="https://dplyr.tidyverse.org/reference/ranking.html">ntile</a></span>(Taxable_Income, <span class="dv">10</span>)) <span class="op">%&gt;%</span></span>
<span id="cb48-24"><a href="#cb48-24"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(Taxable_Income_decile) <span class="op">%&gt;%</span><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span>(<span class="dt">tax_diff =</span> <span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(change <span class="op">*</span><span class="st"> </span>WEIGHT)) <span class="op">%&gt;%</span></span>
<span id="cb48-25"><a href="#cb48-25"></a><span class="st">  </span>ungroup <span class="op">%&gt;%</span></span>
<span id="cb48-26"><a href="#cb48-26"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">tax_diff_prop =</span> tax_diff <span class="op">/</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(tax_diff)) <span class="op">%&gt;%</span></span>
<span id="cb48-27"><a href="#cb48-27"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(Taxable_Income_decile) <span class="op">%&gt;%</span></span>
<span id="cb48-28"><a href="#cb48-28"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">decile_by =</span> <span class="st">"Taxable income before NG"</span>)</span>
<span id="cb48-29"><a href="#cb48-29"></a></span>
<span id="cb48-30"><a href="#cb48-30"></a><span class="kw"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span>(<span class="st">"Current"</span> =<span class="st"> </span>NG_tax_benefit_taxable_income_decile, </span>
<span id="cb48-31"><a href="#cb48-31"></a>          <span class="st">"Before NG"</span> =<span class="st"> </span>NG_tax_benefit_taxable_income_decile_noNG, </span>
<span id="cb48-32"><a href="#cb48-32"></a>          <span class="st">"Current (prev fy)"</span> =<span class="st"> </span>NG_tax_benefit_taxable_income_decile_prev, </span>
<span id="cb48-33"><a href="#cb48-33"></a>          <span class="st">"Before NG (prev fy)"</span> =<span class="st"> </span>NG_tax_benefit_taxable_income_decile_noNG_prev, </span>
<span id="cb48-34"><a href="#cb48-34"></a>          <span class="dt">.id =</span> <span class="st">"df_id"</span>) <span class="op">%&gt;%</span></span>
<span id="cb48-35"><a href="#cb48-35"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="st">`</span><span class="dt">Taxable income decile</span><span class="st">`</span> =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(Taxable_Income_decile)) <span class="op">%&gt;%</span></span>
<span id="cb48-36"><a href="#cb48-36"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">financial_year =</span> <span class="kw"><a href="https://Rdatatable.gitlab.io/data.table/reference/fifelse.html">ifelse</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span>(<span class="st">"prev fy"</span>, df_id), PREV.FY.YEAR, FY.YEAR)) <span class="op">%&gt;%</span></span>
<span id="cb48-37"><a href="#cb48-37"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> <span class="st">`</span><span class="dt">Taxable income decile</span><span class="st">`</span>, <span class="dt">y =</span> tax_diff_prop, <span class="dt">fill =</span> financial_year)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb48-38"><a href="#cb48-38"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="dt">stat =</span> <span class="st">"identity"</span>, <span class="dt">position =</span> <span class="st">"dodge"</span>) <span class="op">+</span></span>
<span id="cb48-39"><a href="#cb48-39"></a><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/viridis/man/scale_viridis.html">scale_fill_viridis</a></span>(<span class="dt">discrete =</span> <span class="ot">TRUE</span>, <span class="dt">begin =</span> <span class="dv">0</span>, <span class="dt">end =</span> <span class="fl">0.3333</span>) <span class="op">+</span></span>
<span id="cb48-40"><a href="#cb48-40"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span>(<span class="op">~</span>decile_by) <span class="op">+</span><span class="st"> </span></span>
<span id="cb48-41"><a href="#cb48-41"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(<span class="dt">label =</span> percent, </span>
<span id="cb48-42"><a href="#cb48-42"></a>                     <span class="dt">expand =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>,<span class="dv">0</span>),</span>
<span id="cb48-43"><a href="#cb48-43"></a>                     <span class="dt">limits =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>, <span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(NG_tax_benefit_taxable_income_decile_noNG<span class="op">$</span>tax_diff_prop, </span>
<span id="cb48-44"><a href="#cb48-44"></a>                                               NG_tax_benefit_taxable_income_decile<span class="op">$</span>tax_diff_prop)), <span class="dv">1</span>))) <span class="op">+</span><span class="st"> </span></span>
<span id="cb48-45"><a href="#cb48-45"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="dt">legend.margin =</span> <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/reexports.html">unit</a></span>(<span class="dv">0</span>, <span class="st">"lines"</span>), </span>
<span id="cb48-46"><a href="#cb48-46"></a>        <span class="dt">legend.title =</span> <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span>(),</span>
<span id="cb48-47"><a href="#cb48-47"></a>        <span class="dt">legend.position =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.00</span>, <span class="fl">1.025</span>), </span>
<span id="cb48-48"><a href="#cb48-48"></a>        <span class="dt">legend.background =</span> <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span>(),</span>
<span id="cb48-49"><a href="#cb48-49"></a>               </span>
<span id="cb48-50"><a href="#cb48-50"></a>        <span class="dt">legend.justification =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>, <span class="dv">1</span>), </span>
<span id="cb48-51"><a href="#cb48-51"></a>        <span class="dt">axis.title.y =</span> <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span>(),</span>
<span id="cb48-52"><a href="#cb48-52"></a>        <span class="dt">strip.background =</span> <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span>(<span class="dt">color =</span> <span class="kw"><a href="https://rdrr.io/r/grDevices/gray.html">grey</a></span>(<span class="fl">0.8</span>), <span class="dt">fill =</span> <span class="kw"><a href="https://rdrr.io/r/grDevices/gray.html">grey</a></span>(<span class="fl">0.8</span>)),</span>
<span id="cb48-53"><a href="#cb48-53"></a>        <span class="dt">strip.text =</span> <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(<span class="dt">colour =</span> <span class="st">"white"</span>, <span class="dt">face =</span> <span class="st">"bold"</span>))</span></code></pre></div>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1"></a>p &lt;-<span class="st"> </span></span>
<span id="cb49-2"><a href="#cb49-2"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="ot">NULL</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb49-3"><a href="#cb49-3"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span>(<span class="dt">data =</span> sample_file, </span>
<span id="cb49-4"><a href="#cb49-4"></a>              <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> age_imp, <span class="dt">y =</span> <span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(Net_rent_amt <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>)), </span>
<span id="cb49-5"><a href="#cb49-5"></a>              <span class="dt">colour =</span> <span class="kw"><a href="https://rdrr.io/pkg/viridis/man/reexports.html">viridis</a></span>(<span class="dv">2</span>)[<span class="dv">1</span>], </span>
<span id="cb49-6"><a href="#cb49-6"></a>              <span class="dt">size =</span> <span class="fl">1.2</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb49-7"><a href="#cb49-7"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span>(<span class="dt">data =</span> <span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(sample_file, Gross_rent_amt <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>), </span>
<span id="cb49-8"><a href="#cb49-8"></a>              <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> age_imp, </span>
<span id="cb49-9"><a href="#cb49-9"></a>                  <span class="dt">y =</span> <span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(Net_rent_amt <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>)), </span>
<span id="cb49-10"><a href="#cb49-10"></a>              <span class="dt">colour =</span> <span class="kw"><a href="https://rdrr.io/pkg/viridis/man/reexports.html">viridis</a></span>(<span class="dv">2</span>)[<span class="dv">2</span>], </span>
<span id="cb49-11"><a href="#cb49-11"></a>              <span class="dt">size =</span> <span class="fl">1.2</span>) <span class="op">+</span></span>
<span id="cb49-12"><a href="#cb49-12"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(<span class="dt">label =</span> percent) <span class="op">+</span><span class="st"> </span></span>
<span id="cb49-13"><a href="#cb49-13"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">"Age"</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb49-14"><a href="#cb49-14"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span>(<span class="dt">ylim =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>,<span class="dv">1</span>)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb49-15"><a href="#cb49-15"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="dt">axis.title.y =</span> <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span>()) </span>
<span id="cb49-16"><a href="#cb49-16"></a></span>
<span id="cb49-17"><a href="#cb49-17"></a><span class="cf">if</span> (FY.YEAR <span class="op">==</span><span class="st"> "2013-14"</span>){</span>
<span id="cb49-18"><a href="#cb49-18"></a>  p &lt;-<span class="st"> </span></span>
<span id="cb49-19"><a href="#cb49-19"></a><span class="st">    </span>p <span class="op">+</span><span class="st"> </span></span>
<span id="cb49-20"><a href="#cb49-20"></a><span class="st">    </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span>(<span class="st">"text"</span>, </span>
<span id="cb49-21"><a href="#cb49-21"></a>             <span class="dt">x =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">38</span>, <span class="dv">38</span>), </span>
<span id="cb49-22"><a href="#cb49-22"></a>             <span class="dt">y =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.18</span>, <span class="dt">y =</span> <span class="fl">0.80</span>), </span>
<span id="cb49-23"><a href="#cb49-23"></a>             <span class="dt">label =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"All taxpayers"</span>, <span class="st">"Property investors"</span>), </span>
<span id="cb49-24"><a href="#cb49-24"></a>             <span class="dt">hjust =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.5</span>, <span class="dv">0</span>), </span>
<span id="cb49-25"><a href="#cb49-25"></a>             <span class="dt">colour =</span> <span class="kw"><a href="https://rdrr.io/pkg/viridis/man/reexports.html">viridis</a></span>(<span class="dv">2</span>),</span>
<span id="cb49-26"><a href="#cb49-26"></a>             <span class="dt">fontface =</span> <span class="st">"bold"</span>)</span>
<span id="cb49-27"><a href="#cb49-27"></a>} <span class="cf">else</span> {</span>
<span id="cb49-28"><a href="#cb49-28"></a>  p &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span></span>
<span id="cb49-29"><a href="#cb49-29"></a><span class="st">    </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="dt">legend.position =</span> <span class="st">"right"</span>)</span>
<span id="cb49-30"><a href="#cb49-30"></a>}</span>
<span id="cb49-31"><a href="#cb49-31"></a></span>
<span id="cb49-32"><a href="#cb49-32"></a>p</span></code></pre></div>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1"></a>age_res =<span class="st"> </span><span class="dv">1</span></span>
<span id="cb50-2"><a href="#cb50-2"></a>inc_res =<span class="st"> </span><span class="dv">10000</span></span>
<span id="cb50-3"><a href="#cb50-3"></a></span>
<span id="cb50-4"><a href="#cb50-4"></a>sample_file <span class="op">%&gt;%</span></span>
<span id="cb50-5"><a href="#cb50-5"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">Tot_inc_amt_NoNG =</span> Tot_inc_amt <span class="op">-</span><span class="st"> </span>Net_rent_amt <span class="op">+</span><span class="st"> </span><span class="kw"><a href="../reference/pmaxC.html">pmaxC</a></span>(Net_rent_amt, <span class="dv">0</span>),</span>
<span id="cb50-6"><a href="#cb50-6"></a>         <span class="dt">Taxable_Income_noNG =</span> <span class="kw"><a href="../reference/pmaxC.html">pmaxC</a></span>(Tot_inc_amt_NoNG <span class="op">-</span><span class="st"> </span>Tot_ded_amt <span class="op">-</span><span class="st"> </span>NPP_loss_claimed <span class="op">-</span><span class="st"> </span>PP_loss_claimed, <span class="dv">0</span>),</span>
<span id="cb50-7"><a href="#cb50-7"></a>         <span class="dt">tax_current =</span> <span class="kw"><a href="../reference/income_tax.html">income_tax</a></span>(Taxable_Income, <span class="dt">fy.year =</span> FY.YEAR),</span>
<span id="cb50-8"><a href="#cb50-8"></a>         <span class="dt">tax_noNG =</span> <span class="kw"><a href="../reference/income_tax.html">income_tax</a></span>(Taxable_Income_noNG, <span class="dt">fy.year =</span> FY.YEAR),</span>
<span id="cb50-9"><a href="#cb50-9"></a>         <span class="dt">change =</span> tax_noNG <span class="op">-</span><span class="st"> </span>tax_current) <span class="op">%&gt;%</span></span>
<span id="cb50-10"><a href="#cb50-10"></a><span class="st">  </span></span>
<span id="cb50-11"><a href="#cb50-11"></a><span class="st">  </span><span class="co"># This excludes income losses (barely any anyway)</span></span>
<span id="cb50-12"><a href="#cb50-12"></a><span class="st">  </span><span class="co"># and high income earners</span></span>
<span id="cb50-13"><a href="#cb50-13"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="kw"><a href="https://dplyr.tidyverse.org/reference/between.html">between</a></span>(Tot_inc_amt_NoNG, </span>
<span id="cb50-14"><a href="#cb50-14"></a>                 <span class="dv">0</span>, </span>
<span id="cb50-15"><a href="#cb50-15"></a>                 upper_ylim &lt;&lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(.<span class="op">$</span>Tot_inc_amt_NoNG[.<span class="op">$</span>Tot_inc_amt_NoNG <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>], <span class="dt">probs =</span> <span class="fl">0.95</span>))) <span class="op">%&gt;%</span></span>
<span id="cb50-16"><a href="#cb50-16"></a><span class="st">  </span></span>
<span id="cb50-17"><a href="#cb50-17"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">Age =</span> age_res <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(age_imp <span class="op">/</span><span class="st"> </span>age_res), </span>
<span id="cb50-18"><a href="#cb50-18"></a>         <span class="st">`</span><span class="dt">Total Income (before NG)</span><span class="st">`</span> =<span class="st"> </span>inc_res <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(Tot_inc_amt_NoNG <span class="op">/</span><span class="st"> </span>inc_res)) <span class="op">%&gt;%</span></span>
<span id="cb50-19"><a href="#cb50-19"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(Age, <span class="st">`</span><span class="dt">Total Income (before NG)</span><span class="st">`</span>) <span class="op">%&gt;%</span></span>
<span id="cb50-20"><a href="#cb50-20"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span>(<span class="dt">n_NG =</span> <span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>((Net_rent_amt <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">*</span><span class="st"> </span>WEIGHT), </span>
<span id="cb50-21"><a href="#cb50-21"></a>            <span class="dt">prop_NG =</span> <span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(Net_rent_amt <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>),</span>
<span id="cb50-22"><a href="#cb50-22"></a>            <span class="dt">tot_tax_benefit =</span> <span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(change <span class="op">*</span><span class="st"> </span>WEIGHT), </span>
<span id="cb50-23"><a href="#cb50-23"></a>            <span class="dt">avg_tax_benefit =</span> <span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(change)) <span class="op">%&gt;%</span><span class="st"> </span>ungroup <span class="op">%&gt;%</span><span class="st">  </span></span>
<span id="cb50-24"><a href="#cb50-24"></a><span class="st">  </span></span>
<span id="cb50-25"><a href="#cb50-25"></a><span class="st">  </span></span>
<span id="cb50-26"><a href="#cb50-26"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> Age, <span class="dt">y =</span> <span class="st">`</span><span class="dt">Total Income (before NG)</span><span class="st">`</span>, <span class="dt">fill =</span> prop_NG)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb50-27"><a href="#cb50-27"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_bin2d.html">geom_bin2d</a></span>(<span class="dt">stat =</span> <span class="st">"identity"</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb50-28"><a href="#cb50-28"></a><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/viridis/man/scale_viridis.html">scale_fill_viridis</a></span>(<span class="st">"% NG"</span>, <span class="dt">labels =</span> percent) <span class="op">+</span><span class="st"> </span></span>
<span id="cb50-29"><a href="#cb50-29"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(<span class="dt">expand =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>,<span class="dv">0</span>), <span class="dt">label =</span> grattan_dollar) <span class="op">+</span><span class="st"> </span></span>
<span id="cb50-30"><a href="#cb50-30"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span>(<span class="dt">expand =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>,<span class="dv">0</span>)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb50-31"><a href="#cb50-31"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_dark</a></span>() <span class="op">+</span></span>
<span id="cb50-32"><a href="#cb50-32"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="dt">legend.title =</span> <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span>(), </span>
<span id="cb50-33"><a href="#cb50-33"></a>        <span class="dt">plot.margin =</span> <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/reexports.html">unit</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>), <span class="st">"pt"</span>))<span class="co"># %&gt;%</span></span>
<span id="cb50-34"><a href="#cb50-34"></a>  <span class="co">#align_baptiste(.)</span></span></code></pre></div>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1"></a>age_res =<span class="st"> </span><span class="dv">1</span></span>
<span id="cb51-2"><a href="#cb51-2"></a>inc_res =<span class="st"> </span><span class="dv">10000</span></span>
<span id="cb51-3"><a href="#cb51-3"></a></span>
<span id="cb51-4"><a href="#cb51-4"></a>sample_file <span class="op">%&gt;%</span></span>
<span id="cb51-5"><a href="#cb51-5"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">Tot_inc_amt_NoNG =</span> Tot_inc_amt <span class="op">-</span><span class="st"> </span>Net_rent_amt <span class="op">+</span><span class="st"> </span><span class="kw"><a href="../reference/pmaxC.html">pmaxC</a></span>(Net_rent_amt, <span class="dv">0</span>),</span>
<span id="cb51-6"><a href="#cb51-6"></a>         <span class="dt">Taxable_Income_noNG =</span> <span class="kw"><a href="../reference/pmaxC.html">pmaxC</a></span>(Tot_inc_amt_NoNG <span class="op">-</span><span class="st"> </span>Tot_ded_amt <span class="op">-</span><span class="st"> </span>NPP_loss_claimed <span class="op">-</span><span class="st"> </span>PP_loss_claimed, <span class="dv">0</span>),</span>
<span id="cb51-7"><a href="#cb51-7"></a>         <span class="dt">tax_current =</span> <span class="kw"><a href="../reference/income_tax.html">income_tax</a></span>(Taxable_Income, <span class="dt">fy.year =</span> FY.YEAR),</span>
<span id="cb51-8"><a href="#cb51-8"></a>         <span class="dt">tax_noNG =</span> <span class="kw"><a href="../reference/income_tax.html">income_tax</a></span>(Taxable_Income_noNG, <span class="dt">fy.year =</span> FY.YEAR),</span>
<span id="cb51-9"><a href="#cb51-9"></a>         <span class="dt">change =</span> tax_noNG <span class="op">-</span><span class="st"> </span>tax_current) <span class="op">%&gt;%</span></span>
<span id="cb51-10"><a href="#cb51-10"></a><span class="st">  </span></span>
<span id="cb51-11"><a href="#cb51-11"></a><span class="st">  </span><span class="co"># This excludes income losses (barely any anyway)</span></span>
<span id="cb51-12"><a href="#cb51-12"></a><span class="st">  </span><span class="co"># and high income earners</span></span>
<span id="cb51-13"><a href="#cb51-13"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="kw"><a href="https://dplyr.tidyverse.org/reference/between.html">between</a></span>(Tot_inc_amt_NoNG, </span>
<span id="cb51-14"><a href="#cb51-14"></a>                 <span class="dv">0</span>, </span>
<span id="cb51-15"><a href="#cb51-15"></a>                 upper_ylim &lt;&lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(.<span class="op">$</span>Tot_inc_amt_NoNG[.<span class="op">$</span>Tot_inc_amt_NoNG <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>], <span class="dt">probs =</span> <span class="fl">0.95</span>))) <span class="op">%&gt;%</span></span>
<span id="cb51-16"><a href="#cb51-16"></a><span class="st">  </span></span>
<span id="cb51-17"><a href="#cb51-17"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">Age =</span> age_res <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(age_imp <span class="op">/</span><span class="st"> </span>age_res), </span>
<span id="cb51-18"><a href="#cb51-18"></a>         <span class="st">`</span><span class="dt">Total Income (before NG)</span><span class="st">`</span> =<span class="st"> </span>inc_res <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(Tot_inc_amt_NoNG <span class="op">/</span><span class="st"> </span>inc_res)) <span class="op">%&gt;%</span></span>
<span id="cb51-19"><a href="#cb51-19"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(Age, <span class="st">`</span><span class="dt">Total Income (before NG)</span><span class="st">`</span>) <span class="op">%&gt;%</span></span>
<span id="cb51-20"><a href="#cb51-20"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span>(<span class="dt">n_NG =</span> <span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>((Net_rent_amt <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">*</span><span class="st"> </span>WEIGHT), </span>
<span id="cb51-21"><a href="#cb51-21"></a>            <span class="dt">prop_NG =</span> <span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(Net_rent_amt <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>),</span>
<span id="cb51-22"><a href="#cb51-22"></a>            <span class="dt">tot_tax_benefit =</span> <span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(change <span class="op">*</span><span class="st"> </span>WEIGHT), </span>
<span id="cb51-23"><a href="#cb51-23"></a>            <span class="dt">avg_tax_benefit =</span> <span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(change)) <span class="op">%&gt;%</span><span class="st"> </span>ungroup <span class="op">%&gt;%</span><span class="st">  </span></span>
<span id="cb51-24"><a href="#cb51-24"></a><span class="st">  </span></span>
<span id="cb51-25"><a href="#cb51-25"></a><span class="st">  </span></span>
<span id="cb51-26"><a href="#cb51-26"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> Age, <span class="dt">y =</span> <span class="st">`</span><span class="dt">Total Income (before NG)</span><span class="st">`</span>, <span class="dt">fill =</span> avg_tax_benefit)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb51-27"><a href="#cb51-27"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_bin2d.html">geom_bin2d</a></span>(<span class="dt">stat =</span> <span class="st">"identity"</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb51-28"><a href="#cb51-28"></a><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/viridis/man/scale_viridis.html">scale_fill_viridis</a></span>(<span class="st">"Tax benefit"</span>, <span class="dt">labels =</span> grattan_dollar) <span class="op">+</span><span class="st"> </span></span>
<span id="cb51-29"><a href="#cb51-29"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(<span class="dt">expand =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>,<span class="dv">0</span>), <span class="dt">label =</span> grattan_dollar) <span class="op">+</span><span class="st"> </span></span>
<span id="cb51-30"><a href="#cb51-30"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span>(<span class="dt">expand =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>,<span class="dv">0</span>)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb51-31"><a href="#cb51-31"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_dark</a></span>() <span class="op">+</span></span>
<span id="cb51-32"><a href="#cb51-32"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="dt">legend.title =</span> <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span>())</span></code></pre></div>
</div>
</div>
<div id="differential-uprating" class="section level1">
<h1 class="hasAnchor">
<a href="#differential-uprating" class="anchor"></a>Differential uprating</h1>
<p>Since the most recent versions of data detailing population income and wealth (as is contained within the ATO’s sample files) is typically years out-of-date on release, even understanding the present requires a forecast. Since most variables relating to income increase due to inflation – so any sensible forecast will increase the values relative to the past – this procedure is often called <strong>uprating</strong>.</p>
<div id="basic-uprating" class="section level2">
<h2 class="hasAnchor">
<a href="#basic-uprating" class="anchor"></a>Basic uprating</h2>
<p>The most basic uprate method is the identity function, where the variables are not changed.</p>
<p>Alternatively, the variables can be increased by a long-term inflation rate. Even better, we can use the relevant time series indices for the variables and inflate using that index. For instance, salary and wage variables can be increased by the observed increase in the wage price index amd growth in the population of taxpayers by the labour force index.</p>
</div>
<div id="differential-uprating-1" class="section level2">
<h2 class="hasAnchor">
<a href="#differential-uprating-1" class="anchor"></a>Differential uprating</h2>
<p>Basic uprating suffers some limitations. There are significant structural differences in how much individuals’ incomes grow. High-income individuals tend to have higher than average wage growth. Low-income individuals also have higher than average wage growth. That is, the pattern of wage growth by wage is U-shaped.</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1"></a>wage_r_by_fy &lt;-<span class="st"> </span></span>
<span id="cb52-2"><a href="#cb52-2"></a><span class="st">  </span><span class="kw"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span>(<span class="dt">fy.year =</span> <span class="kw"><a href="../reference/is.fy.html">yr2fy</a></span>(<span class="dv">2005</span><span class="op">:</span><span class="dv">2014</span>)) <span class="op">%&gt;%</span></span>
<span id="cb52-3"><a href="#cb52-3"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">lag_fy =</span> <span class="kw"><a href="../reference/is.fy.html">yr2fy</a></span>(<span class="dv">2004</span><span class="op">:</span><span class="dv">2013</span>)) <span class="op">%&gt;%</span></span>
<span id="cb52-4"><a href="#cb52-4"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">wage_growth_r =</span> <span class="kw"><a href="../reference/wage_inflator.html">wage_inflator</a></span>(<span class="dt">from_fy =</span> lag_fy, <span class="dt">to_fy =</span> fy.year) <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)</span></code></pre></div>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1"></a>average_salary_by_fy_swtile &lt;-<span class="st"> </span></span>
<span id="cb53-2"><a href="#cb53-2"></a><span class="st">  </span>sample_files_all <span class="op">%&gt;%</span></span>
<span id="cb53-3"><a href="#cb53-3"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(fy.year, Sw_amt) <span class="op">%&gt;%</span></span>
<span id="cb53-4"><a href="#cb53-4"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(Sw_amt <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span></span>
<span id="cb53-5"><a href="#cb53-5"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(fy.year) <span class="op">%&gt;%</span></span>
<span id="cb53-6"><a href="#cb53-6"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="st">`</span><span class="dt">Salary percentile</span><span class="st">`</span> =<span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/ranking.html">ntile</a></span>(Sw_amt, <span class="dv">100</span>)) <span class="op">%&gt;%</span></span>
<span id="cb53-7"><a href="#cb53-7"></a><span class="st">  </span>ungroup <span class="op">%&gt;%</span></span>
<span id="cb53-8"><a href="#cb53-8"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(fy.year, <span class="st">`</span><span class="dt">Salary percentile</span><span class="st">`</span>) <span class="op">%&gt;%</span></span>
<span id="cb53-9"><a href="#cb53-9"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span>(<span class="dt">average_salary =</span> <span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(Sw_amt)) <span class="op">%&gt;%</span></span>
<span id="cb53-10"><a href="#cb53-10"></a><span class="st">  </span>ungroup <span class="op">%&gt;%</span></span>
<span id="cb53-11"><a href="#cb53-11"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(<span class="st">`</span><span class="dt">Salary percentile</span><span class="st">`</span>, fy.year) <span class="op">%&gt;%</span></span>
<span id="cb53-12"><a href="#cb53-12"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(<span class="st">`</span><span class="dt">Salary percentile</span><span class="st">`</span>) <span class="op">%&gt;%</span></span>
<span id="cb53-13"><a href="#cb53-13"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">r_average_salary =</span> average_salary <span class="op">/</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span>(average_salary) <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span></span>
<span id="cb53-14"><a href="#cb53-14"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(fy.year <span class="op">!=</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(fy.year))</span>
<span id="cb53-15"><a href="#cb53-15"></a></span>
<span id="cb53-16"><a href="#cb53-16"></a>{</span>
<span id="cb53-17"><a href="#cb53-17"></a>  p &lt;-<span class="st"> </span></span>
<span id="cb53-18"><a href="#cb53-18"></a><span class="st">    </span>average_salary_by_fy_swtile <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># NA</span></span>
<span id="cb53-19"><a href="#cb53-19"></a><span class="st">    </span>ungroup <span class="op">%&gt;%</span></span>
<span id="cb53-20"><a href="#cb53-20"></a><span class="st">    </span><span class="kw"><a href="https://Rdatatable.gitlab.io/data.table/reference/merge.html">merge</a></span>(wage_r_by_fy, <span class="dt">by =</span> <span class="st">"fy.year"</span>) <span class="op">%&gt;%</span></span>
<span id="cb53-21"><a href="#cb53-21"></a><span class="st">    </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="st">`</span><span class="dt">Basic wage inflator</span><span class="st">`</span> =<span class="st"> "Basic wage inflator"</span>) <span class="op">%&gt;%</span></span>
<span id="cb53-22"><a href="#cb53-22"></a><span class="st">    </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb53-23"><a href="#cb53-23"></a><span class="st">    </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_area</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> <span class="st">`</span><span class="dt">Salary percentile</span><span class="st">`</span>, <span class="dt">y =</span> r_average_salary, <span class="dt">group =</span> fy.year, <span class="dt">fill =</span> fy.year), </span>
<span id="cb53-24"><a href="#cb53-24"></a>              <span class="dt">se =</span> <span class="ot">FALSE</span>, <span class="dt">stat =</span> <span class="st">"smooth"</span>, <span class="dt">method =</span> <span class="st">"loess"</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb53-25"><a href="#cb53-25"></a><span class="st">    </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb53-26"><a href="#cb53-26"></a><span class="st">    </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="dt">legend.position =</span> <span class="st">"right"</span>, <span class="dt">plot.background =</span> <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span>()) <span class="op">+</span><span class="st"> </span></span>
<span id="cb53-27"><a href="#cb53-27"></a><span class="st">    </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> <span class="st">`</span><span class="dt">Salary percentile</span><span class="st">`</span>, <span class="dt">y =</span> wage_growth_r, <span class="dt">group =</span> <span class="st">`</span><span class="dt">Basic wage inflator</span><span class="st">`</span>, <span class="dt">color =</span> <span class="st">`</span><span class="dt">Basic wage inflator</span><span class="st">`</span>),</span>
<span id="cb53-28"><a href="#cb53-28"></a>              <span class="dt">size =</span> <span class="fl">1.125</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb53-29"><a href="#cb53-29"></a><span class="st">    </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span>(<span class="dt">values =</span> <span class="st">"black"</span>) <span class="op">+</span></span>
<span id="cb53-30"><a href="#cb53-30"></a><span class="st">    </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(<span class="dt">name =</span> <span class="st">"Salary rate of increase"</span>, <span class="dt">label =</span> percent) <span class="op">+</span><span class="st"> </span></span>
<span id="cb53-31"><a href="#cb53-31"></a><span class="st">    </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(<span class="op">~</span>fy.year, <span class="dt">ncol =</span> <span class="dv">5</span>) <span class="op">+</span></span>
<span id="cb53-32"><a href="#cb53-32"></a><span class="st">    </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span>(<span class="dt">fill =</span> <span class="ot">FALSE</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb53-33"><a href="#cb53-33"></a><span class="st">    </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="dt">legend.position =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>, <span class="dv">1</span>), </span>
<span id="cb53-34"><a href="#cb53-34"></a>          <span class="dt">legend.title =</span> <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span>(), </span>
<span id="cb53-35"><a href="#cb53-35"></a>          <span class="dt">legend.key =</span> <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span>(),</span>
<span id="cb53-36"><a href="#cb53-36"></a>          <span class="dt">legend.justification =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb53-37"><a href="#cb53-37"></a>  </span>
<span id="cb53-38"><a href="#cb53-38"></a>  <span class="co"># ggplotly(p)</span></span>
<span id="cb53-39"><a href="#cb53-39"></a>  p</span>
<span id="cb53-40"><a href="#cb53-40"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1"></a>differential_uprates &lt;-<span class="st"> </span></span>
<span id="cb54-2"><a href="#cb54-2"></a><span class="st">  </span>average_salary_by_fy_swtile <span class="op">%&gt;%</span></span>
<span id="cb54-3"><a href="#cb54-3"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(<span class="st">`</span><span class="dt">Salary percentile</span><span class="st">`</span>) <span class="op">%&gt;%</span></span>
<span id="cb54-4"><a href="#cb54-4"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span>(<span class="dt">avg_r =</span> <span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(r_average_salary)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb54-5"><a href="#cb54-5"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">avg_r_normed =</span> avg_r <span class="op">/</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(avg_r))</span>
<span id="cb54-6"><a href="#cb54-6"></a></span>
<span id="cb54-7"><a href="#cb54-7"></a>differential_uprates <span class="op">%&gt;%</span></span>
<span id="cb54-8"><a href="#cb54-8"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> <span class="st">`</span><span class="dt">Salary percentile</span><span class="st">`</span>, <span class="dt">y =</span> avg_r)) <span class="op">+</span></span>
<span id="cb54-9"><a href="#cb54-9"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb54-10"><a href="#cb54-10"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(<span class="dt">label =</span> percent)</span></code></pre></div>
<p><strong>Differential uprating</strong> is a method by which variables are uprated by a function of not only the time period and the type of variable, but of the variable’s value too. To differentially uprate salary, use <code>differentially_uprate_wage</code>:</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1"></a><span class="kw"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span>(<span class="dt">wage =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">20e3</span>, <span class="fl">50e3</span>, <span class="fl">100e3</span>)) <span class="op">%&gt;%</span></span>
<span id="cb55-2"><a href="#cb55-2"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">ordinary =</span> <span class="kw"><a href="../reference/wage_inflator.html">wage_inflator</a></span>(wage, <span class="dt">from_fy =</span> <span class="st">"2012-13"</span>, <span class="dt">to_fy =</span> <span class="st">"2013-14"</span>), </span>
<span id="cb55-3"><a href="#cb55-3"></a>         <span class="st">`</span><span class="dt">change ordinary</span><span class="st">`</span> =<span class="st"> </span>ordinary <span class="op">/</span><span class="st"> </span>wage <span class="op">-</span><span class="st"> </span><span class="dv">1</span>, </span>
<span id="cb55-4"><a href="#cb55-4"></a>         <span class="dt">differential =</span> <span class="kw"><a href="../reference/differentially_uprate_wage.html">differentially_uprate_wage</a></span>(wage, <span class="dt">from_fy =</span> <span class="st">"2012-13"</span>, <span class="dt">to_fy =</span> <span class="st">"2013-14"</span>), </span>
<span id="cb55-5"><a href="#cb55-5"></a>         <span class="st">`</span><span class="dt">change differential</span><span class="st">`</span> =<span class="st"> </span>differential <span class="op">/</span><span class="st"> </span>wage <span class="op">-</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb55-6"><a href="#cb55-6"></a>         ) <span class="op">%&gt;%</span></span>
<span id="cb55-7"><a href="#cb55-7"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">wage =</span> <span class="kw"><a href="https://scales.r-lib.org//reference/dollar_format.html">dollar</a></span>(wage),</span>
<span id="cb55-8"><a href="#cb55-8"></a>         <span class="dt">ordinary =</span> <span class="kw"><a href="https://scales.r-lib.org//reference/dollar_format.html">dollar</a></span>(ordinary), </span>
<span id="cb55-9"><a href="#cb55-9"></a>         <span class="dt">differential =</span> <span class="kw"><a href="https://scales.r-lib.org//reference/dollar_format.html">dollar</a></span>(differential), </span>
<span id="cb55-10"><a href="#cb55-10"></a>         <span class="st">`</span><span class="dt">change ordinary</span><span class="st">`</span> =<span class="st"> </span><span class="kw"><a href="https://scales.r-lib.org//reference/number_format.html">percent</a></span>(<span class="st">`</span><span class="dt">change ordinary</span><span class="st">`</span>), </span>
<span id="cb55-11"><a href="#cb55-11"></a>         <span class="st">`</span><span class="dt">change differential</span><span class="st">`</span> =<span class="st"> </span><span class="kw"><a href="https://scales.r-lib.org//reference/number_format.html">percent</a></span>(<span class="st">`</span><span class="dt">change differential</span><span class="st">`</span>)) <span class="op">%&gt;%</span></span>
<span id="cb55-12"><a href="#cb55-12"></a><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>(<span class="dt">align =</span> <span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="st">"r"</span>, <span class="kw"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(.)))</span></code></pre></div>
<p>Note that <code>differentially_update_wage</code> uses the 2003-04 to 2013-14 sample files to generate estimates of the shape of the U. So applying the function to any other vector may have surprising results. In particular, the distribution of the vector provided is not considered. Furthermore, the <code>from_fy</code> must be in the range <code>2003-04</code> to <code>2013-14</code>.</p>
</div>
</div>
<div id="modelling-superannuation-changes" class="section level1">
<h1 class="hasAnchor">
<a href="#modelling-superannuation-changes" class="anchor"></a>Modelling superannuation changes</h1>
<div id="introduction-1" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction-1" class="anchor"></a>Introduction</h2>
<p>Australia’s superannuation system offers a number of tax breaks. Relative to most methods of savings, less tax is paid on money contributed to a super fund, and less tax is paid on the earnings. The functions described here attempt to model changes to tax breaks on money contributed to a super fund.</p>
</div>
<div id="modelling" class="section level2">
<h2 class="hasAnchor">
<a href="#modelling" class="anchor"></a>Modelling</h2>
<div id="the-basic-functions" class="section level3">
<h3 class="hasAnchor">
<a href="#the-basic-functions" class="anchor"></a>The basic functions</h3>
<p>The two tax methods modelled are <strong>Superannuation contributions tax concessions</strong> and <strong>Division 293 tax</strong>. The two main outputs are: the extra tax payable by a particular individual (and the symmetric extra revenue), and the number of individuals affected.</p>
<p>To obtain these results (say for 2017-18)</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(grattan)</span>
<span id="cb56-2"><a href="#cb56-2"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(data.table)</span>
<span id="cb56-3"><a href="#cb56-3"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(magrittr)</span>
<span id="cb56-4"><a href="#cb56-4"></a><span class="co">#' dollar scales</span></span>
<span id="cb56-5"><a href="#cb56-5"></a><span class="co">#' </span></span>
<span id="cb56-6"><a href="#cb56-6"></a><span class="co">#' @name grattan_dollar</span></span>
<span id="cb56-7"><a href="#cb56-7"></a><span class="co">#' @param x A numeric vector</span></span>
<span id="cb56-8"><a href="#cb56-8"></a><span class="co">#' @param digits Minimum number of digits after the decimal point. (\code{nsmall} in \code{base::format}).</span></span>
<span id="cb56-9"><a href="#cb56-9"></a><span class="co">#' @details Makes negative numbers appear as \eqn{-\$10,000} instead of \eqn{\$-10,000} in \code{scales::dollar}.</span></span>
<span id="cb56-10"><a href="#cb56-10"></a><span class="co">#' @export</span></span>
<span id="cb56-11"><a href="#cb56-11"></a><span class="co"># from scales</span></span>
<span id="cb56-12"><a href="#cb56-12"></a></span>
<span id="cb56-13"><a href="#cb56-13"></a>grattan_dollar &lt;-<span class="st"> </span><span class="cf">function</span> (x, <span class="dt">digits =</span> <span class="dv">0</span>) {</span>
<span id="cb56-14"><a href="#cb56-14"></a>  <span class="co">#</span></span>
<span id="cb56-15"><a href="#cb56-15"></a>  nsmall &lt;-<span class="st"> </span>digits</span>
<span id="cb56-16"><a href="#cb56-16"></a>  commaz &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/format.html">format</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(x), <span class="dt">nsmall =</span> nsmall, <span class="dt">trim =</span> <span class="ot">TRUE</span>, <span class="dt">big.mark =</span> <span class="st">","</span>, </span>
<span id="cb56-17"><a href="#cb56-17"></a>                   <span class="dt">scientific =</span> <span class="ot">FALSE</span>, <span class="dt">digits =</span> 1L)</span>
<span id="cb56-18"><a href="#cb56-18"></a>  </span>
<span id="cb56-19"><a href="#cb56-19"></a>  hutils<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/hutils/man/if_else.html">if_else</a></span>(x <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>, </span>
<span id="cb56-20"><a href="#cb56-20"></a>          <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"\U2212"</span>,<span class="st">"$"</span>, commaz),</span>
<span id="cb56-21"><a href="#cb56-21"></a>          <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"$"</span>, commaz))</span>
<span id="cb56-22"><a href="#cb56-22"></a>}</span>
<span id="cb56-23"><a href="#cb56-23"></a></span>
<span id="cb56-24"><a href="#cb56-24"></a>(new_revenue &lt;-<span class="st"> </span></span>
<span id="cb56-25"><a href="#cb56-25"></a><span class="st">  </span>sample_file_<span class="dv">1314</span> <span class="op">%&gt;%</span></span>
<span id="cb56-26"><a href="#cb56-26"></a><span class="st">  </span><span class="kw"><a href="../reference/project_to.html">project_to</a></span>(<span class="dt">to_fy =</span> <span class="st">"2017-18"</span>) <span class="op">%&gt;%</span></span>
<span id="cb56-27"><a href="#cb56-27"></a><span class="st">  </span>as.data.table <span class="op">%&gt;%</span></span>
<span id="cb56-28"><a href="#cb56-28"></a><span class="st">  </span><span class="kw"><a href="../reference/model_new_caps_and_div293.html">revenue_from_new_cap_and_div293</a></span>(<span class="dt">new_cap =</span> <span class="fl">25e3</span>, <span class="dt">fy.year =</span> <span class="st">"2016-17"</span>, <span class="dt">new_age_based_cap =</span> <span class="ot">FALSE</span>, <span class="dt">new_div293_threshold =</span> <span class="fl">250e3</span>))</span>
<span id="cb56-29"><a href="#cb56-29"></a></span>
<span id="cb56-30"><a href="#cb56-30"></a><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="kw">grattan_dollar</span>(new_revenue <span class="op">/</span><span class="st"> </span><span class="fl">1e9</span>), <span class="st">"bn"</span>)</span>
<span id="cb56-31"><a href="#cb56-31"></a></span>
<span id="cb56-32"><a href="#cb56-32"></a>(n_affected &lt;-</span>
<span id="cb56-33"><a href="#cb56-33"></a><span class="st">  </span>sample_file_<span class="dv">1314</span> <span class="op">%&gt;%</span></span>
<span id="cb56-34"><a href="#cb56-34"></a><span class="st">  </span><span class="kw"><a href="../reference/project_to.html">project_to</a></span>(<span class="dt">to_fy =</span> <span class="st">"2017-18"</span>) <span class="op">%&gt;%</span></span>
<span id="cb56-35"><a href="#cb56-35"></a><span class="st">  </span>as.data.table <span class="op">%&gt;%</span></span>
<span id="cb56-36"><a href="#cb56-36"></a><span class="st">  </span><span class="kw"><a href="../reference/model_new_caps_and_div293.html">n_affected_from_new_cap_and_div293</a></span>(<span class="dt">new_cap =</span> <span class="fl">25e3</span>, <span class="dt">fy.year =</span> <span class="st">"2016-17"</span>, <span class="dt">new_age_based_cap =</span> <span class="ot">FALSE</span>, <span class="dt">new_div293_threshold =</span> <span class="fl">250e3</span>))</span>
<span id="cb56-37"><a href="#cb56-37"></a></span>
<span id="cb56-38"><a href="#cb56-38"></a><span class="kw"><a href="https://rdrr.io/r/base/formatc.html">prettyNum</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(n_affected), <span class="dt">big.mark =</span> <span class="st">","</span>)</span></code></pre></div>
<p>Notes:</p>
<ol style="list-style-type: decimal">
<li>
<code>fy.year</code> refers to the year the function takes the tax scales from, not the forecast year. Because we don’t have tax scales for 2017-18 yet, we model using the most recent (<code>2017-18</code>).</li>
<li>The functions require their inputs to be <code>data.table</code>s. Sorry if you don’t like <code>data.table</code>s.</li>
<li>You must use <code>sample_file_1314</code> (because they have superannuation contributions variables).</li>
</ol>
</div>
<div id="distributional-analysis" class="section level3">
<h3 class="hasAnchor">
<a href="#distributional-analysis" class="anchor"></a>Distributional analysis</h3>
<div id="by-taxable-income-decile" class="section level4">
<h4 class="hasAnchor">
<a href="#by-taxable-income-decile" class="anchor"></a>By taxable income decile</h4>
<p>Let’s create an object for <code>sample_file_1718</code> avoid recreating it every time:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1"></a>sample_file_<span class="dv">1718</span> &lt;-</span>
<span id="cb57-2"><a href="#cb57-2"></a><span class="st">  </span>sample_file_<span class="dv">1314</span> <span class="op">%&gt;%</span></span>
<span id="cb57-3"><a href="#cb57-3"></a><span class="st">  </span><span class="kw"><a href="../reference/project_to.html">project_to</a></span>(<span class="dt">to_fy =</span> <span class="st">"2017-18"</span>) <span class="op">%&gt;%</span></span>
<span id="cb57-4"><a href="#cb57-4"></a><span class="st">  </span>as.data.table</span></code></pre></div>
<p>The functions mentioned earlier return single values. In contrast, <code>model_new_caps_and_div293</code> returns the sample file with extra variables, which can then be analyzed as a standard sample file. The variables of note are <code>prv_revenue</code> which is the tax payable under the old system, and <code>new_revenue</code> which is the tax payable under the proposed system. Thus:</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1"></a>new_sample_file_<span class="dv">1718</span> &lt;-<span class="st"> </span></span>
<span id="cb58-2"><a href="#cb58-2"></a><span class="st">  </span>sample_file_<span class="dv">1718</span> <span class="op">%&gt;%</span></span>
<span id="cb58-3"><a href="#cb58-3"></a><span class="st">  </span><span class="kw"><a href="../reference/model_new_caps_and_div293.html">model_new_caps_and_div293</a></span>(<span class="dt">new_cap =</span> <span class="fl">25e3</span>, <span class="dt">fy.year =</span> <span class="st">"2016-17"</span>, <span class="dt">new_age_based_cap =</span> <span class="ot">FALSE</span>, <span class="dt">new_div293_threshold =</span> <span class="fl">250e3</span>)</span></code></pre></div>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(knitr)</span>
<span id="cb59-2"><a href="#cb59-2"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(dplyr)</span>
<span id="cb59-3"><a href="#cb59-3"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(dtplyr)  <span class="co"># for data.table</span></span>
<span id="cb59-4"><a href="#cb59-4"></a></span>
<span id="cb59-5"><a href="#cb59-5"></a>new_sample_file_<span class="dv">1718</span> <span class="op">%&gt;%</span></span>
<span id="cb59-6"><a href="#cb59-6"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">Taxable_Income_decile =</span> <span class="kw"><a href="https://dplyr.tidyverse.org/reference/ranking.html">ntile</a></span>(Taxable_Income, <span class="dv">10</span>)) <span class="op">%&gt;%</span></span>
<span id="cb59-7"><a href="#cb59-7"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(Taxable_Income_decile) <span class="op">%&gt;%</span></span>
<span id="cb59-8"><a href="#cb59-8"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span>(<span class="st">`</span><span class="dt">Average increase in tax</span><span class="st">`</span> =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(new_revenue <span class="op">-</span><span class="st"> </span>prv_revenue), <span class="dv">2</span>)) <span class="op">%&gt;%</span></span>
<span id="cb59-9"><a href="#cb59-9"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(Taxable_Income_decile) <span class="op">%&gt;%</span></span>
<span id="cb59-10"><a href="#cb59-10"></a><span class="st">  </span>kable</span></code></pre></div>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(ggplot2)</span>
<span id="cb60-2"><a href="#cb60-2"></a>new_sample_file_<span class="dv">1718</span> <span class="op">%&gt;%</span></span>
<span id="cb60-3"><a href="#cb60-3"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">Taxable_Income_decile =</span> <span class="kw"><a href="https://dplyr.tidyverse.org/reference/ranking.html">ntile</a></span>(Taxable_Income, <span class="dv">10</span>)) <span class="op">%&gt;%</span></span>
<span id="cb60-4"><a href="#cb60-4"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(Taxable_Income_decile) <span class="op">%&gt;%</span></span>
<span id="cb60-5"><a href="#cb60-5"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span>(<span class="st">`</span><span class="dt">Average increase in tax</span><span class="st">`</span> =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(new_revenue <span class="op">-</span><span class="st"> </span>prv_revenue)) <span class="op">%&gt;%</span></span>
<span id="cb60-6"><a href="#cb60-6"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(Taxable_Income_decile) <span class="op">%&gt;%</span></span>
<span id="cb60-7"><a href="#cb60-7"></a><span class="st">  </span><span class="co">#</span></span>
<span id="cb60-8"><a href="#cb60-8"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="st">`</span><span class="dt">Taxable income decile</span><span class="st">`</span> =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(Taxable_Income_decile)) <span class="op">%&gt;%</span></span>
<span id="cb60-9"><a href="#cb60-9"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> <span class="st">`</span><span class="dt">Taxable income decile</span><span class="st">`</span>, <span class="dt">y =</span> <span class="st">`</span><span class="dt">Average increase in tax</span><span class="st">`</span>)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb60-10"><a href="#cb60-10"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="dt">stat =</span> <span class="st">"identity"</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb60-11"><a href="#cb60-11"></a><span class="st">  </span></span>
<span id="cb60-12"><a href="#cb60-12"></a><span class="st">  </span><span class="co"># cosmetic:</span></span>
<span id="cb60-13"><a href="#cb60-13"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(<span class="dt">label =</span> grattan_dollar) <span class="op">+</span><span class="st"> </span></span>
<span id="cb60-14"><a href="#cb60-14"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="dt">axis.title.y =</span> <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(<span class="dt">face =</span> <span class="st">"bold"</span>, <span class="dt">angle =</span> <span class="dv">90</span>, <span class="dt">margin =</span> <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/element.html">margin</a></span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="st">"lines"</span>)))</span></code></pre></div>
</div>
</div>
</div>
</div>
<div id="performance-of-project" class="section level1">
<h1 class="hasAnchor">
<a href="#performance-of-project" class="anchor"></a>Performance of project</h1>
<p>To test the performance of our projection, we consider the projection of the 2012-13 sample file by one year with the actual 2013-14 sample file.</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1"></a>sample_file_<span class="dv">1314</span>_projected &lt;-<span class="st"> </span></span>
<span id="cb61-2"><a href="#cb61-2"></a><span class="st">  </span>sample_file_<span class="dv">1213</span> <span class="op">%&gt;%</span></span>
<span id="cb61-3"><a href="#cb61-3"></a><span class="st">  </span>copy <span class="op">%&gt;%</span></span>
<span id="cb61-4"><a href="#cb61-4"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">WEIGHT =</span> <span class="dv">50</span>) <span class="op">%&gt;%</span></span>
<span id="cb61-5"><a href="#cb61-5"></a><span class="st">  </span><span class="kw"><a href="../reference/project.html">project</a></span>(<span class="dt">h =</span> 1L,</span>
<span id="cb61-6"><a href="#cb61-6"></a>          <span class="dt">fy.year.of.sample.file =</span> <span class="st">"2012-13"</span>,</span>
<span id="cb61-7"><a href="#cb61-7"></a>          <span class="dt">.recalculate.inflators =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span></span>
<span id="cb61-8"><a href="#cb61-8"></a><span class="st">  </span>.[]</span></code></pre></div>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1"></a><span class="kw"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span>(<span class="dt">the_source =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Actual"</span>,</span>
<span id="cb62-2"><a href="#cb62-2"></a>                          <span class="st">"Projected"</span>),</span>
<span id="cb62-3"><a href="#cb62-3"></a>           <span class="dt">n_persons =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(sample_file_<span class="dv">1314</span>) <span class="op">*</span><span class="st"> </span><span class="dv">50</span>,</span>
<span id="cb62-4"><a href="#cb62-4"></a>                         <span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(sample_file_<span class="dv">1314</span>_projected<span class="op">$</span>WEIGHT)), </span>
<span id="cb62-5"><a href="#cb62-5"></a>           <span class="dt">avg_Taxable_Income =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(sample_file_<span class="dv">1314</span><span class="op">$</span>Taxable_Income),</span>
<span id="cb62-6"><a href="#cb62-6"></a>                                  <span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(sample_file_<span class="dv">1314</span>_projected<span class="op">$</span>Taxable_Income)),</span>
<span id="cb62-7"><a href="#cb62-7"></a>           <span class="dt">avg_Sw =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(sample_file_<span class="dv">1314</span><span class="op">$</span>Sw_amt),</span>
<span id="cb62-8"><a href="#cb62-8"></a>                      <span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(sample_file_<span class="dv">1314</span>_projected<span class="op">$</span>Sw_amt))</span>
<span id="cb62-9"><a href="#cb62-9"></a>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb62-10"><a href="#cb62-10"></a><span class="st">  </span><span class="kw"><a href="https://Rdatatable.gitlab.io/data.table/reference/melt.data.table.html">melt.data.table</a></span>(<span class="dt">id.vars =</span> <span class="st">"the_source"</span>) <span class="op">%&gt;%</span></span>
<span id="cb62-11"><a href="#cb62-11"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(variable) <span class="op">%&gt;%</span></span>
<span id="cb62-12"><a href="#cb62-12"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">value_rel =</span> value <span class="op">/</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/nth.html">first</a></span>(value)) <span class="op">%&gt;%</span></span>
<span id="cb62-13"><a href="#cb62-13"></a><span class="st">  </span><span class="co"># dcast.data.table(variable ~ the_source) %&gt;%</span></span>
<span id="cb62-14"><a href="#cb62-14"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> variable, <span class="dt">y =</span> value_rel, <span class="dt">fill =</span> the_source)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb62-15"><a href="#cb62-15"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="dt">stat =</span> <span class="st">"identity"</span>, <span class="dt">position =</span> <span class="st">"dodge"</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb62-16"><a href="#cb62-16"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_text</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">label =</span> <span class="kw"><a href="https://scales.r-lib.org//reference/number_format.html">comma</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(value))),</span>
<span id="cb62-17"><a href="#cb62-17"></a>            <span class="dt">position =</span> <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html">position_dodge</a></span>(<span class="dt">width =</span> <span class="fl">0.9</span>),</span>
<span id="cb62-18"><a href="#cb62-18"></a>            <span class="dt">hjust =</span> <span class="fl">1.02</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb62-19"><a href="#cb62-19"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb62-20"><a href="#cb62-20"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="dt">legend.position =</span> <span class="st">"top"</span>)</span></code></pre></div>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1"></a>conf_int_of_t.test &lt;-<span class="st"> </span><span class="cf">function</span>(variable){</span>
<span id="cb63-2"><a href="#cb63-2"></a>  t_test &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/t.test.html">t.test</a></span>(sample_file_<span class="dv">1314</span>[[variable]],</span>
<span id="cb63-3"><a href="#cb63-3"></a>                   sample_file_<span class="dv">1314</span>_projected[[variable]])</span>
<span id="cb63-4"><a href="#cb63-4"></a>  </span>
<span id="cb63-5"><a href="#cb63-5"></a>  <span class="kw"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span>(<span class="dt">var =</span> variable,</span>
<span id="cb63-6"><a href="#cb63-6"></a>             <span class="dt">conf.low =</span> t_test<span class="op">$</span>conf.int[<span class="dv">1</span>],</span>
<span id="cb63-7"><a href="#cb63-7"></a>             <span class="dt">conf.high =</span> t_test<span class="op">$</span>conf.int[<span class="dv">2</span>],</span>
<span id="cb63-8"><a href="#cb63-8"></a>             <span class="dt">p.value =</span> t_test<span class="op">$</span>p.value)</span>
<span id="cb63-9"><a href="#cb63-9"></a>}</span>
<span id="cb63-10"><a href="#cb63-10"></a></span>
<span id="cb63-11"><a href="#cb63-11"></a><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Sw_amt"</span>,</span>
<span id="cb63-12"><a href="#cb63-12"></a>  <span class="st">"Net_rent_amt"</span>,</span>
<span id="cb63-13"><a href="#cb63-13"></a>  <span class="st">"Net_CG_amt"</span>,</span>
<span id="cb63-14"><a href="#cb63-14"></a>  <span class="st">"Tot_inc_amt"</span>,</span>
<span id="cb63-15"><a href="#cb63-15"></a>  <span class="st">"Tot_ded_amt"</span>,</span>
<span id="cb63-16"><a href="#cb63-16"></a>  <span class="st">"Taxable_Income"</span>) <span class="op">%&gt;%</span></span>
<span id="cb63-17"><a href="#cb63-17"></a><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(conf_int_of_t.test) <span class="op">%&gt;%</span></span>
<span id="cb63-18"><a href="#cb63-18"></a><span class="st">  </span>rbindlist <span class="op">%&gt;%</span></span>
<span id="cb63-19"><a href="#cb63-19"></a><span class="st">  </span>.[, <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(var, conf.low, conf.high, p.value)] <span class="op">%&gt;%</span></span>
<span id="cb63-20"><a href="#cb63-20"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> var,</span>
<span id="cb63-21"><a href="#cb63-21"></a>             <span class="dt">ymin =</span> conf.low,</span>
<span id="cb63-22"><a href="#cb63-22"></a>             <span class="dt">ymax =</span> conf.high,</span>
<span id="cb63-23"><a href="#cb63-23"></a>             <span class="dt">color =</span> p.value <span class="op">&gt;</span><span class="st"> </span><span class="fl">0.05</span>)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb63-24"><a href="#cb63-24"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html">geom_errorbar</a></span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb63-25"><a href="#cb63-25"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span>(<span class="dt">yintercept =</span> <span class="dv">0</span>)</span></code></pre></div>
<div id="years-not-in-sample-files" class="section level2">
<h2 class="hasAnchor">
<a href="#years-not-in-sample-files" class="anchor"></a>Years not in sample files</h2>
<p>Other tests can be found in the <code>tests/</code> folder to compare the tax collections in those years.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#budget-2018">Budget 2018</a></li>
      <li>
<a href="#bracket-creep">Bracket creep</a><ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      </ul>
</li>
      <li>
<a href="#companion-to-the-2013-14-sample-file">Companion to the 2013-14 sample file</a><ul class="nav nav-pills nav-stacked">
<li><a href="#prologue">Prologue</a></li>
      </ul>
</li>
      <li>
<a href="#differential-uprating">Differential uprating</a><ul class="nav nav-pills nav-stacked">
<li><a href="#basic-uprating">Basic uprating</a></li>
      <li><a href="#differential-uprating-1">Differential uprating</a></li>
      </ul>
</li>
      <li>
<a href="#modelling-superannuation-changes">Modelling superannuation changes</a><ul class="nav nav-pills nav-stacked">
<li><a href="#introduction-1">Introduction</a></li>
      <li><a href="#modelling">Modelling</a></li>
      </ul>
</li>
      <li>
<a href="#performance-of-project">Performance of project</a><ul class="nav nav-pills nav-stacked">
<li><a href="#years-not-in-sample-files">Years not in sample files</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Hugh Parsonage, Tim Cameron, Brendan Coates, Matthew Katzen, William Young, Matt Cowgill.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
