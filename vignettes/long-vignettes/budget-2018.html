<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Hugh Parsonage" />

<meta name="date" content="2018-05-21" />

<title>Budget 2018 modelling</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>



<link rel="stylesheet" href="C:\R\R-3.5.0\library\rmarkdown\rmarkdown\templates\html_vignette\resources\vignette.css" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">Budget 2018 modelling</h1>
<h4 class="author"><em>Hugh Parsonage</em></h4>
<h4 class="date"><em>2018-05-21</em></h4>



<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
## ----loadPackages-1------------------------------------------------------
<span class="kw">library</span>(fastmatch)
<span class="kw">library</span>(ggplot2)
<span class="kw">library</span>(scales)
<span class="kw">library</span>(magrittr)
<span class="kw">library</span>(ggrepel)
<span class="kw">library</span>(viridis)
<span class="co">#&gt; Loading required package: viridisLite</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: &#39;viridis&#39;</span>
<span class="co">#&gt; The following object is masked from &#39;package:scales&#39;:</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     viridis_pal</span>
<span class="kw">library</span>(knitr)
<span class="kw">library</span>(hutils)
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: &#39;hutils&#39;</span>
<span class="co">#&gt; The following object is masked from &#39;package:fastmatch&#39;:</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     coalesce</span>
<span class="kw">library</span>(magrittr)
<span class="kw">library</span>(data.table)
<span class="kw">library</span>(grattanCharts)
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: &#39;grattanCharts&#39;</span>
<span class="co">#&gt; The following object is masked from &#39;package:datasets&#39;:</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     Orange</span>

## ----loadPackages-2------------------------------------------------------
templib &lt;-<span class="st"> </span><span class="kw">tempfile</span>()
hutils<span class="op">::</span><span class="kw">provide.dir</span>(templib)

<span class="co"># ## ----loadPackages-3------------------------------------------------------</span>
<span class="co"># install.packages(&quot;https://raw.githubusercontent.com/hughparsonage/drat/gh-pages/src/contrib/taxstats_0.0.5.1415.tar.gz&quot;,</span>
<span class="co">#                  dependencies = FALSE,</span>
<span class="co">#                  quiet = FALSE,</span>
<span class="co">#                  lib = templib,</span>
<span class="co">#                  verbose = TRUE,</span>
<span class="co">#                  repos = NULL)</span>
<span class="co"># </span>
<span class="co"># ## ----loadPackages-4------------------------------------------------------</span>
<span class="co"># library(&quot;taxstats&quot;,</span>
<span class="co">#         lib.loc = templib,</span>
<span class="co">#         verbose = TRUE,</span>
<span class="co">#         character.only = TRUE)</span>
<span class="kw">library</span>(taxstats)

sample_file_<span class="dv">1415</span> &lt;-<span class="st"> </span>SampleFile1415<span class="op">::</span>sample_file_<span class="dv">1415</span>
sample_file_<span class="dv">1516</span> &lt;-<span class="st"> </span><span class="kw">fread</span>(<span class="st">&quot;~/ozTaxData/data-raw/2016_sample_file.csv&quot;</span>, <span class="dt">logical01 =</span> <span class="ot">FALSE</span>)

## ----sample_files_all----------------------------------------------------
sample_files_all &lt;-
<span class="st">    </span><span class="kw">rbindlist</span>(<span class="kw">lapply</span>(<span class="kw">list</span>(<span class="st">`</span><span class="dt">2003-04</span><span class="st">`</span> =<span class="st"> </span>sample_file_<span class="dv">0304</span>, 
                          <span class="st">`</span><span class="dt">2004-05</span><span class="st">`</span> =<span class="st"> </span>sample_file_<span class="dv">0405</span>,
                          <span class="st">`</span><span class="dt">2005-06</span><span class="st">`</span> =<span class="st"> </span>sample_file_<span class="dv">0506</span>, 
                          <span class="st">`</span><span class="dt">2006-07</span><span class="st">`</span> =<span class="st"> </span>sample_file_<span class="dv">0607</span>,
                          <span class="st">`</span><span class="dt">2007-08</span><span class="st">`</span> =<span class="st"> </span>sample_file_<span class="dv">0708</span>, 
                          <span class="st">`</span><span class="dt">2008-09</span><span class="st">`</span> =<span class="st"> </span>sample_file_<span class="dv">0809</span>,
                          <span class="st">`</span><span class="dt">2009-10</span><span class="st">`</span> =<span class="st"> </span>sample_file_<span class="dv">0910</span>, 
                          <span class="st">`</span><span class="dt">2010-11</span><span class="st">`</span> =<span class="st"> </span>sample_file_<span class="dv">1011</span>,
                          <span class="st">`</span><span class="dt">2011-12</span><span class="st">`</span> =<span class="st"> </span>sample_file_<span class="dv">1112</span>, 
                          <span class="st">`</span><span class="dt">2012-13</span><span class="st">`</span> =<span class="st"> </span>sample_file_<span class="dv">1213</span>,
                          <span class="st">`</span><span class="dt">2013-14</span><span class="st">`</span> =<span class="st"> </span>sample_file_<span class="dv">1314</span>,
                          <span class="st">`</span><span class="dt">2014-15</span><span class="st">`</span> =<span class="st"> </span>sample_file_<span class="dv">1415</span>,
                          <span class="st">`</span><span class="dt">2015-16</span><span class="st">`</span> =<span class="st"> </span>sample_file_<span class="dv">1516</span>), 
                     data.table<span class="op">::</span>as.data.table),
              <span class="dt">use.names =</span> <span class="ot">TRUE</span>,
              <span class="dt">fill =</span> <span class="ot">TRUE</span>, 
              <span class="dt">idcol =</span> <span class="st">&quot;fy.year&quot;</span>)
sample_files_all[, WEIGHT <span class="op">:</span><span class="er">=</span><span class="st"> </span>hutils<span class="op">::</span><span class="kw">if_else</span>(fy.year <span class="op">&gt;</span><span class="st"> &#39;2010-11&#39;</span>, 50L, 100L)]
sample_files_all[<span class="kw">is.na</span>(age_range), age_range <span class="op">:</span><span class="er">=</span><span class="st"> </span>Birth_year]
sample_files_all[<span class="kw">is.na</span>(Othr_pnsn_amt), Othr_pnsn_amt <span class="op">:</span><span class="er">=</span><span class="st"> </span>0L]
sample_files_all[<span class="kw">is.na</span>(Med_Exp_TO_amt), Med_Exp_TO_amt <span class="op">:</span><span class="er">=</span><span class="st"> </span>0L]
sample_files_all[<span class="kw">is.na</span>(Spouse_adjusted_taxable_inc), Spouse_adjusted_taxable_inc <span class="op">:</span><span class="er">=</span><span class="st"> </span>0L]
age_range_decoder &lt;-<span class="st"> </span><span class="kw">as.data.table</span>(age_range_decoder)

## ----load-grattan--------------------------------------------------------
<span class="kw">library</span>(grattan)
<span class="co">#&gt; Last change: NAMESPACE at 2018-05-20 19:27:53 (8 hours ago).</span>

ntile &lt;-<span class="st"> </span><span class="cf">function</span>(x, n) {
  <span class="cf">if</span> (<span class="kw">requireNamespace</span>(<span class="st">&quot;dplyr&quot;</span>, <span class="dt">quietly =</span> <span class="ot">TRUE</span>)) {
    dplyr<span class="op">::</span><span class="kw">ntile</span>(x, n)
  } <span class="cf">else</span> {
    grattan<span class="op">::</span><span class="kw">weighted_ntile</span>(x, <span class="dt">n =</span> n)
  }
}
coalesce &lt;-<span class="st"> </span>hutils<span class="op">::</span>coalesce

sample_files_all[, Taxable_Income_percentile <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">ntile</span>(Taxable_Income, <span class="dv">100</span>)]</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sample_files_all <span class="op">%&gt;%</span>
<span class="st">  </span>.[, tax <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">income_tax</span>(Taxable_Income, <span class="dt">fy.year =</span> .BY[[1L]], <span class="dt">.dots.ATO =</span> .SD), keyby =<span class="st"> &quot;fy.year&quot;</span>] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, avg_tax_rate <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">coalesce</span>(tax <span class="op">/</span><span class="st"> </span>Taxable_Income, <span class="dv">0</span>)]</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">revenue_foregone &lt;-<span class="st"> </span><span class="cf">function</span>(dt, <span class="dt">revenue_positive =</span> <span class="ot">TRUE</span>, <span class="dt">digits =</span> <span class="ot">NULL</span>) {
  out &lt;-<span class="st"> </span>dt[, <span class="kw">sum</span>((<span class="kw">as.integer</span>(new_tax) <span class="op">-</span><span class="st"> </span>baseline_tax) <span class="op">*</span><span class="st"> </span>WEIGHT)]
  <span class="kw">class</span>(out) &lt;-<span class="st"> &quot;revenue_foregone&quot;</span>
  <span class="kw">setattr</span>(out, <span class="st">&quot;digits&quot;</span>, digits)
  out
}

.revenue_foregone &lt;-<span class="st"> </span><span class="cf">function</span>(dt, <span class="dt">revenue_positive =</span> <span class="ot">TRUE</span>, <span class="dt">digits =</span> <span class="ot">NULL</span>) {
  out &lt;-<span class="st"> </span>dt[, <span class="kw">sum</span>((<span class="kw">as.integer</span>(new_tax) <span class="op">-</span><span class="st"> </span>baseline_tax) <span class="op">*</span><span class="st"> </span>WEIGHT)]
  <span class="kw">class</span>(out) &lt;-<span class="st"> &quot;revenue_foregone&quot;</span>
  <span class="kw">setattr</span>(out, <span class="st">&quot;digits&quot;</span>, digits)
  
  <span class="cf">if</span> (<span class="kw">is_knitting</span>()) {
    <span class="kw">return</span>(<span class="kw">print.revenue_foregone</span>(out))
  }
  out
}

print.revenue_foregone &lt;-<span class="st"> </span><span class="cf">function</span>(x, ...) {
  <span class="cf">if</span> (x <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>) {
    pre &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;\u2212&quot;</span>, <span class="cf">if</span> (<span class="kw">is_knitting</span>()) <span class="st">&quot;</span><span class="ch">\\</span><span class="st">$&quot;</span> <span class="cf">else</span> <span class="st">&quot;$&quot;</span>)
    x &lt;-<span class="st"> </span><span class="op">-</span>x
  } <span class="cf">else</span> {
    pre &lt;-<span class="st"> &quot;$&quot;</span>
  }
  d &lt;-<span class="st"> </span><span class="cf">function</span>(default) {
    <span class="cf">if</span> (<span class="kw">is.null</span>(<span class="kw">attr</span>(x, <span class="st">&quot;digits&quot;</span>))) {
      default
    } <span class="cf">else</span> {
      <span class="kw">attr</span>(x, <span class="st">&quot;digits&quot;</span>)
    }
  }
  <span class="cf">if</span> (x <span class="op">&gt;</span><span class="st"> </span><span class="fl">10e9</span>) {
    res &lt;-<span class="st"> </span><span class="kw">paste0</span>(pre, <span class="kw">prettyNum</span>(<span class="kw">round</span>(x <span class="op">/</span><span class="st"> </span><span class="fl">1e9</span>, <span class="kw">d</span>(<span class="dv">0</span>)), <span class="dt">big.mark =</span> <span class="st">&quot;,&quot;</span>), <span class="st">&quot; billion&quot;</span>)
  } <span class="cf">else</span> <span class="cf">if</span> (x <span class="op">&gt;</span><span class="st"> </span><span class="fl">1e9</span>) {
    res &lt;-<span class="st"> </span><span class="kw">paste0</span>(pre, <span class="kw">prettyNum</span>(<span class="kw">round</span>(x <span class="op">/</span><span class="st"> </span><span class="fl">1e9</span>, <span class="kw">d</span>(<span class="dv">1</span>)), <span class="dt">big.mark =</span> <span class="st">&quot;,&quot;</span>), <span class="st">&quot; billion&quot;</span>)
  } <span class="cf">else</span> {
    res &lt;-<span class="st"> </span><span class="kw">paste0</span>(pre, <span class="kw">prettyNum</span>(<span class="kw">round</span>(x <span class="op">/</span><span class="st"> </span><span class="fl">1e6</span>, <span class="kw">d</span>(<span class="dv">0</span>)), <span class="dt">big.mark =</span> <span class="st">&quot;,&quot;</span>), <span class="st">&quot; million&quot;</span>)
  }
  <span class="kw">print</span>(res)
}</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## ------------------------------------------------------------------------
s1617 &lt;-<span class="st"> </span>
<span class="st">  </span><span class="cf">if</span> (<span class="kw">file.exists</span>(<span class="st">&quot;~/ozTaxData/data-raw/2016_sample_file.csv&quot;</span>)) {
    sample_file_<span class="dv">1516</span> &lt;-<span class="st"> </span><span class="kw">fread</span>(<span class="st">&quot;~/ozTaxData/data-raw/2016_sample_file.csv&quot;</span>)
    <span class="kw">project</span>(sample_file_<span class="dv">1516</span>, <span class="dt">h =</span> 1L, <span class="dt">fy.year.of.sample.file =</span> <span class="st">&quot;2015-16&quot;</span>)
  } <span class="cf">else</span> {
    <span class="kw">project</span>(sample_file_1415_synth, <span class="dt">h =</span> 2L)
  }
s1617 &lt;-<span class="st"> </span><span class="kw">model_income_tax</span>(s1617, <span class="st">&quot;2016-17&quot;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## ------------------------------------------------------------------------
s1718 &lt;-<span class="st"> </span>
<span class="st">  </span><span class="cf">if</span> (<span class="kw">file.exists</span>(<span class="st">&quot;~/ozTaxData/data-raw/2016_sample_file.csv&quot;</span>)) {
    sample_file_<span class="dv">1516</span> &lt;-<span class="st"> </span><span class="kw">fread</span>(<span class="st">&quot;~/ozTaxData/data-raw/2016_sample_file.csv&quot;</span>)
    <span class="kw">project</span>(sample_file_<span class="dv">1516</span>, <span class="dt">h =</span> 2L, <span class="dt">fy.year.of.sample.file =</span> <span class="st">&quot;2015-16&quot;</span>)
  } <span class="cf">else</span> {
    <span class="kw">project</span>(sample_file_1415_synth, <span class="dt">h =</span> 3L)
  }
s1718 &lt;-<span class="st"> </span><span class="kw">model_income_tax</span>(s1718, <span class="st">&quot;2017-18&quot;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## ------------------------------------------------------------------------
s1819 &lt;-<span class="st"> </span>
<span class="st">  </span><span class="cf">if</span> (<span class="kw">file.exists</span>(<span class="st">&quot;~/ozTaxData/data-raw/2016_sample_file.csv&quot;</span>)) {
    sample_file_<span class="dv">1516</span> &lt;-<span class="st"> </span><span class="kw">fread</span>(<span class="st">&quot;~/ozTaxData/data-raw/2016_sample_file.csv&quot;</span>)
    <span class="kw">project</span>(sample_file_<span class="dv">1516</span>, <span class="dt">h =</span> 3L, <span class="dt">fy.year.of.sample.file =</span> <span class="st">&quot;2015-16&quot;</span>)
  } <span class="cf">else</span> {
    <span class="kw">project</span>(sample_file_1415_synth, <span class="dt">h =</span> 4L)
  } <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">model_income_tax</span>(<span class="st">&quot;2018-19&quot;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">wage_forecasts &lt;-<span class="st"> </span>
<span class="st">  </span><span class="kw">data.table</span>(<span class="dt">fy_year =</span> <span class="kw">yr2fy</span>(<span class="dv">2018</span><span class="op">:</span><span class="dv">2028</span>),
             <span class="dt">r =</span> <span class="kw">c</span>(<span class="fl">2.25</span>, <span class="fl">2.75</span>, <span class="fl">3.25</span>, <span class="fl">3.5</span>, <span class="fl">3.5</span>, <span class="kw">rep</span>(<span class="fl">3.5</span>, <span class="dv">6</span>)) <span class="op">/</span><span class="st"> </span><span class="dv">100</span>)
lf_forecasts &lt;-<span class="st"> </span>
<span class="st">  </span><span class="kw">data.table</span>(<span class="dt">fy_year =</span> <span class="kw">yr2fy</span>(<span class="dv">2018</span><span class="op">:</span><span class="dv">2028</span>),
             <span class="dt">r =</span> <span class="kw">c</span>(<span class="fl">2.75</span>, <span class="fl">1.50</span>, <span class="fl">1.50</span>, <span class="fl">1.50</span>, <span class="fl">1.25</span>, <span class="kw">rep</span>(<span class="fl">1.25</span>, <span class="dv">6</span>)) <span class="op">/</span><span class="st"> </span><span class="dv">100</span>)


ordinary_tax_rates &lt;-<span class="st"> </span><span class="cf">function</span>(h) {
  <span class="cf">if</span> (h <span class="op">&lt;</span><span class="st"> </span><span class="dv">9</span>) {
    <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">0.19</span>, <span class="fl">0.325</span>, <span class="fl">0.37</span>, <span class="fl">0.45</span>)
  } <span class="cf">else</span> {
    <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">0.19</span>, <span class="fl">0.325</span>, <span class="fl">0.45</span>)  
  }
}

ordinary_tax_thresholds &lt;-<span class="st"> </span><span class="cf">function</span>(h) {
  <span class="cf">if</span> (h <span class="op">&lt;</span><span class="st"> </span><span class="dv">7</span>) {
    <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">18200</span>, <span class="fl">37e3</span>, <span class="fl">90e3</span>, <span class="fl">180e3</span>)
  } <span class="cf">else</span> <span class="cf">if</span> (h <span class="op">&lt;</span><span class="st"> </span><span class="dv">9</span>) {
    <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">18200</span>, <span class="fl">41e3</span>, <span class="fl">90e3</span>, <span class="fl">180e3</span>)
  } <span class="cf">else</span> {
    <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">18200</span>, <span class="fl">41e3</span>, <span class="fl">200e3</span>)
  }
}</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#&#39; @param x2018 A length-one for the 2018-19 number.</span>
<span class="co">#&#39; @param fy The financial year</span>
.do_medicare_levy &lt;-<span class="st"> </span><span class="cf">function</span>(x2018, fy) {
  <span class="kw">stopifnot</span>(<span class="kw">length</span>(fy) <span class="op">==</span><span class="st"> </span>1L, <span class="kw">is.fy</span>(fy))
  <span class="cf">if</span> (fy <span class="op">==</span><span class="st"> &quot;2018-19&quot;</span>) {
    <span class="kw">return</span>(x2018)
  } <span class="cf">else</span> {
    <span class="kw">return</span>(<span class="kw">round</span>(<span class="kw">cpi_inflator</span>(x2018, <span class="dt">from_fy =</span> <span class="st">&quot;2018-19&quot;</span>, <span class="dt">to_fy =</span> fy), <span class="op">-</span><span class="dv">1</span>))
  }
}

medicare_levy_lower_threshold &lt;-<span class="st"> </span><span class="cf">function</span>(fy) {
  <span class="kw">.do_medicare_levy</span>(<span class="dv">21980</span>, fy)
}

medicare_levy_lower_sapto_threshold &lt;-<span class="st"> </span><span class="cf">function</span>(fy) {
  <span class="kw">.do_medicare_levy</span>(<span class="dv">34758</span>, fy)
}

medicare_levy_lower_family_threshold &lt;-<span class="st"> </span><span class="cf">function</span>(fy) {
  <span class="kw">.do_medicare_levy</span>(<span class="dv">48385</span>, fy)
}

medicare_levy_lower_family_sapto_threshold &lt;-<span class="st"> </span><span class="cf">function</span>(fy) {
  <span class="kw">.do_medicare_levy</span>(<span class="dv">48385</span>, fy)
}

medicare_levy_lower_up_for_each_child &lt;-<span class="st"> </span><span class="cf">function</span>(fy) {
  <span class="kw">.do_medicare_levy</span>(<span class="dv">3406</span>, fy)
}

.project_to &lt;-<span class="st"> </span><span class="cf">function</span>(h, use.Treasury) {
  <span class="kw">project</span>(sample_file_<span class="dv">1516</span>,
          <span class="dt">h =</span> h,
          <span class="dt">wage.series =</span> <span class="cf">if</span> (use.Treasury) wage_forecasts,
          <span class="dt">lf.series =</span> <span class="cf">if</span> (use.Treasury) lf_forecasts) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">setkey</span>(Taxable_Income)
}</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">.project_useTreasurys &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">15</span>, .project_to, <span class="dt">use.Treasury =</span> <span class="ot">TRUE</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">.project_useGrattans &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">15</span>, .project_to, <span class="dt">use.Treasury =</span> <span class="ot">FALSE</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">model_Budgets &lt;-<span class="st"> </span><span class="cf">function</span>(fy_year, <span class="dt">use.Treasury =</span> <span class="ot">TRUE</span>, <span class="dt">.debug =</span> <span class="ot">FALSE</span>) { 
  h &lt;-<span class="st"> </span><span class="kw">as.integer</span>(<span class="kw">fy2yr</span>(fy_year) <span class="op">-</span><span class="st"> </span>2016L)
  
  <span class="cf">if</span> (use.Treasury) {
    s1920 &lt;-<span class="st"> </span>.project_useTreasurys[[h]]
  } <span class="cf">else</span> {
    s1920 &lt;-<span class="st"> </span>.project_useGrattans[[h]]
  }
  
  model_income_tax &lt;-<span class="st"> </span><span class="cf">function</span>(...,
                               <span class="dt">lamington =</span> <span class="ot">FALSE</span>,
                               <span class="dt">lito_202223 =</span> <span class="ot">FALSE</span>, 
                               <span class="dt">watr =</span> <span class="ot">FALSE</span>) {
    grattan<span class="op">::</span><span class="kw">model_income_tax</span>(
      <span class="dt">sample_file =</span> s1920, 
      <span class="dt">baseline_fy =</span> <span class="st">&quot;2017-18&quot;</span>,
      <span class="dt">medicare_levy_lower_threshold =</span> <span class="kw">medicare_levy_lower_threshold</span>(fy_year),
      <span class="dt">medicare_levy_lower_sapto_threshold =</span> <span class="kw">medicare_levy_lower_sapto_threshold</span>(fy_year),
      <span class="dt">medicare_levy_lower_family_threshold =</span> <span class="kw">medicare_levy_lower_family_threshold</span>(fy_year),
      <span class="dt">medicare_levy_lower_family_sapto_threshold =</span> <span class="kw">medicare_levy_lower_family_sapto_threshold</span>(fy_year),
      <span class="dt">medicare_levy_lower_up_for_each_child =</span> <span class="kw">medicare_levy_lower_up_for_each_child</span>(fy_year),
      <span class="dt">warn_upper_thresholds =</span> <span class="ot">FALSE</span>,
      <span class="dt">Budget2018_lamington =</span> lamington,
      <span class="dt">Budget2018_lito_202223 =</span> lito_<span class="dv">202223</span>,
      <span class="dt">Budget2018_watr =</span> watr,
      ...) <span class="op">%&gt;%</span>
<span class="st">      </span>.[, new_tax <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">as.integer</span>(new_tax)] <span class="op">%&gt;%</span>
<span class="st">      </span>.[, delta <span class="op">:</span><span class="er">=</span><span class="st"> </span>new_tax <span class="op">-</span><span class="st"> </span>baseline_tax] <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">setkey</span>(Taxable_Income) <span class="op">%&gt;%</span>
<span class="st">      </span>.[]
  }
  
  <span class="kw">list</span>(<span class="dt">Budget2018_baseline =</span> <span class="kw">model_income_tax</span>(),
       <span class="dt">Budget2018_baseline_brackets_cpi =</span> <span class="kw">model_income_tax</span>(<span class="dt">ordinary_tax_thresholds =</span> <span class="kw">cpi_inflator</span>(<span class="kw">ordinary_tax_thresholds</span>(<span class="dv">1</span>), <span class="dt">from_fy =</span> <span class="st">&quot;2017-18&quot;</span>, <span class="dt">to_fy =</span> fy_year)),
       <span class="dt">Budget2018_baseline_no_SBTO =</span> <span class="kw">model_income_tax</span>(<span class="dt">sbto_discount =</span> <span class="dv">0</span>),
       <span class="dt">Budget2018_just_rates =</span> <span class="kw">model_income_tax</span>(<span class="dt">ordinary_tax_rates =</span>  <span class="kw">ordinary_tax_rates</span>(h),
                                                <span class="dt">ordinary_tax_thresholds =</span> <span class="kw">ordinary_tax_thresholds</span>(h),
                                                <span class="dt">lito_202223 =</span> <span class="ot">FALSE</span>,
                                                <span class="dt">lamington =</span> <span class="ot">FALSE</span>),
       <span class="dt">Budget2018_just_LITO =</span> <span class="kw">model_income_tax</span>(<span class="dt">lito_202223 =</span> h <span class="op">&gt;</span><span class="st"> </span><span class="dv">6</span>,
                                               <span class="dt">lamington =</span> <span class="ot">FALSE</span>),
       <span class="dt">Budget2018_just_LITO_and_rates =</span> <span class="kw">model_income_tax</span>(<span class="dt">ordinary_tax_rates =</span>  <span class="kw">ordinary_tax_rates</span>(h),
                                                         <span class="dt">ordinary_tax_thresholds =</span> <span class="kw">ordinary_tax_thresholds</span>(h),
                                                         <span class="dt">lito_202223 =</span> h <span class="op">&gt;</span><span class="st"> </span><span class="dv">6</span>,
                                                         <span class="dt">lamington =</span> <span class="ot">FALSE</span>),
       <span class="dt">Budget2018_just_lamington =</span> <span class="kw">model_income_tax</span>(<span class="dt">lamington =</span> <span class="ot">TRUE</span>),
       <span class="dt">Budget2018_lamington_plus_LITO =</span> <span class="kw">model_income_tax</span>(<span class="dt">lito_202223 =</span> h <span class="op">&gt;</span><span class="st"> </span><span class="dv">6</span>,
                                                         <span class="dt">lamington =</span> fy_year <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;2018-19&quot;</span>, <span class="st">&quot;2019-20&quot;</span>, <span class="st">&quot;2020-21&quot;</span>, <span class="st">&quot;2021-22&quot;</span>)),
       <span class="dt">Budget2018_lamington_plus_bracket1 =</span> <span class="kw">model_income_tax</span>(<span class="dt">lito_202223 =</span> h <span class="op">&gt;</span><span class="st"> </span><span class="dv">6</span>,
                                                             <span class="dt">lamington =</span> fy_year <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;2018-19&quot;</span>, <span class="st">&quot;2019-20&quot;</span>, <span class="st">&quot;2020-21&quot;</span>, <span class="st">&quot;2021-22&quot;</span>)),
       <span class="dt">Budget2018_no_SBTO =</span> <span class="kw">model_income_tax</span>(<span class="dt">ordinary_tax_rates =</span> <span class="kw">ordinary_tax_rates</span>(h),
                                             <span class="dt">ordinary_tax_thresholds =</span> <span class="kw">ordinary_tax_thresholds</span>(h),
                                             <span class="dt">lito_202223 =</span> h <span class="op">&gt;</span><span class="st"> </span><span class="dv">6</span>,
                                             <span class="dt">lamington =</span> fy_year <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;2018-19&quot;</span>, <span class="st">&quot;2019-20&quot;</span>, <span class="st">&quot;2020-21&quot;</span>, <span class="st">&quot;2021-22&quot;</span>), 
                                             <span class="dt">sbto_discount =</span> <span class="dv">0</span>),
       <span class="dt">Budget2018 =</span> <span class="kw">model_income_tax</span>(<span class="dt">ordinary_tax_rates =</span> <span class="kw">ordinary_tax_rates</span>(h),
                                     <span class="dt">ordinary_tax_thresholds =</span> <span class="kw">ordinary_tax_thresholds</span>(h),
                                     <span class="dt">lito_202223 =</span> h <span class="op">&gt;</span><span class="st"> </span><span class="dv">6</span>,
                                     <span class="dt">lamington =</span> fy_year <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;2018-19&quot;</span>, <span class="st">&quot;2019-20&quot;</span>, <span class="st">&quot;2020-21&quot;</span>, <span class="st">&quot;2021-22&quot;</span>)),
       <span class="dt">ALP2018_no_SBTO =</span> <span class="kw">model_income_tax</span>(<span class="dt">ordinary_tax_rates =</span> <span class="kw">ordinary_tax_rates</span>(<span class="dv">3</span>), 
                                          <span class="dt">ordinary_tax_thresholds =</span> <span class="kw">ordinary_tax_thresholds</span>(<span class="dv">3</span>),
                                          <span class="dt">sbto_discount =</span> <span class="dv">0</span>,
                                          <span class="dt">watr =</span> <span class="ot">TRUE</span>),
       <span class="dt">ALP2018 =</span> <span class="kw">model_income_tax</span>(<span class="dt">ordinary_tax_rates =</span> <span class="kw">ordinary_tax_rates</span>(<span class="dv">3</span>), 
                                  <span class="dt">ordinary_tax_thresholds =</span> <span class="kw">ordinary_tax_thresholds</span>(<span class="dv">3</span>),
                                  <span class="dt">watr =</span> <span class="ot">TRUE</span>))
}</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Budget_<span class="dv">1922</span> &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="kw">yr2fy</span>(<span class="dv">2019</span><span class="op">:</span><span class="dv">2028</span>), model_Budgets)
Budget_1922_Grattan &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="kw">yr2fy</span>(<span class="dv">2019</span><span class="op">:</span><span class="dv">2028</span>), model_Budgets, <span class="dt">use.Treasury =</span> <span class="ot">FALSE</span>)


<span class="kw">names</span>(Budget_<span class="dv">1922</span>) &lt;-<span class="st"> </span><span class="kw">yr2fy</span>(<span class="dv">2019</span><span class="op">:</span><span class="dv">2028</span>)
<span class="kw">names</span>(Budget_1922_Grattan) &lt;-<span class="st"> </span><span class="kw">yr2fy</span>(<span class="dv">2019</span><span class="op">:</span><span class="dv">2028</span>)
<span class="kw">round</span>(<span class="kw">sapply</span>(Budget_<span class="dv">1922</span>, sapply, revenue_foregone, <span class="dt">USE.NAMES =</span> <span class="ot">TRUE</span>) <span class="op">/</span><span class="st"> </span><span class="fl">1e9</span>, <span class="dv">2</span>)
<span class="co">#&gt;                                    2018-19 2019-20 2020-21 2021-22 2022-23</span>
<span class="co">#&gt; Budget2018_baseline                  -0.04   -0.08   -0.12   -0.17   -0.21</span>
<span class="co">#&gt; Budget2018_baseline_brackets_cpi     -2.31   -4.47   -6.78   -9.20  -11.77</span>
<span class="co">#&gt; Budget2018_baseline_no_SBTO           0.15    0.11    0.07    0.03   -0.01</span>
<span class="co">#&gt; Budget2018_just_rates                -0.42   -0.50   -0.58   -0.65   -5.92</span>
<span class="co">#&gt; Budget2018_just_LITO                 -0.04   -0.08   -0.12   -0.17   -0.72</span>
<span class="co">#&gt; Budget2018_just_LITO_and_rates       -0.42   -0.50   -0.58   -0.65   -6.43</span>
<span class="co">#&gt; Budget2018_just_lamington            -3.83   -3.94   -4.04   -4.12   -4.20</span>
<span class="co">#&gt; Budget2018_lamington_plus_LITO       -3.83   -3.94   -4.04   -4.12   -0.72</span>
<span class="co">#&gt; Budget2018_lamington_plus_bracket1   -3.83   -3.94   -4.04   -4.12   -0.72</span>
<span class="co">#&gt; Budget2018_no_SBTO                   -4.03   -4.17   -4.30   -4.41   -6.24</span>
<span class="co">#&gt; Budget2018                           -4.22   -4.35   -4.49   -4.61   -6.43</span>
<span class="co">#&gt; ALP2018_no_SBTO                      -6.86   -7.04   -7.22   -7.37   -7.50</span>
<span class="co">#&gt; ALP2018                              -7.04   -7.22   -7.40   -7.55   -7.69</span>
<span class="co">#&gt;                                    2023-24 2024-25 2025-26 2026-27 2027-28</span>
<span class="co">#&gt; Budget2018_baseline                  -0.25   -0.28   -0.32   -0.35   -0.38</span>
<span class="co">#&gt; Budget2018_baseline_brackets_cpi    -14.47  -17.32  -20.32  -23.48  -26.81</span>
<span class="co">#&gt; Budget2018_baseline_no_SBTO          -0.05   -0.08   -0.11   -0.14   -0.17</span>
<span class="co">#&gt; Budget2018_just_rates                -6.15  -17.45  -18.60  -19.83  -21.11</span>
<span class="co">#&gt; Budget2018_just_LITO                 -0.75   -0.77   -0.80   -0.82   -0.84</span>
<span class="co">#&gt; Budget2018_just_LITO_and_rates       -6.64  -17.93  -19.08  -20.30  -21.56</span>
<span class="co">#&gt; Budget2018_just_lamington            -4.27   -4.33   -4.38   -4.43   -4.47</span>
<span class="co">#&gt; Budget2018_lamington_plus_LITO       -0.75   -0.77   -0.80   -0.82   -0.84</span>
<span class="co">#&gt; Budget2018_lamington_plus_bracket1   -0.75   -0.77   -0.80   -0.82   -0.84</span>
<span class="co">#&gt; Budget2018_no_SBTO                   -6.45  -17.74  -18.88  -20.09  -21.36</span>
<span class="co">#&gt; Budget2018                           -6.64  -17.93  -19.08  -20.30  -21.56</span>
<span class="co">#&gt; ALP2018_no_SBTO                      -7.63   -7.74   -7.84   -7.94   -8.02</span>
<span class="co">#&gt; ALP2018                              -7.82   -7.93   -8.04   -8.13   -8.22</span>
<span class="kw">round</span>(<span class="kw">sapply</span>(Budget_1922_Grattan, sapply, revenue_foregone, <span class="dt">USE.NAMES =</span> <span class="ot">TRUE</span>) <span class="op">/</span><span class="st"> </span><span class="fl">1e9</span>, <span class="dv">2</span>)
<span class="co">#&gt;                                    2018-19 2019-20 2020-21 2021-22 2022-23</span>
<span class="co">#&gt; Budget2018_baseline                  -0.04   -0.08   -0.12   -0.17   -0.22</span>
<span class="co">#&gt; Budget2018_baseline_brackets_cpi     -2.23   -4.30   -6.48   -8.77  -11.16</span>
<span class="co">#&gt; Budget2018_baseline_no_SBTO           0.15    0.11    0.07    0.03   -0.02</span>
<span class="co">#&gt; Budget2018_just_rates                -0.41   -0.47   -0.54   -0.61   -5.67</span>
<span class="co">#&gt; Budget2018_just_LITO                 -0.04   -0.08   -0.12   -0.17   -0.75</span>
<span class="co">#&gt; Budget2018_just_LITO_and_rates       -0.41   -0.47   -0.54   -0.61   -6.21</span>
<span class="co">#&gt; Budget2018_just_lamington            -3.73   -3.85   -3.98   -4.09   -4.21</span>
<span class="co">#&gt; Budget2018_lamington_plus_LITO       -3.73   -3.85   -3.98   -4.09   -0.75</span>
<span class="co">#&gt; Budget2018_lamington_plus_bracket1   -3.73   -3.85   -3.98   -4.09   -0.75</span>
<span class="co">#&gt; Budget2018_no_SBTO                   -3.92   -4.07   -4.21   -4.34   -6.02</span>
<span class="co">#&gt; Budget2018                           -4.10   -4.25   -4.39   -4.53   -6.21</span>
<span class="co">#&gt; ALP2018_no_SBTO                      -6.68   -6.88   -7.08   -7.27   -7.46</span>
<span class="co">#&gt; ALP2018                              -6.86   -7.06   -7.26   -7.45   -7.65</span>
<span class="co">#&gt;                                    2023-24 2024-25 2025-26 2026-27 2027-28</span>
<span class="co">#&gt; Budget2018_baseline                  -0.26   -0.31   -0.36   -0.41   -0.46</span>
<span class="co">#&gt; Budget2018_baseline_brackets_cpi    -13.66  -16.26  -18.98  -21.80  -24.73</span>
<span class="co">#&gt; Budget2018_baseline_no_SBTO          -0.06   -0.11   -0.15   -0.20   -0.24</span>
<span class="co">#&gt; Budget2018_just_rates                -5.88  -15.20  -15.93  -16.69  -17.46</span>
<span class="co">#&gt; Budget2018_just_LITO                 -0.80   -0.85   -0.90   -0.95   -1.00</span>
<span class="co">#&gt; Budget2018_just_LITO_and_rates       -6.42  -15.73  -16.47  -17.23  -18.00</span>
<span class="co">#&gt; Budget2018_just_lamington            -4.33   -4.44   -4.55   -4.67   -4.78</span>
<span class="co">#&gt; Budget2018_lamington_plus_LITO       -0.80   -0.85   -0.90   -0.95   -1.00</span>
<span class="co">#&gt; Budget2018_lamington_plus_bracket1   -0.80   -0.85   -0.90   -0.95   -1.00</span>
<span class="co">#&gt; Budget2018_no_SBTO                   -6.23  -15.53  -16.27  -17.03  -17.80</span>
<span class="co">#&gt; Budget2018                           -6.42  -15.73  -16.47  -17.23  -18.00</span>
<span class="co">#&gt; ALP2018_no_SBTO                      -7.65   -7.83   -8.02   -8.20   -8.38</span>
<span class="co">#&gt; ALP2018                              -7.84   -8.03   -8.21   -8.40   -8.58</span>
<span class="kw">sapply</span>(Budget_<span class="dv">1922</span>, sapply, revenue_foregone, <span class="dt">USE.NAMES =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span>rowSums <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">divide_by</span>(<span class="fl">1e9</span>)
<span class="co">#&gt;                Budget2018_baseline   Budget2018_baseline_brackets_cpi </span>
<span class="co">#&gt;                         -2.1968098                       -136.9327465 </span>
<span class="co">#&gt;        Budget2018_baseline_no_SBTO              Budget2018_just_rates </span>
<span class="co">#&gt;                         -0.1821207                        -91.2032879 </span>
<span class="co">#&gt;               Budget2018_just_LITO     Budget2018_just_LITO_and_rates </span>
<span class="co">#&gt;                         -5.0901557                        -94.0967036 </span>
<span class="co">#&gt;          Budget2018_just_lamington     Budget2018_lamington_plus_LITO </span>
<span class="co">#&gt;                        -41.9858430                        -20.6040033 </span>
<span class="co">#&gt; Budget2018_lamington_plus_bracket1                 Budget2018_no_SBTO </span>
<span class="co">#&gt;                        -20.6040033                       -107.6735276 </span>
<span class="co">#&gt;                         Budget2018                    ALP2018_no_SBTO </span>
<span class="co">#&gt;                       -109.6106066                        -75.1614029 </span>
<span class="co">#&gt;                            ALP2018 </span>
<span class="co">#&gt;                        -77.0462087</span>
<span class="kw">sapply</span>(Budget_1922_Grattan, sapply, revenue_foregone, <span class="dt">USE.NAMES =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span>rowSums <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">divide_by</span>(<span class="fl">1e9</span>)
<span class="co">#&gt;                Budget2018_baseline   Budget2018_baseline_brackets_cpi </span>
<span class="co">#&gt;                         -2.4397309                       -128.3685929 </span>
<span class="co">#&gt;        Budget2018_baseline_no_SBTO              Budget2018_just_rates </span>
<span class="co">#&gt;                         -0.4204452                        -78.8753908 </span>
<span class="co">#&gt;               Budget2018_just_LITO     Budget2018_just_LITO_and_rates </span>
<span class="co">#&gt;                         -5.6666253                        -82.1023484 </span>
<span class="co">#&gt;          Budget2018_just_lamington     Budget2018_lamington_plus_LITO </span>
<span class="co">#&gt;                        -42.6362173                        -20.9125415 </span>
<span class="co">#&gt; Budget2018_lamington_plus_bracket1                 Budget2018_no_SBTO </span>
<span class="co">#&gt;                        -20.9125415                        -95.4071680 </span>
<span class="co">#&gt;                         Budget2018                    ALP2018_no_SBTO </span>
<span class="co">#&gt;                        -97.3483290                        -75.4440053 </span>
<span class="co">#&gt;                            ALP2018 </span>
<span class="co">#&gt;                        -77.3334547</span>

<span class="kw">write.csv</span>(<span class="kw">round</span>(<span class="kw">sapply</span>(Budget_<span class="dv">1922</span>, sapply, revenue_foregone, <span class="dt">USE.NAMES =</span> <span class="ot">TRUE</span>) <span class="op">/</span><span class="st"> </span><span class="fl">1e9</span>, <span class="dv">2</span>), 
          <span class="st">&quot;Budget201718-summaries-2.csv&quot;</span>)
<span class="kw">write.csv</span>(<span class="kw">round</span>(<span class="kw">sapply</span>(Budget_1922_Grattan, sapply, revenue_foregone, <span class="dt">USE.NAMES =</span> <span class="ot">TRUE</span>) <span class="op">/</span><span class="st"> </span><span class="fl">1e9</span>, <span class="dv">2</span>), 
          <span class="st">&quot;Budget201718-Grattan-summaries.csv&quot;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">avg_individual_impact_by_Quintile_fy &lt;-<span class="st"> </span>
<span class="st">  </span><span class="kw">lapply</span>(Budget_<span class="dv">1922</span>, <span class="cf">function</span>(x) {
    x[[<span class="st">&quot;Budget2018&quot;</span>]] <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">setkey</span>(Taxable_Income) <span class="op">%&gt;%</span>
<span class="st">      </span>.[, Quintile <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(<span class="kw">ceiling</span>(<span class="dv">5</span> <span class="op">*</span><span class="st"> </span>.I <span class="op">/</span><span class="st"> </span>.N),
                             <span class="dt">levels =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">5</span>)] <span class="op">%&gt;%</span>
<span class="st">      </span>.[, .(<span class="dt">avg_delta =</span> <span class="kw">mean</span>(delta),
            <span class="dt">max_income =</span> <span class="kw">max</span>(Taxable_Income),
            <span class="dt">min_income =</span> <span class="kw">min</span>(Taxable_Income),
            <span class="dt">avg_income =</span> <span class="kw">mean</span>(Taxable_Income <span class="op">+</span><span class="st"> </span><span class="dv">0</span>)),
        keyby =<span class="st"> </span>.(Quintile)]
  }) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">rbindlist</span>(<span class="dt">idcol =</span> <span class="st">&quot;fy_year&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">setkey</span>(fy_year, Quintile) <span class="op">%&gt;%</span>
<span class="st">  </span>.[, <span class="st">&quot;Financial year ending&quot;</span> <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">fy2yr</span>(fy_year)] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, avg_delta <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">round</span>(avg_delta, <span class="dv">2</span>)] <span class="op">%T&gt;%</span>
<span class="st">  </span><span class="kw">fwrite</span>(<span class="st">&quot;avg_individual_impact_by_Quintile_fy.csv&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span>.[] 

avg_individual_impact_by_Quintile_fy <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">grplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="st">`</span><span class="dt">Financial year ending</span><span class="st">`</span>,
             <span class="dt">y =</span> avg_delta,
             <span class="dt">fill =</span> Quintile),
         <span class="dt">reverse =</span> <span class="ot">TRUE</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_col</span>(<span class="dt">position =</span> <span class="st">&quot;dodge&quot;</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Average individual impact&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> grattan_dollar) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">guides</span>(<span class="dt">fill =</span> <span class="kw">guide_legend</span>(<span class="dt">reverse =</span> <span class="ot">FALSE</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.line.x =</span> <span class="kw">element_line</span>(<span class="dt">size =</span> <span class="fl">0.5</span>),
        <span class="dt">legend.position =</span> <span class="st">&quot;right&quot;</span>)</code></pre></div>
<p><img src="budget-2018_files/figure-html/avg_individual_impact_by_Quintile_fy-1.svg" /><!-- --></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
Brackets &lt;-<span class="st"> </span>
<span class="st">  </span><span class="kw">data.table</span>(<span class="dt">Breaks =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">37e3</span>, <span class="fl">41e3</span>, <span class="fl">87e3</span>, <span class="fl">90e3</span>, <span class="fl">120e3</span>, <span class="fl">180e3</span>, <span class="fl">200e3</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span>.[, Taxable_Income <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">as.integer</span>(Breaks)] <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">setkey</span>(Taxable_Income)

avg_individual_impact_by_Bracket_fy &lt;-<span class="st"> </span>
<span class="st">  </span><span class="kw">lapply</span>(Budget_<span class="dv">1922</span>, <span class="cf">function</span>(x) {
    x[[<span class="st">&quot;Budget2018&quot;</span>]] <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">setkey</span>(Taxable_Income) <span class="op">%&gt;%</span>
<span class="st">      </span>Brackets[., roll=<span class="ot">TRUE</span>] <span class="op">%&gt;%</span>
<span class="st">      </span>.[, .(<span class="dt">avg_delta =</span> <span class="kw">mean</span>(delta),
            <span class="dt">max_income =</span> <span class="kw">max</span>(Taxable_Income),
            <span class="dt">avg_income =</span> <span class="kw">mean</span>(Taxable_Income <span class="op">+</span><span class="st"> </span><span class="dv">0</span>)),
        keyby =<span class="st"> </span>.(Breaks)]
  }) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">rbindlist</span>(<span class="dt">idcol =</span> <span class="st">&quot;fy_year&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">setkey</span>(fy_year, Breaks) <span class="op">%&gt;%</span>
<span class="st">  </span>.[, <span class="st">&quot;Financial year ending&quot;</span> <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">fy2yr</span>(fy_year)] 

avg_individual_impact_by_Bracket_fy <span class="op">%&gt;%</span>
<span class="st">  </span>.[, avg_delta <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">round</span>(avg_delta, <span class="dv">2</span>)] <span class="op">%&gt;%</span>
<span class="st">  </span>.[] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, <span class="st">&quot;Income bracket&quot;</span> <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(Breaks,
                                 <span class="dt">levels =</span> <span class="kw">unique</span>(Breaks),
                                 <span class="dt">labels =</span> <span class="kw">grattan_dollar</span>(<span class="kw">unique</span>(Breaks)),
                                 <span class="dt">ordered =</span> <span class="ot">TRUE</span>)] <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">grplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="st">`</span><span class="dt">Financial year ending</span><span class="st">`</span>, <span class="dt">y =</span> avg_delta, <span class="dt">fill =</span> <span class="st">`</span><span class="dt">Income bracket</span><span class="st">`</span>),
         <span class="dt">reverse =</span> <span class="ot">TRUE</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_col</span>() <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Average individual impact&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> grattan_dollar) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">guides</span>(<span class="dt">fill =</span> <span class="kw">guide_legend</span>(<span class="dt">reverse =</span> <span class="ot">TRUE</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;right&quot;</span>)
<span class="co">#&gt; I&#39;m going off-piste: The Palette Of Nine is thine. May John have mercy on your soul.</span></code></pre></div>
<p><img src="budget-2018_files/figure-html/avg_individual_impact_by_Quintile_fy-2.svg" /><!-- --></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
<span class="kw">lapply</span>(Budget_<span class="dv">1922</span>, <span class="cf">function</span>(x) {
  x[[<span class="st">&quot;Budget2018&quot;</span>]] <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">setkey</span>(Taxable_Income) <span class="op">%&gt;%</span>
<span class="st">    </span>Brackets[., roll=<span class="ot">TRUE</span>] <span class="op">%&gt;%</span>
<span class="st">    </span>.[, .(<span class="dt">avg_delta =</span> <span class="kw">sum</span>(delta <span class="op">*</span><span class="st"> </span>WEIGHT <span class="op">/</span><span class="st"> </span><span class="fl">1e9</span>),
          <span class="dt">max_income =</span> <span class="kw">max</span>(Taxable_Income),
          <span class="dt">avg_income =</span> <span class="kw">mean</span>(Taxable_Income <span class="op">+</span><span class="st"> </span><span class="dv">0</span>)),
      keyby =<span class="st"> </span>.(Breaks)]
}) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">rbindlist</span>(<span class="dt">idcol =</span> <span class="st">&quot;fy_year&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span>.[, <span class="st">&quot;Financial year ending&quot;</span> <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">fy2yr</span>(fy_year)] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, avg_delta <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">round</span>(avg_delta, <span class="dv">2</span>)] <span class="op">%&gt;%</span>
<span class="st">  </span>.[<span class="kw">order</span>(<span class="op">-</span>Breaks)] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, <span class="st">&quot;Incomes above&quot;</span> <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(Breaks,
                                <span class="dt">levels =</span> <span class="kw">unique</span>(Breaks),
                                <span class="dt">labels =</span> <span class="kw">grattan_dollar</span>(<span class="kw">unique</span>(Breaks)),
                                <span class="dt">ordered =</span> <span class="ot">TRUE</span>)] <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">grplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="st">`</span><span class="dt">Financial year ending</span><span class="st">`</span>, <span class="dt">y =</span> avg_delta, <span class="dt">fill =</span> <span class="st">`</span><span class="dt">Incomes above</span><span class="st">`</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_col</span>() <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Total revenue&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> grattan_dollar) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">guides</span>(<span class="dt">fill =</span> <span class="kw">guide_legend</span>(<span class="dt">reverse =</span> <span class="ot">TRUE</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;right&quot;</span>)
<span class="co">#&gt; I&#39;m going off-piste: The Palette Of Nine is thine. May John have mercy on your soul.</span></code></pre></div>
<p><img src="budget-2018_files/figure-html/avg_individual_impact_by_Quintile_fy-3.svg" /><!-- --></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cost_by_policy &lt;-
<span class="st">  </span><span class="kw">sapply</span>(Budget_<span class="dv">1922</span>, sapply, revenue_foregone, <span class="dt">USE.NAMES =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span>rowSums <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">divide_by</span>(<span class="fl">1e9</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cost_in_<span class="dv">202728</span> &lt;-<span class="st"> </span><span class="kw">revenue_foregone</span>(Budget_<span class="dv">1922</span>[[<span class="st">&quot;2027-28&quot;</span>]][[<span class="st">&quot;Budget2018&quot;</span>]], <span class="ot">FALSE</span>, <span class="dt">digits =</span> <span class="dv">0</span>)
cost_in_202728_top20 &lt;-<span class="st"> </span>
<span class="st">  </span>Budget_<span class="dv">1922</span>[[<span class="st">&quot;2027-28&quot;</span>]][[<span class="st">&quot;Budget2018&quot;</span>]][<span class="kw">ntile</span>(Taxable_Income, <span class="dv">100</span>) <span class="op">&gt;=</span><span class="st"> </span><span class="dv">80</span>] <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">revenue_foregone</span>(<span class="dt">revenue_positive =</span> <span class="ot">FALSE</span>, <span class="dt">digits =</span> <span class="dv">0</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">minIncome_by_decile &lt;-<span class="st"> </span>
<span class="st">  </span>s1718[, .(<span class="dt">minIncome =</span> <span class="kw">min</span>(Taxable_Income)), keyby =<span class="st"> </span>.(<span class="dt">Decile =</span> <span class="kw">ntile</span>(Taxable_Income, <span class="dv">10</span>))] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, minIncome <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">as.integer</span>(<span class="kw">round</span>(minIncome, <span class="op">-</span><span class="dv">3</span>))] <span class="op">%&gt;%</span>
<span class="st">  </span>.[]</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">avg_tax_rates_by_percentile_facet_fy &lt;-<span class="st"> </span>
{
  <span class="kw">rbindlist</span>(
    <span class="kw">list</span>(
      <span class="st">&quot;Budget2018&quot;</span> =<span class="st"> </span>{
        <span class="kw">lapply</span>(Budget_<span class="dv">1922</span>, <span class="cf">function</span>(x) {
          x[[<span class="st">&quot;Budget2018&quot;</span>]] <span class="op">%&gt;%</span>
<span class="st">            </span><span class="kw">setkey</span>(Taxable_Income) <span class="op">%&gt;%</span>
<span class="st">            </span>.[, .(<span class="dt">avg_tax_rate =</span> <span class="kw">mean</span>(<span class="kw">coalesce</span>(new_tax <span class="op">/</span><span class="st"> </span>Taxable_Income, <span class="dv">0</span>)),
                  <span class="dt">avg_tax_bill =</span> <span class="kw">mean</span>(new_tax),
                  <span class="dt">total_tax =</span> <span class="kw">sum</span>(new_tax <span class="op">*</span><span class="st"> </span>WEIGHT <span class="op">/</span><span class="st"> </span><span class="fl">1e9</span>),
                  <span class="dt">min_income =</span> <span class="kw">min</span>(Taxable_Income),
                  <span class="dt">max_income =</span> <span class="kw">max</span>(Taxable_Income),
                  <span class="dt">avg_income =</span> <span class="kw">mean</span>(Taxable_Income <span class="op">+</span><span class="st"> </span><span class="dv">0</span>)),
              keyby =<span class="st"> </span>.(<span class="dt">Taxable_Income_percentile =</span> <span class="kw">weighted_ntile</span>(Taxable_Income, <span class="dt">n =</span> <span class="dv">100</span>))] <span class="op">%&gt;%</span>
<span class="st">            </span>.[, facet <span class="op">:</span><span class="er">=</span><span class="st"> &quot;Budget 2018&quot;</span>]
        }) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">          </span><span class="kw">rbindlist</span>(<span class="dt">idcol =</span> <span class="st">&quot;fy_year&quot;</span>,
                    <span class="dt">use.names =</span> <span class="ot">TRUE</span>)
      },
      <span class="st">&quot;Baseline&quot;</span> =<span class="st"> </span>{
        <span class="kw">lapply</span>(Budget_<span class="dv">1922</span>, <span class="cf">function</span>(x) {
          x[[<span class="st">&quot;Budget2018_baseline&quot;</span>]] <span class="op">%&gt;%</span>
<span class="st">            </span><span class="kw">setkey</span>(Taxable_Income) <span class="op">%&gt;%</span>
<span class="st">            </span>.[, .(<span class="dt">avg_tax_rate =</span> <span class="kw">mean</span>(<span class="kw">coalesce</span>(new_tax <span class="op">/</span><span class="st"> </span>Taxable_Income, <span class="dv">0</span>)),
                  <span class="dt">avg_tax_bill =</span> <span class="kw">mean</span>(new_tax),
                  <span class="dt">total_tax =</span> <span class="kw">sum</span>(new_tax <span class="op">*</span><span class="st"> </span>WEIGHT <span class="op">/</span><span class="st"> </span><span class="fl">1e9</span>),
                  <span class="dt">min_income =</span> <span class="kw">min</span>(Taxable_Income),
                  <span class="dt">max_income =</span> <span class="kw">max</span>(Taxable_Income),
                  <span class="dt">avg_income =</span> <span class="kw">mean</span>(Taxable_Income <span class="op">+</span><span class="st"> </span><span class="dv">0</span>)),
              keyby =<span class="st"> </span>.(<span class="dt">Taxable_Income_percentile =</span> <span class="kw">weighted_ntile</span>(Taxable_Income, <span class="dt">n =</span> <span class="dv">100</span>))] <span class="op">%&gt;%</span>
<span class="st">            </span>.[, facet <span class="op">:</span><span class="er">=</span><span class="st"> &quot;Baseline&quot;</span>]
        }) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">          </span><span class="kw">rbindlist</span>(<span class="dt">idcol =</span> <span class="st">&quot;fy_year&quot;</span>,
                    <span class="dt">use.names =</span> <span class="ot">TRUE</span>)
      },
      <span class="st">&quot;Current&quot;</span> =<span class="st"> </span>{
        sample_file_<span class="dv">1516</span> <span class="op">%&gt;%</span>
<span class="st">          </span><span class="kw">project</span>(<span class="dt">h =</span> 2L, 
                  <span class="dt">fy.year.of.sample.file =</span> <span class="st">&quot;2015-16&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">          </span><span class="kw">model_income_tax</span>(<span class="st">&quot;2017-18&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">          </span><span class="co"># .[, tax := income_tax(Taxable_Income, &quot;2017-18&quot;, .dots.ATO = .)] %&gt;%</span>
<span class="st">          </span>.[, .(<span class="dt">avg_tax_rate =</span> <span class="kw">mean</span>(<span class="kw">coalesce</span>(new_tax <span class="op">/</span><span class="st"> </span>Taxable_Income, <span class="dv">0</span>)),
                <span class="dt">avg_tax_bill =</span> <span class="kw">mean</span>(new_tax),
                <span class="dt">min_income =</span> <span class="kw">min</span>(Taxable_Income),
                <span class="dt">max_income =</span> <span class="kw">max</span>(Taxable_Income),
                <span class="dt">total_tax =</span> <span class="kw">sum</span>(new_tax <span class="op">*</span><span class="st"> </span>WEIGHT <span class="op">/</span><span class="st"> </span><span class="fl">1e9</span>),
                <span class="dt">avg_income =</span> <span class="kw">mean</span>(Taxable_Income <span class="op">+</span><span class="st"> </span><span class="dv">0</span>)), 
            keyby =<span class="st"> </span>.(<span class="dt">Taxable_Income_percentile =</span> <span class="kw">weighted_ntile</span>(Taxable_Income, <span class="dt">n =</span> <span class="dv">100</span>))] <span class="op">%&gt;%</span>
<span class="st">          </span>.[, facet <span class="op">:</span><span class="er">=</span><span class="st"> &quot;2017-18&quot;</span>] <span class="op">%&gt;%</span>
<span class="st">          </span>.[, fy_year <span class="op">:</span><span class="er">=</span><span class="st">  &quot;2017-18&quot;</span>]
      }),
      <span class="dt">use.names =</span> <span class="ot">TRUE</span>, <span class="dt">fill =</span> <span class="ot">TRUE</span>, 
    <span class="dt">idcol =</span> <span class="st">&quot;id&quot;</span>)
  } <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span>.[, <span class="st">&quot;Financial year ending&quot;</span> <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">fy2yr</span>(fy_year)] <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">setkey</span>(id, fy_year, Taxable_Income_percentile) <span class="op">%&gt;%</span>
<span class="st">  </span>.[, avg_tax_rate <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">round</span>(avg_tax_rate, <span class="dv">3</span>)] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, total_tax <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">round</span>(total_tax, <span class="dv">3</span>)] <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">setnames</span>(<span class="st">&quot;total_tax&quot;</span>, <span class="st">&quot;total_tax_bn&quot;</span>) <span class="op">%T&gt;%</span>
<span class="st">  </span><span class="kw">fwrite</span>(<span class="dt">file =</span> <span class="st">&quot;avg_tax_rates-by-facet-percentile.csv&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span>.[]


avg_tax_rates_by_percentile_facet_fy <span class="op">%&gt;%</span>
<span class="st">  </span>.[fy_year <span class="op">%in%</span><span class="st"> </span><span class="kw">range</span>(fy_year)] <span class="op">%T&gt;%</span>
<span class="st">  </span>{
    dot &lt;-<span class="st"> </span>.
    dot[, .(facet, fy_year, Taxable_Income_percentile, avg_tax_rate)] <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">dcast.data.table</span>(Taxable_Income_percentile <span class="op">~</span><span class="st"> </span>facet <span class="op">+</span><span class="st"> </span>fy_year,
                       <span class="dt">value.var =</span> <span class="st">&quot;avg_tax_rate&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">melt.data.table</span>(<span class="dt">id.vars =</span> <span class="kw">c</span>(<span class="st">&quot;Taxable_Income_percentile&quot;</span>, <span class="st">&quot;2017-18_2017-18&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">setnames</span>(<span class="st">&quot;2017-18_2017-18&quot;</span>, <span class="st">&quot;T201718&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">      </span>.[, delta <span class="op">:</span><span class="er">=</span><span class="st"> </span>value <span class="op">-</span><span class="st"> </span>T201718] <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">fwrite</span>(<span class="st">&quot;change-in-tax-rate-vs-201718-by-percentile.csv&quot;</span>)
  } <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># dumb don&#39;t care</span>
<span class="st">  </span>.[, Decile <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">weighted_ntile</span>(Taxable_Income_percentile, <span class="dt">n =</span> <span class="dv">10</span>), by =<span class="st"> &quot;facet&quot;</span>] <span class="op">%T&gt;%</span>
<span class="st">  </span>{
    dot &lt;-<span class="st"> </span>.
    dot <span class="op">%&gt;%</span>
<span class="st">      </span>.[, .(<span class="dt">total_tax_bn =</span> <span class="kw">sum</span>(total_tax_bn)), keyby =<span class="st"> </span>.(facet, Decile)] <span class="op">%&gt;%</span>
<span class="st">      </span>.[, <span class="st">&quot;% tax paid&quot;</span> <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">100</span> <span class="op">*</span><span class="st"> </span>total_tax_bn <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(total_tax_bn), keyby =<span class="st"> &quot;facet&quot;</span>] <span class="op">%&gt;%</span>
<span class="st">      </span>.[, <span class="kw">lapply</span>(.SD, signif, <span class="dv">3</span>), keyby =<span class="st"> </span>.(facet, Decile)] <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">fwrite</span>(<span class="st">&quot;prop-tax-paid-by-facet-decile.csv&quot;</span>)
  } <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">grplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> Taxable_Income_percentile, <span class="dt">y =</span> avg_tax_rate, <span class="dt">color =</span> facet)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;Taxable income percentile&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> percent) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),
        <span class="dt">axis.line.x =</span> <span class="kw">element_line</span>(<span class="dt">size =</span> <span class="fl">0.5</span>),
        <span class="dt">legend.title =</span> <span class="kw">element_blank</span>(),
        <span class="dt">legend.justification =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</code></pre></div>
<p><img src="budget-2018_files/figure-html/unnamed-chunk-10-1.svg" /><!-- --></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">decile2income &lt;-<span class="st"> </span><span class="cf">function</span>(d) {
  d &lt;-<span class="st"> </span><span class="kw">as.integer</span>(d)
  <span class="kw">grattan_dollar</span>(minIncome_by_decile[.(d)][[<span class="st">&quot;minIncome&quot;</span>]])
}</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cost_decile_fy &lt;-<span class="st"> </span><span class="cf">function</span>(decile, fy) {
  
}</code></pre></div>
<p>New Grattan Institute analysis highlights that most of the revenue reductions from the Turnbull Government’s full Personal Income Tax Plan are the result of lower taxes on high-income earners. Once the three-stage plan – including removing the 37c bracket – is complete, <strong>-1.554812910^{10}</strong> of the annual <strong>-2.156273510^{10} cost</strong> of the plan will result from collecting less tax from the top 20% of income earners, who currently have a taxable income of $68,000 or more.</p>
<p>The PIT plan will do little to unwind bracket creep’s gradual reduction of the progressivity of the tax system. Even with the PIT plan, average tax rates are forecast to be higher for all taxpayers in 2027-28 – except for very high-income earners who are effectively shielded from bracket creep by the plan. A taxpayer who earns $117,000 today (more than 90% of other taxpayers) will pay an average tax rate of 28.9% in 2027-28, unchanged from today. In contrast, average tax rates for middle-income earners will continue to rise. The average tax rate for a taxpayer who earns $27,000-a-year today (more than 30% of other taxpayers) will increase 6 percentage points (from 9.3% to 14.7% ). As a result, the highest-income taxpayers will bear a lower share of the total tax burden.</p>
<p><strong>Costing and distributional analysis of PIT plan </strong></p>
<p>The 2018-19 budget shows the annual cost of the PIT Plan until 2022. The Treasurer has indicated the ten-year cost of the plan is $140 billion. Grattan’s analysis shows the annual costs of the plan until 2028. The Grattan costing takes into account all elements of the PIT plan.</p>
<p>Most of the revenue reductions until 2021-22 are a result of the Low and Middle Income Tax Offset (“the Lamington”). But once the plan is fully implemented in 2024-25, there are much bigger revenue reductions because the top of the 32.5 cent bracket increases first to $120,000 and then to $200,000 (removing the 37c bracket). In 2028, these bracket changes account for of the in lower revenue.</p>
<p>Once fully implemented, most of the reduction in revenue under the PIT is retained by the top 20% of income earners, with a taxable income of $87,000 or more. In 2028, the reduction in tax collected from this group will account for <strong>$15 billion</strong> of the $25 billion cost of the plan.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Quintile and financial year to tax cut</span>
Qfy2Cut &lt;-<span class="st"> </span><span class="cf">function</span>(Quintile, fy) {
  q &lt;-<span class="st"> </span><span class="kw">factor</span>(<span class="kw">as.integer</span>(Quintile), <span class="dt">levels =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">5</span>)
  ans &lt;-<span class="st"> </span><span class="op">-</span><span class="dv">1</span><span class="op">*</span>avg_individual_impact_by_Quintile_fy[.(fy, q)][[<span class="st">&quot;avg_delta&quot;</span>]]
  <span class="kw">grattan_dollar</span>(<span class="kw">round</span>(ans, <span class="op">-</span><span class="dv">2</span>))
}</code></pre></div>
<p>By 2024-25, the income tax cuts are much larger for high-income earners, both in absolute terms and as a proportion of income. Those in the top 20 per cent will get an average tax cut of $4,600 a year, compared to $400 a year for someone in the second income quintile ($9,000 - $19,000).</p>
<p><strong>Impact of the PIT plan on tax system progressivity</strong></p>
<p>Australia’s progressive tax system ensures that people with higher incomes pay higher average rates of personal income tax. Without changes to tax scales, bracket creep gradually increases average tax rates for all taxpayers. Middle-income earners are affected most in terms of higher average tax rates.</p>
<p>The government claims the PIT plan protects middle-income Australians from bracket creep. Certainly the plan reduces average tax rates in 2027-28 for all taxpayers compared to what they would be if there were no changes to rates or brackets over that period.</p>
<p>But middle-income earners are not spared from bracket creep under the PIT plan. The average tax rate for a taxpayer at the 50<sup>th</sup> percentile will still increase by 5 percentage points (from 14.6% to 19.1% ) compared to 2017-18. Without further changes, average tax rates will be higher for most taxpayers.</p>
<p>The exception is the top 10% of income earners. Average tax rates for those on the highest incomes are virtually unchanged under this plan.</p>
<p>Once fully implemented, the PIT plan doesn’t change the progressivity of the tax system much. Overall, those on high incomes will pay a similar proportion of total tax revenues with or without the plan. But because of bracket creep, high income earners will be paying a lower proportion than today.</p>
<p><strong>Table 1: Share of personal income tax paid falls for highest income earners under PIT plan </strong></p>
<p>Share of total personal income tax paid by income decile (%)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">to_prop &lt;-<span class="st"> </span><span class="cf">function</span>(x) {
  <span class="cf">if</span> (<span class="kw">is.double</span>(x)) {
    <span class="kw">grattan_percent</span>(x <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(x), <span class="dt">.percent.suffix =</span> <span class="st">&quot;%&quot;</span>)
  } <span class="cf">else</span> {
    x
  }
}</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">avg_tax_rates_by_percentile_facet_fy <span class="op">%&gt;%</span>
<span class="st">  </span>.[, .(<span class="dt">tot_tax =</span> <span class="kw">sum</span>(total_tax_bn)),
    keyby =<span class="st"> </span>.(id, fy_year, <span class="dt">Decile =</span> <span class="kw">ntile</span>(Taxable_Income_percentile, <span class="dv">10</span>))] <span class="op">%&gt;%</span>
<span class="st">  </span>.[fy_year <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;2017-18&quot;</span>, <span class="st">&quot;2027-28&quot;</span>)] <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">dcast.data.table</span>(Decile <span class="op">~</span><span class="st"> </span>id <span class="op">+</span><span class="st"> </span>fy_year, <span class="dt">value.var =</span> <span class="st">&quot;tot_tax&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span>.[, <span class="kw">lapply</span>(.SD, to_prop)] <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">kable</span>(<span class="dt">align =</span> <span class="st">&quot;rrrr&quot;</span>)</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="right">Decile</th>
<th align="right">Baseline_2027-28</th>
<th align="right">Budget2018_2027-28</th>
<th align="right">Current_2017-18</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">0.00%</td>
<td align="right">0.00%</td>
<td align="right">0.0%</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="right">0.04%</td>
<td align="right">0.02%</td>
<td align="right">0.0%</td>
</tr>
<tr class="odd">
<td align="right">3</td>
<td align="right">0.84%</td>
<td align="right">0.81%</td>
<td align="right">0.4%</td>
</tr>
<tr class="even">
<td align="right">4</td>
<td align="right">2.33%</td>
<td align="right">2.26%</td>
<td align="right">1.6%</td>
</tr>
<tr class="odd">
<td align="right">5</td>
<td align="right">4.29%</td>
<td align="right">4.30%</td>
<td align="right">3.4%</td>
</tr>
<tr class="even">
<td align="right">6</td>
<td align="right">6.25%</td>
<td align="right">6.38%</td>
<td align="right">5.8%</td>
</tr>
<tr class="odd">
<td align="right">7</td>
<td align="right">8.67%</td>
<td align="right">8.92%</td>
<td align="right">8.5%</td>
</tr>
<tr class="even">
<td align="right">8</td>
<td align="right">12.20%</td>
<td align="right">12.33%</td>
<td align="right">12.1%</td>
</tr>
<tr class="odd">
<td align="right">9</td>
<td align="right">17.88%</td>
<td align="right">17.65%</td>
<td align="right">17.8%</td>
</tr>
<tr class="even">
<td align="right">10</td>
<td align="right">47.49%</td>
<td align="right">47.33%</td>
<td align="right">50.4%</td>
</tr>
</tbody>
</table>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">scale01 &lt;-<span class="st"> </span><span class="cf">function</span>(x) {
  (x <span class="op">-</span><span class="st"> </span><span class="kw">min</span>(x)) <span class="op">/</span><span class="st"> </span>(<span class="kw">max</span>(x) <span class="op">-</span><span class="st"> </span><span class="kw">min</span>(x))
}
scale10 &lt;-<span class="st"> </span><span class="cf">function</span>(x) {
  <span class="dv">1</span> <span class="op">-</span><span class="st"> </span><span class="kw">scale01</span>(x)
}</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Grey &lt;-<span class="st"> </span><span class="cf">function</span>(fy) {
  Alpha &lt;-<span class="st"> </span><span class="fl">0.5</span> <span class="op">*</span><span class="st"> </span><span class="kw">scale10</span>(<span class="kw">fy2yr</span>(fy))
  out &lt;-<span class="st"> </span><span class="kw">grey</span>(<span class="kw">rep_len</span>(<span class="dv">1</span>, <span class="kw">length</span>(fy)))
  <span class="cf">for</span> (i <span class="cf">in</span> <span class="kw">seq_along</span>(fy)) {
    out[i] &lt;-<span class="st"> </span><span class="kw">grey</span>(<span class="fl">0.7</span>, <span class="dt">alpha =</span> Alpha[i])
  }
  out
}</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sample_files_all <span class="op">%&gt;%</span>
<span class="st">  </span>.[, Over65 <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">coalesce</span>(age_range <span class="op">&lt;=</span><span class="st"> </span>1L, Birth_year <span class="op">&lt;=</span><span class="st"> </span>1L)] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, .(<span class="dt">avg_tax_rate =</span> <span class="kw">mean</span>(avg_tax_rate)), keyby =<span class="st"> </span>.(fy.year, Taxable_Income_percentile)] <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">setnames</span>(<span class="st">&quot;fy.year&quot;</span>, <span class="st">&quot;fy_year&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">rbind</span>(avg_tax_rates_by_percentile_facet_fy[, .SD, <span class="dt">.SDcols =</span> <span class="kw">c</span>(<span class="st">&quot;id&quot;</span>, <span class="kw">names</span>(.))],
        <span class="dt">use.names =</span> <span class="ot">TRUE</span>,
        <span class="dt">fill =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">setkey</span>(fy_year, Taxable_Income_percentile) <span class="op">%&gt;%</span>
<span class="st">  </span>.[, z <span class="op">:</span><span class="er">=</span><span class="st"> </span>fy_year <span class="op">%ein%</span><span class="st"> &quot;2017-18&quot;</span>] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, avg_tax_rate_rel <span class="op">:</span><span class="er">=</span><span class="st"> </span>avg_tax_rate <span class="op">-</span><span class="st"> </span><span class="kw">median</span>(avg_tax_rate[z]),
    keyby =<span class="st"> </span>.(Taxable_Income_percentile)] <span class="op">%&gt;%</span>

<span class="st">  </span>.[, colour <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">if_else</span>(<span class="kw">is.na</span>(id),
                        <span class="kw">grey</span>(<span class="fl">0.5</span>), 
                        <span class="kw">if_else</span>(id <span class="op">==</span><span class="st"> &quot;Baseline&quot;</span> <span class="op">&amp;</span><span class="st"> </span>fy_year <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;2018-19&quot;</span>, <span class="st">&quot;2027-28&quot;</span>), 
                                <span class="kw">if_else</span>(fy_year <span class="op">==</span><span class="st"> &quot;2018-19&quot;</span>, 
                                        <span class="kw">gpal</span>(<span class="dv">6</span>)[<span class="dv">4</span>],
                                        <span class="kw">gpal</span>(<span class="dv">6</span>)[<span class="dv">5</span>]),
                                <span class="kw">if_else</span>(fy_year <span class="op">==</span><span class="st"> &quot;2018-19&quot;</span>, 
                                        <span class="kw">gpal</span>(<span class="dv">6</span>)[<span class="dv">1</span>],
                                        <span class="kw">gpal</span>(<span class="dv">6</span>)[<span class="dv">2</span>])))] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, alpha <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">if_else</span>(<span class="kw">is.na</span>(id), <span class="fl">1.05</span> <span class="op">*</span><span class="st"> </span><span class="kw">scale01</span>(<span class="kw">fy2yr</span>(fy_year)), <span class="dv">1</span>)] <span class="op">%&gt;%</span>
<span class="st">  </span>.[fy_year <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;2004-05&quot;</span>, <span class="st">&quot;2013-14&quot;</span>), <span class="kw">c</span>(<span class="st">&quot;alpha&quot;</span>, <span class="st">&quot;colour&quot;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">list</span>(<span class="fl">0.8</span>, <span class="st">&quot;black&quot;</span>)] <span class="op">%&gt;%</span>
<span class="st">  </span>.[<span class="kw">implies</span>(<span class="op">!</span><span class="kw">is.na</span>(id), fy_year <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;2018-19&quot;</span>, <span class="st">&quot;2027-28&quot;</span>))] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, size <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="fl">0.8</span>] <span class="op">%&gt;%</span>
<span class="st">  </span>.[fy_year <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;2004-05&quot;</span>, <span class="st">&quot;2013-14&quot;</span>), size <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="fl">1.1</span>] <span class="op">%&gt;%</span>
<span class="st">  </span>.[fy_year <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;2018-19&quot;</span>, <span class="st">&quot;2027-28&quot;</span>), size <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="fl">1.4</span>] <span class="op">%&gt;%</span>
<span class="st">  </span>.[Taxable_Income_percentile <span class="op">==</span><span class="st"> </span>50L <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(id), label <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">paste0</span>(id, <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>, <span class="kw">as.character</span>(fy_year))] <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="co"># .[Taxable_Income_percentile == 95L &amp; !is.na(id), label := &quot;&quot;] %&gt;%</span>
<span class="st">  </span>.[] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, group <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">paste0</span>(fy_year, colour)] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, text <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">paste0</span>(fy_year, <span class="st">&quot; &quot;</span>, <span class="kw">coalesce</span>(id, <span class="st">&quot;&quot;</span>), <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>,
                     <span class="kw">formatC</span>(<span class="st">&quot;Percentile: &quot;</span>, <span class="dt">width =</span> <span class="dv">24</span>), Taxable_Income_percentile, <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>,
                     <span class="kw">formatC</span>(<span class="st">&quot;Avg. tax rate (03-04 = 0):&quot;</span>, <span class="dt">width =</span> <span class="dv">24</span>), <span class="st">&quot; &quot;</span>, <span class="dv">100</span> <span class="op">*</span><span class="st"> </span><span class="kw">round</span>(avg_tax_rate_rel, <span class="dv">4</span>))] <span class="op">%&gt;%</span>
<span class="st">  </span>.[] <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">setnames</span>(<span class="st">&quot;Taxable_Income_percentile&quot;</span>, 
           <span class="st">&quot;Taxable income percentile&quot;</span>) <span class="op">%T&gt;%</span>
<span class="st">  </span><span class="kw">fwrite</span>(<span class="st">&quot;Average-tax-rates-relative-201718-vs-Taxable-income-percentile-by-FY.csv&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span>as.data.frame <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># .[Over65==FALSE] %&gt;%</span>
<span class="st">  </span><span class="kw">grplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="st">`</span><span class="dt">Taxable income percentile</span><span class="st">`</span>,
             <span class="dt">y =</span> avg_tax_rate_rel,
             <span class="dt">colour =</span> colour,
             <span class="dt">group =</span> group,
             <span class="dt">text =</span> text)) <span class="op">+</span>
<span class="st">  </span><span class="kw">annotate</span>(<span class="st">&quot;label&quot;</span>,
           <span class="dt">x =</span> <span class="dv">20</span>,
           <span class="dt">y =</span> <span class="fl">0.09</span>, 
           <span class="dt">hjust =</span> <span class="dv">1</span>,
           <span class="dt">label.size =</span> <span class="ot">NA</span>,
           <span class="dt">label =</span> <span class="st">&quot;2003-04&quot;</span>,
           <span class="dt">fontface =</span> <span class="st">&quot;bold&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">annotate</span>(<span class="st">&quot;label&quot;</span>,
           <span class="dt">x =</span> <span class="dv">25</span>,
           <span class="dt">y =</span> <span class="op">-</span><span class="fl">0.04</span>,
           <span class="dt">hjust =</span> <span class="dv">1</span>,
           <span class="dt">label.size =</span> <span class="ot">NA</span>,
           <span class="dt">label =</span> <span class="st">&quot;2013-14&quot;</span>,
           <span class="dt">fontface =</span> <span class="st">&quot;bold&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_color_identity</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_size_identity</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_alpha_identity</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">alpha =</span> alpha, <span class="dt">size =</span> size)) <span class="op">+</span>
<span class="st">  </span><span class="co"># geom_blank(aes(x = 105, y = 0)) +</span>
<span class="st">  </span><span class="kw">geom_label_repel</span>(<span class="kw">aes</span>(<span class="dt">label =</span> label),
                   <span class="dt">nudge_x =</span> <span class="dv">2</span>, <span class="dt">force =</span> <span class="fl">0.8</span>,
                   <span class="dt">na.rm =</span> <span class="ot">TRUE</span>,
                   <span class="dt">fontface =</span> <span class="st">&quot;bold&quot;</span>,
                   <span class="dt">label.size =</span> <span class="ot">NA</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> percent) <span class="op">+</span>
<span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Average tax rates relative to 2017-18&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;right&quot;</span>)
<span class="co">#&gt; Scale for &#39;colour&#39; is already present. Adding another scale for</span>
<span class="co">#&gt; &#39;colour&#39;, which will replace the existing scale.</span></code></pre></div>
<p><img src="budget-2018_files/figure-html/unnamed-chunk-18-1.svg" /><!-- --></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sample_files_all <span class="op">%&gt;%</span>
<span class="st">  </span>.[, Over65 <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">coalesce</span>(age_range <span class="op">&lt;=</span><span class="st"> </span>1L, Birth_year <span class="op">&lt;=</span><span class="st"> </span>1L)] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, .(<span class="dt">avg_tax_rate =</span> <span class="kw">mean</span>(avg_tax_rate)), keyby =<span class="st"> </span>.(fy.year, Taxable_Income_percentile)] <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">setnames</span>(<span class="st">&quot;fy.year&quot;</span>, <span class="st">&quot;fy_year&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">rbind</span>(avg_tax_rates_by_percentile_facet_fy[, .SD, <span class="dt">.SDcols =</span> <span class="kw">c</span>(<span class="st">&quot;id&quot;</span>, <span class="kw">names</span>(.))],
        <span class="dt">use.names =</span> <span class="ot">TRUE</span>,
        <span class="dt">fill =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">setkey</span>(fy_year, Taxable_Income_percentile) <span class="op">%&gt;%</span>
<span class="st">  </span>.[, avg_tax_rate_rel <span class="op">:</span><span class="er">=</span><span class="st"> </span>avg_tax_rate <span class="op">-</span><span class="st"> </span><span class="kw">first</span>(avg_tax_rate),
    keyby =<span class="st"> </span>.(Taxable_Income_percentile)] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, colour <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">if_else</span>(<span class="kw">is.na</span>(id),
                        <span class="kw">grey</span>(<span class="fl">0.5</span>), 
                        <span class="kw">if_else</span>(id <span class="op">==</span><span class="st"> &quot;Baseline&quot;</span> <span class="op">&amp;</span><span class="st"> </span>fy_year <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;2018-19&quot;</span>, <span class="st">&quot;2027-28&quot;</span>), 
                                <span class="kw">if_else</span>(fy_year <span class="op">==</span><span class="st"> &quot;2018-19&quot;</span>, 
                                        <span class="kw">gpal</span>(<span class="dv">6</span>)[<span class="dv">4</span>],
                                        <span class="kw">gpal</span>(<span class="dv">6</span>)[<span class="dv">5</span>]),
                                <span class="kw">if_else</span>(fy_year <span class="op">==</span><span class="st"> &quot;2018-19&quot;</span>, 
                                        <span class="kw">gpal</span>(<span class="dv">6</span>)[<span class="dv">1</span>],
                                        <span class="kw">gpal</span>(<span class="dv">6</span>)[<span class="dv">2</span>])))] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, alpha <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">if_else</span>(<span class="kw">is.na</span>(id), <span class="fl">1.05</span> <span class="op">*</span><span class="st"> </span><span class="kw">scale01</span>(<span class="kw">fy2yr</span>(fy_year)), <span class="dv">1</span>)] <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># .[fy_year %in% c(&quot;2013-14&quot;), c(&quot;alpha&quot;, &quot;colour&quot;) := list(0.8, &quot;black&quot;)] %&gt;%</span>
<span class="st">  </span>.[<span class="kw">implies</span>(<span class="op">!</span><span class="kw">is.na</span>(id), fy_year <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;2017-18&quot;</span>, <span class="st">&quot;2018-19&quot;</span>, <span class="st">&quot;2027-28&quot;</span>))] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, size <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="fl">0.8</span>] <span class="op">%&gt;%</span>
<span class="st">  </span>.[fy_year <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;2004-05&quot;</span>, <span class="st">&quot;2013-14&quot;</span>), size <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="fl">1.1</span>] <span class="op">%&gt;%</span>
<span class="st">  </span>.[fy_year <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;2018-19&quot;</span>, <span class="st">&quot;2027-28&quot;</span>), size <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="fl">1.4</span>] <span class="op">%&gt;%</span>
<span class="st">  </span>.[Taxable_Income_percentile <span class="op">==</span><span class="st"> </span>50L <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(id), label <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">paste0</span>(id, <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>, <span class="kw">as.character</span>(fy_year))] <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="co"># .[Taxable_Income_percentile == 95L &amp; !is.na(id), label := &quot;&quot;] %&gt;%</span>
<span class="st">  </span>.[] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, group <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">paste0</span>(fy_year, colour)] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, text <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">paste0</span>(fy_year, <span class="st">&quot; &quot;</span>, <span class="kw">coalesce</span>(id, <span class="st">&quot;&quot;</span>), <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>,
                     <span class="kw">formatC</span>(<span class="st">&quot;Percentile: &quot;</span>, <span class="dt">width =</span> <span class="dv">24</span>), Taxable_Income_percentile, <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>,
                     <span class="kw">formatC</span>(<span class="st">&quot;Avg. tax rate (03-04 = 0):&quot;</span>, <span class="dt">width =</span> <span class="dv">24</span>), <span class="st">&quot; &quot;</span>, <span class="dv">100</span> <span class="op">*</span><span class="st"> </span><span class="kw">round</span>(avg_tax_rate_rel, <span class="dv">4</span>))] <span class="op">%&gt;%</span>
<span class="st">  </span>.[] <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">setnames</span>(<span class="st">&quot;Taxable_Income_percentile&quot;</span>, 
           <span class="st">&quot;Taxable income percentile&quot;</span>) <span class="op">%T&gt;%</span>
<span class="st">  </span><span class="kw">fwrite</span>(<span class="st">&quot;Average-tax-rates-relative-200304-vs-Taxable-income-percentile-by-FY.csv&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span>as.data.frame <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># .[Over65==FALSE] %&gt;%</span>
<span class="st">  </span><span class="kw">grplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="st">`</span><span class="dt">Taxable income percentile</span><span class="st">`</span>,
             <span class="dt">y =</span> avg_tax_rate_rel,
             <span class="dt">colour =</span> colour,
             <span class="dt">group =</span> group,
             <span class="dt">text =</span> text)) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_color_identity</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_size_identity</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_alpha_identity</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">alpha =</span> <span class="dv">1</span>, <span class="dt">size =</span> size)) <span class="op">+</span>
<span class="st">  </span><span class="co"># geom_blank(aes(x = 105, y = 0)) +</span>
<span class="st">  </span><span class="kw">geom_label_repel</span>(<span class="kw">aes</span>(<span class="dt">label =</span> label),
                   <span class="dt">nudge_x =</span> <span class="dv">2</span>, <span class="dt">force =</span> <span class="fl">0.8</span>,
                   <span class="dt">na.rm =</span> <span class="ot">TRUE</span>,
                   <span class="dt">fontface =</span> <span class="st">&quot;bold&quot;</span>,
                   <span class="dt">label.size =</span> <span class="ot">NA</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> percent) <span class="op">+</span>
<span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Average tax rates relative to 2003-04&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;right&quot;</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>fy_year)
<span class="co">#&gt; Scale for &#39;colour&#39; is already present. Adding another scale for</span>
<span class="co">#&gt; &#39;colour&#39;, which will replace the existing scale.</span></code></pre></div>
<p><img src="budget-2018_files/figure-html/avg_tax_rate_by_percentile_fy_year_rel0304-1.svg" /><!-- --></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">bound_models &lt;-<span class="st"> </span>
<span class="st">  </span>Budget_<span class="dv">1922</span> <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">lapply</span>(rbindlist, <span class="dt">use.names =</span> <span class="ot">TRUE</span>, <span class="dt">fill =</span> <span class="ot">TRUE</span>, <span class="dt">idcol =</span> <span class="st">&quot;id&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">rbindlist</span>(<span class="dt">use.names =</span> <span class="ot">TRUE</span>, <span class="dt">fill =</span> <span class="ot">TRUE</span>, <span class="dt">idcol =</span> <span class="st">&quot;fy_year&quot;</span>)
bound_models_Grattan &lt;-<span class="st"> </span>
<span class="st">  </span>Budget_1922_Grattan <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">lapply</span>(rbindlist, <span class="dt">use.names =</span> <span class="ot">TRUE</span>, <span class="dt">fill =</span> <span class="ot">TRUE</span>, <span class="dt">idcol =</span> <span class="st">&quot;id&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">rbindlist</span>(<span class="dt">use.names =</span> <span class="ot">TRUE</span>, <span class="dt">fill =</span> <span class="ot">TRUE</span>, <span class="dt">idcol =</span> <span class="st">&quot;fy_year&quot;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">bound_models <span class="op">%&gt;%</span>
<span class="st">  </span>.[id <span class="op">==</span><span class="st"> &quot;ALP2018&quot;</span>] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, tax_saving <span class="op">:</span><span class="er">=</span><span class="st"> </span>baseline_tax <span class="op">-</span><span class="st"> </span>new_tax] <span class="op">%&gt;%</span>
<span class="st">  </span>.[Taxable_Income <span class="op">&lt;=</span><span class="st"> </span><span class="fl">300e3</span>] <span class="op">%&gt;%</span>
<span class="st">  </span>.[fy_year <span class="op">%ein%</span><span class="st"> &quot;2019-20&quot;</span>] <span class="op">%&gt;%</span>
<span class="st">  </span>.[age_range <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, .(<span class="dt">tax_saving =</span> <span class="kw">mean</span>(tax_saving)),
    keyby =<span class="st"> </span>.(fy_year, <span class="dt">Taxable_Income =</span> <span class="kw">round</span>(Taxable_Income, <span class="op">-</span><span class="dv">3</span>))] <span class="op">%T&gt;%</span>
<span class="st">  </span><span class="kw">fwrite</span>(<span class="st">&quot;ALP-proposal-201920-vs-taxable-income.csv&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">grplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> Taxable_Income, <span class="dt">y =</span> tax_saving, <span class="dt">color =</span> fy_year)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="st">&quot;Taxable income&quot;</span>, <span class="dt">labels =</span> grattan_dollar, <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">225e3</span>)) 
<span class="co">#&gt; Warning: Removed 75 rows containing missing values (geom_path).</span></code></pre></div>
<p><img src="budget-2018_files/figure-html/unnamed-chunk-20-1.svg" /><!-- --></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">list</span>(
  {
    sample_files_all <span class="op">%&gt;%</span>
<span class="st">      </span>.[, .(<span class="dt">new_tax =</span> tax), keyby =<span class="st"> </span>.(<span class="dt">fy_year =</span> fy.year, Taxable_Income)] <span class="op">%&gt;%</span>
<span class="st">      </span>.[, id <span class="op">:</span><span class="er">=</span><span class="st"> &quot;Current&quot;</span>] <span class="op">%&gt;%</span>
<span class="st">      </span>.[]
  },
  bound_models[, .(id, fy_year, Taxable_Income, new_tax)],
  s1718[, .(<span class="dt">id =</span> <span class="st">&quot;Current&quot;</span>, <span class="dt">fy_year =</span> <span class="st">&quot;2017-18&quot;</span>, Taxable_Income, new_tax)],
  s1617[, .(<span class="dt">id =</span> <span class="st">&quot;Current&quot;</span>, <span class="dt">fy_year =</span> <span class="st">&quot;2016-17&quot;</span>, Taxable_Income, new_tax)]
) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">rbindlist</span>(<span class="dt">use.names =</span> <span class="ot">TRUE</span>,
            <span class="dt">fill =</span> <span class="ot">TRUE</span>)  <span class="op">%&gt;%</span>
<span class="st">  </span>.[, .(<span class="dt">progressivity =</span> <span class="kw">progressivity</span>(Taxable_Income, new_tax)), keyby =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;id&quot;</span>, <span class="st">&quot;fy_year&quot;</span>)] <span class="op">%&gt;%</span>
<span class="st">  </span>.[id <span class="op">%chin%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Budget2018&quot;</span>, <span class="st">&quot;Current&quot;</span>, <span class="st">&quot;Budget2018_baseline&quot;</span>, <span class="st">&quot;ALP2018&quot;</span>)] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, Year <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">fy2yr</span>(fy_year)] <span class="op">%&gt;%</span>
<span class="st">  </span>.[id <span class="op">==</span><span class="st"> &quot;Budget2018_baseline&quot;</span>, id <span class="op">:</span><span class="er">=</span><span class="st"> &quot;Baseline&quot;</span>] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, progressivity <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">round</span>(progressivity, <span class="dv">4</span>)] <span class="op">%&gt;%</span>
<span class="st">  </span>.[] <span class="op">%T&gt;%</span>
<span class="st">  </span><span class="kw">fwrite</span>(<span class="st">&quot;Reynolds-Smolensky-vs-year.csv&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">grplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> Year, <span class="dt">y =</span> progressivity, <span class="dt">color =</span> id, <span class="dt">group =</span> id)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="kw">c</span>(<span class="dv">2005</span>, <span class="dv">2010</span>, <span class="dv">2015</span>, <span class="dv">2020</span>, <span class="dv">2025</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;right&quot;</span>,
        <span class="dt">legend.title =</span> <span class="kw">element_blank</span>())</code></pre></div>
<p><img src="budget-2018_files/figure-html/progressivities-1.svg" /><!-- --></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">avg_tax_rates_by_percentile_facet_fy_historical &lt;-<span class="st"> </span>
<span class="st">  </span><span class="kw">list</span>(
  {
    sample_files_all <span class="op">%&gt;%</span>
<span class="st">      </span>.[, .(<span class="dt">new_tax =</span> tax), keyby =<span class="st"> </span>.(<span class="dt">fy_year =</span> fy.year, Taxable_Income)] <span class="op">%&gt;%</span>
<span class="st">      </span>.[, id <span class="op">:</span><span class="er">=</span><span class="st"> &quot;Current&quot;</span>] <span class="op">%&gt;%</span>
<span class="st">      </span>.[]
  },
  bound_models[, .(id, fy_year, Taxable_Income, new_tax)],
  s1718[, .(<span class="dt">id =</span> <span class="st">&quot;Current&quot;</span>, <span class="dt">fy_year =</span> <span class="st">&quot;2017-18&quot;</span>, Taxable_Income, new_tax)],
  s1617[, .(<span class="dt">id =</span> <span class="st">&quot;Current&quot;</span>, <span class="dt">fy_year =</span> <span class="st">&quot;2016-17&quot;</span>, Taxable_Income, new_tax)]
) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">rbindlist</span>(<span class="dt">use.names =</span> <span class="ot">TRUE</span>,
            <span class="dt">fill =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span>
<span class="st">  </span>.[, Taxable_Income_percentile <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">ntile</span>(Taxable_Income, <span class="dv">100</span>),
    keyby =<span class="st"> </span>.(id, fy_year)] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, new_avg_tax_rate <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">coalesce</span>(new_tax <span class="op">/</span><span class="st"> </span>Taxable_Income, <span class="dv">0</span>)] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, .(<span class="dt">new_avg_tax_rate =</span> <span class="kw">mean</span>(new_avg_tax_rate)), 
    keyby =<span class="st"> </span>.(fy_year, id, Taxable_Income_percentile)] <span class="op">%&gt;%</span>
<span class="st">  </span>.[] <span class="op">%&gt;%</span>
<span class="st">  </span>.[<span class="kw">implies</span>(id <span class="op">%pin%</span><span class="st"> &quot;_&quot;</span>, <span class="kw">endsWith</span>(id, <span class="st">&quot;baseline&quot;</span>))] <span class="op">%&gt;%</span>
<span class="st">  </span>.[id <span class="op">%pin%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;aseline&quot;</span>, <span class="st">&quot;urrent&quot;</span>), id <span class="op">:</span><span class="er">=</span><span class="st"> &quot;Baseline/Current&quot;</span>] <span class="op">%&gt;%</span>
<span class="st">  </span>.[<span class="kw">order</span>(fy_year)] <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">dcast</span>(fy_year <span class="op">+</span><span class="st"> </span>id <span class="op">~</span><span class="st"> </span>Taxable_Income_percentile, <span class="dt">value.var =</span> <span class="st">&quot;new_avg_tax_rate&quot;</span>, <span class="dt">FUN =</span> identity) <span class="op">%T&gt;%</span>
<span class="st">  </span><span class="kw">fwrite</span>(<span class="st">&quot;avg-tax-rate-wide-by-model-fy_year.tsv&quot;</span>, <span class="dt">quote =</span> <span class="ot">TRUE</span>, <span class="dt">sep =</span> <span class="st">&quot;</span><span class="ch">\t</span><span class="st">&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span>.[]</code></pre></div>
<div id="effect-of-sbto" class="section level2">
<h2>Effect of SBTO</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(fastmatch)
bound_models[id <span class="op">%ein%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Budget2018&quot;</span>, <span class="st">&quot;ALP2018&quot;</span>,
                        <span class="st">&quot;Budget2018_no_SBTO&quot;</span>, <span class="st">&quot;ALP2018_no_SBTO&quot;</span>,
                        <span class="st">&quot;Budget2018_baseline&quot;</span>, <span class="st">&quot;Budget2018_baseline_no_SBTO&quot;</span>)] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, .(<span class="dt">revenue =</span> <span class="kw">sum</span>(delta), <span class="dt">WEIGHT =</span> <span class="kw">first</span>(WEIGHT)), keyby =<span class="st"> </span>.(id, fy_year)] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, SBTO <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">if_else</span>(<span class="kw">endsWith</span>(id, <span class="st">&quot;no_SBTO&quot;</span>), <span class="st">&quot;No SBTO&quot;</span>, <span class="st">&quot;With SBTO&quot;</span>)] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, policy <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">sub</span>(<span class="st">&quot;_no_SBTO&quot;</span>, <span class="st">&quot;&quot;</span>, id)] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, revenue_bn <span class="op">:</span><span class="er">=</span><span class="st"> </span>revenue <span class="op">*</span><span class="st"> </span>WEIGHT <span class="op">/</span><span class="st"> </span><span class="fl">1e9</span>] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, revenue <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, .(policy, fy_year, SBTO, revenue_bn)] <span class="op">%&gt;%</span>
<span class="st">  </span>.[] <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">dcast</span>(policy <span class="op">+</span><span class="st"> </span>fy_year <span class="op">~</span><span class="st"> </span>SBTO, <span class="dt">value.var =</span> <span class="st">&quot;revenue_bn&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span>.[, delta <span class="op">:</span><span class="er">=</span><span class="st"> `</span><span class="dt">With SBTO</span><span class="st">`</span> <span class="op">-</span><span class="st"> `</span><span class="dt">No SBTO</span><span class="st">`</span>] <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> fy_year, <span class="dt">y =</span> delta, <span class="dt">fill =</span> policy)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_col</span>(<span class="dt">position =</span> <span class="st">&quot;dodge&quot;</span>)</code></pre></div>
<p><img src="budget-2018_files/figure-html/unnamed-chunk-22-1.svg" /><!-- --></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">bound_models[id <span class="op">%ein%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Budget2018&quot;</span>, <span class="st">&quot;ALP2018&quot;</span>,
                        <span class="st">&quot;Budget2018_no_SBTO&quot;</span>, <span class="st">&quot;ALP2018_no_SBTO&quot;</span>,
                        <span class="st">&quot;Budget2018_baseline&quot;</span>, <span class="st">&quot;Budget2018_baseline_no_SBTO&quot;</span>)] <span class="op">%&gt;%</span>
<span class="st">  </span>.[,
    Taxable_Income_percentile <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">ntile</span>(Taxable_Income <span class="op">+</span><span class="st"> </span>Total_PP_BE_amt <span class="op">+</span><span class="st"> </span>Total_NPP_BE_amt, <span class="dv">100</span>),
    keyby =<span class="st"> </span>.(id, fy_year)] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, .(<span class="dt">delta =</span> <span class="kw">sum</span>(delta)), keyby =<span class="st"> </span>.(id, fy_year, Taxable_Income_percentile)] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, p <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">coalesce</span>(delta <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(delta), <span class="dv">0</span>), keyby =<span class="st"> </span>.(id, fy_year)] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, delta <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>] <span class="op">%&gt;%</span>
<span class="st">  </span>.[] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, SBTO <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">tolower</span>(<span class="kw">endsWith</span>(id, <span class="st">&quot;_no_SBTO&quot;</span>))] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, policy <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">sub</span>(<span class="st">&quot;_no_SBTO&quot;</span>, <span class="st">&quot;&quot;</span>, .BY[[1L]], <span class="dt">fixed =</span> <span class="ot">TRUE</span>), by =<span class="st"> &quot;id&quot;</span>] <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">dcast</span>(Taxable_Income_percentile <span class="op">+</span><span class="st"> </span>policy <span class="op">+</span><span class="st"> </span>fy_year <span class="op">~</span><span class="st"> </span>SBTO, <span class="dt">value.var =</span> <span class="st">&quot;p&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span>.[, revi <span class="op">:</span><span class="er">=</span><span class="st"> </span>true <span class="op">-</span><span class="st"> </span>false] <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> Taxable_Income_percentile, <span class="dt">y =</span> revi, <span class="dt">color =</span> fy_year)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>policy) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>() </code></pre></div>
<p><img src="budget-2018_files/figure-html/unnamed-chunk-23-1.svg" /><!-- --></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">s202728_in_<span class="dv">1920</span> &lt;-<span class="st"> </span>
<span class="st">  </span><span class="kw">model_income_tax</span>(s1819,
                   <span class="st">&quot;2017-18&quot;</span>, 
                   <span class="dt">ordinary_tax_rates =</span> <span class="kw">ordinary_tax_rates</span>(<span class="dv">10</span>), 
                   <span class="dt">ordinary_tax_thresholds =</span> <span class="kw">ordinary_tax_thresholds</span>(<span class="dv">10</span>),
                   <span class="dt">Budget2018_lamington =</span> <span class="ot">TRUE</span>,
                   <span class="dt">Budget2018_lito_202223 =</span> <span class="ot">TRUE</span>)
alternative &lt;-<span class="st"> </span>
<span class="st">  </span><span class="kw">model_income_tax</span>(s1819, 
                   <span class="st">&quot;2017-18&quot;</span>, 
                   <span class="dt">ordinary_tax_rates =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">0.19</span>, <span class="fl">0.325</span>, <span class="fl">0.37</span>, <span class="fl">0.45</span>), 
                   <span class="dt">ordinary_tax_thresholds =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">18200</span>, <span class="dv">37000</span>, <span class="dv">90000</span>, <span class="dv">180000</span>))

r1 &lt;-<span class="st"> </span><span class="dv">0</span>
<span class="cf">while</span> (r1 <span class="op">&lt;</span><span class="st"> </span><span class="dv">20</span> <span class="op">&amp;&amp;</span><span class="st"> </span><span class="kw">revenue_foregone</span>(alternative) <span class="op">&gt;</span><span class="st"> </span><span class="kw">revenue_foregone</span>(s202728_in_<span class="dv">1920</span>)) {
  <span class="kw">print</span>(<span class="kw">revenue_foregone</span>(alternative))
  r1 &lt;-<span class="st"> </span>r1 <span class="op">+</span><span class="st"> </span><span class="dv">1</span>
  alternative &lt;-<span class="st"> </span>
<span class="st">    </span><span class="kw">model_income_tax</span>(s1819, 
                     <span class="st">&quot;2017-18&quot;</span>, 
                     <span class="dt">ordinary_tax_rates =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">0.19</span> <span class="op">-</span><span class="st"> </span>r1<span class="op">/</span><span class="dv">200</span>, <span class="fl">0.325</span> <span class="op">-</span><span class="st"> </span>r1<span class="op">/</span><span class="dv">200</span>, <span class="fl">0.37</span>, <span class="fl">0.45</span>), 
                     <span class="dt">ordinary_tax_thresholds =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">18200</span>, <span class="dv">37000</span>, <span class="dv">90000</span>, <span class="dv">180000</span>))
}
<span class="co">#&gt; [1] &quot;-\\$373 million&quot;</span>
<span class="co">#&gt; [1] &quot;-\\$2.7 billion&quot;</span>
<span class="co">#&gt; [1] &quot;-\\$4.9 billion&quot;</span>
<span class="co">#&gt; [1] &quot;-\\$7.2 billion&quot;</span>
<span class="co">#&gt; [1] &quot;-\\$9.5 billion&quot;</span>
<span class="co">#&gt; [1] &quot;-\\$12 billion&quot;</span>
<span class="co">#&gt; [1] &quot;-\\$14 billion&quot;</span>

alternative <span class="op">%&gt;%</span>
<span class="st">  </span>.[, new_avg_tax_rate <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">coalesce</span>(new_tax <span class="op">/</span><span class="st"> </span>Taxable_Income, <span class="dv">0</span>)] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, old_avg_tax_rate <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">coalesce</span>(baseline_tax <span class="op">/</span><span class="st"> </span>Taxable_Income, <span class="dv">0</span>)] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, delta <span class="op">:</span><span class="er">=</span><span class="st"> </span>new_tax <span class="op">-</span><span class="st"> </span>baseline_tax] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, .(<span class="dt">old_avg_tax_rate =</span> <span class="kw">mean</span>(old_avg_tax_rate),
        <span class="dt">new_avg_tax_rate =</span> <span class="kw">mean</span>(new_avg_tax_rate),
        <span class="dt">avg_delta =</span> <span class="kw">mean</span>(delta)),
    keyby =<span class="st"> </span>.(<span class="dt">Taxable_Income_percentile =</span> <span class="kw">ntile</span>(Taxable_Income, <span class="dv">100</span>))] <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">melt</span>(<span class="dt">id.vars =</span> <span class="kw">c</span>(<span class="st">&quot;Taxable_Income_percentile&quot;</span>, <span class="st">&quot;avg_delta&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span>.[, variable <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(variable, <span class="dt">levels =</span> <span class="kw">unique</span>(.<span class="op">$</span>variable), <span class="dt">ordered =</span> <span class="ot">TRUE</span>)] <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> Taxable_Income_percentile, <span class="dt">y =</span> value, <span class="dt">color =</span> variable)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_line</span>()</code></pre></div>
<p><img src="budget-2018_files/figure-html/unnamed-chunk-24-1.svg" /><!-- --></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
baseline_share &lt;-<span class="st"> </span>
<span class="st">  </span>bound_models[id <span class="op">==</span><span class="st"> &quot;Budget2018_baseline&quot;</span> <span class="op">&amp;</span><span class="st"> </span>fy_year <span class="op">==</span><span class="st"> &quot;2027-28&quot;</span>] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, .(<span class="dt">total_delta =</span> <span class="kw">sum</span>(delta)), keyby =<span class="st"> </span>.(<span class="dt">Taxable_Income_percentile =</span> <span class="kw">ntile</span>(Taxable_Income, <span class="dv">10</span>))] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, prop <span class="op">:</span><span class="er">=</span><span class="st"> </span>total_delta <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(total_delta)] 

govt_share &lt;-<span class="st"> </span>
<span class="st">  </span>bound_models[id <span class="op">==</span><span class="st"> &quot;Budget2018&quot;</span> <span class="op">&amp;</span><span class="st"> </span>fy_year <span class="op">==</span><span class="st"> &quot;2027-28&quot;</span>] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, .(<span class="dt">total_delta =</span> <span class="kw">sum</span>(delta)), keyby =<span class="st"> </span>.(<span class="dt">Taxable_Income_percentile =</span> <span class="kw">ntile</span>(Taxable_Income, <span class="dv">10</span>))] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, prop <span class="op">:</span><span class="er">=</span><span class="st"> </span>total_delta <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(total_delta)] <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">fwrite</span>(<span class="st">&quot;prop-share-tax-benefit-govt-by-decile.csv&quot;</span>)

alternative_share &lt;-<span class="st"> </span>
<span class="st">  </span>alternative <span class="op">%&gt;%</span>
<span class="st">  </span>.[, .(<span class="dt">total_delta =</span> <span class="kw">sum</span>(delta)), keyby =<span class="st"> </span>.(<span class="dt">Taxable_Income_percentile =</span> <span class="kw">ntile</span>(Taxable_Income, <span class="dv">10</span>))] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, prop <span class="op">:</span><span class="er">=</span><span class="st"> </span>total_delta <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(total_delta)] <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">fwrite</span>(<span class="st">&quot;prop-share-tax-benefit-alternative-by-decile.csv&quot;</span>)

alternative <span class="op">%&gt;%</span>
<span class="st">  </span>.[, .(<span class="dt">old_tot_tax_paid =</span> <span class="kw">sum</span>(baseline_tax <span class="op">*</span><span class="st"> </span>WEIGHT), 
        <span class="dt">new_tot_tax_paid =</span> <span class="kw">sum</span>(new_tax <span class="op">*</span><span class="st"> </span>WEIGHT)), 
    keyby =<span class="st"> </span>.(<span class="dt">Taxable_Income_decile =</span> <span class="kw">ntile</span>(Taxable_Income, <span class="dv">10</span>))] <span class="op">%&gt;%</span>
<span class="st">  </span>.[] <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">melt.data.table</span>(<span class="dt">id.vars =</span> <span class="kw">key</span>(.)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> Taxable_Income_decile, <span class="dt">y =</span> value, <span class="dt">fill =</span> variable)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_col</span>(<span class="dt">position =</span> <span class="st">&quot;dodge&quot;</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> <span class="cf">function</span>(x) <span class="kw">paste0</span>(<span class="kw">grattan_dollar</span>(x <span class="op">/</span><span class="st"> </span><span class="fl">1e9</span>), <span class="st">&quot; bn&quot;</span>))</code></pre></div>
<p><img src="budget-2018_files/figure-html/unnamed-chunk-24-2.svg" /><!-- --></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">bound_models <span class="op">%&gt;%</span>
<span class="st">  </span>.[id <span class="op">==</span><span class="st"> &quot;Budget2018&quot;</span>] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, Quintile <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">ntile</span>(Taxable_Income, <span class="dv">5</span>), keyby =<span class="st"> &quot;fy_year&quot;</span>] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, .(<span class="dt">total_delta_bn =</span> <span class="kw">sum</span>((new_tax <span class="op">-</span><span class="st"> </span>baseline_tax) <span class="op">*</span><span class="st"> </span>WEIGHT <span class="op">/</span><span class="st"> </span><span class="fl">1e9</span>), 
        <span class="dt">max_income =</span> <span class="kw">max</span>(Taxable_Income),
        <span class="dt">min_income =</span> <span class="kw">min</span>(Taxable_Income), 
        <span class="dt">avg_income =</span> <span class="kw">mean</span>(Taxable_Income)), 
    keyby =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;fy_year&quot;</span>, <span class="st">&quot;Quintile&quot;</span>)] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, <span class="st">&quot;Financial year ending&quot;</span> <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">fy2yr</span>(.BY[[<span class="dv">1</span>]]), keyby =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;fy_year&quot;</span>, <span class="st">&quot;Quintile&quot;</span>)] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, total_delta_bn <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">round</span>(total_delta_bn, <span class="dv">2</span>), keyby =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;fy_year&quot;</span>, <span class="st">&quot;Quintile&quot;</span>)] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, avg_income <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">round</span>(avg_income, <span class="dv">2</span>), keyby =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;fy_year&quot;</span>, <span class="st">&quot;Quintile&quot;</span>)] <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">setorder</span>(fy_year, <span class="op">-</span>Quintile) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">fwrite</span>(<span class="st">&quot;budget2018-total-revenue-vs-fy-by-quintile.csv&quot;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(<span class="kw">revenue_foregone</span>(Budget_<span class="dv">1922</span>[[<span class="st">&quot;2018-19&quot;</span>]][[<span class="st">&quot;Budget2018_baseline_brackets_cpi&quot;</span>]]))
<span class="co">#&gt; [1] &quot;-\\$2.3 billion&quot;</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">avg_tax_rate_by_percentile_brackets_cpi &lt;-
<span class="st">  </span><span class="kw">lapply</span>(Budget_<span class="dv">1922</span>, <span class="cf">function</span>(x) {
    x[[<span class="st">&quot;Budget2018_baseline_brackets_cpi&quot;</span>]][, .(Taxable_Income, new_tax)]
    }) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">rbindlist</span>(<span class="dt">use.names =</span> <span class="ot">TRUE</span>, <span class="dt">fill =</span> <span class="ot">TRUE</span>, <span class="dt">idcol =</span> <span class="st">&quot;fy_year&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span>.[, avg_tax_rate <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">coalesce</span>(new_tax <span class="op">/</span><span class="st"> </span>Taxable_Income, <span class="dv">0</span>)] <span class="op">%&gt;%</span>
<span class="st">  </span>.[, .(<span class="dt">avg_tax_rate =</span> <span class="kw">mean</span>(avg_tax_rate)), 
    keyby =<span class="st"> </span>.(fy_year, <span class="dt">Taxable_Income_percentile =</span> <span class="kw">ntile</span>(Taxable_Income, <span class="dv">100</span>))]
<span class="kw">fwrite</span>(avg_tax_rate_by_percentile_brackets_cpi,
       <span class="st">&quot;avg_tax_rate_by_percentile_brackets_cpi.csv&quot;</span>)</code></pre></div>
</div>
<div id="alternative-models" class="section level1">
<h1>Alternative models</h1>
<p><strong>MEDIA </strong></p>
<p>For comment please contact Danielle Wood (Budget Policy Program Director) or John Daley (CEO) by contacting 03 8344 3637</p>
<p><strong>Background </strong></p>
<p>In the 2018-19 Budget the Government announced major changes to the tax system. The three-stage plan (the PIT plan) will be implemented over seven years as below. Each of these changes in factored into the Grattan costing.</p>
<p><strong>Step 1: Low and Middle Income Tax Offset (“Lamington”) </strong></p>
<p>Taxpayers earning between $20,200 and $125,000 will receive a temporary, non-refundable tax offset for 2018-19 to 2021-22, in addition to the Low Income Tax Offset (LITO). The new offset will provide tax relief of up to $530 and it will be received as a lump sum payment at tax time.</p>
<p><strong>Step 2: Changes to tax thresholds and Low Income Tax Offset </strong></p>
<p>In 2018-19 the top threshold of the 32.5% tax bracket will be increased from $87,000 to $90,000.</p>
<p>The top threshold for the 32.5% tax bracket will be moved again from $90,000 to $120,000 in 2022-23.</p>
<p>In 2022-23 the low and middle-income tax offset will end. The top threshold of the 19% tax bracket will increase from $37,000 to $41,000, and LITO will increase from $445 to $645.</p>
<p><strong>Step 3: Reducing the number of tax brackets from five to four</strong></p>
<p>In 2024-25 the top threshold for the 32.5% tax bracket will increase to $200,000, eradicating the 37% tax bracket entirely. This means taxpayers who earn between $41,000 to $200,000 will all face the same marginal tax rate – 32.5%. Taxpayers earning more than $200,000 will still pay 45 cents in the dollar.</p>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
