#include "grattan.h"


int ORDINARY_TAX_BRACKETS_1984[MAX_NBRACK] = {0, 4595, 19500, 35788, INT_MAX, INT_MAX, INT_MAX, INT_MAX};
int ORDINARY_TAX_BRACKETS_1985[MAX_NBRACK] = {0, 4595, 12500, 19500, 28000, 35000, 35788, INT_MAX};
int ORDINARY_TAX_BRACKETS_1986[MAX_NBRACK] = {0, 4595, 12500, 19500, 28000, 35000, INT_MAX, INT_MAX};
int ORDINARY_TAX_BRACKETS_1987[MAX_NBRACK] = {0, 4890, 12500, 12600, 19500, 28000, 35000, INT_MAX};
int ORDINARY_TAX_BRACKETS_1988[MAX_NBRACK] = {0, 5100, 12600, 19500, 35000, INT_MAX, INT_MAX, INT_MAX};
int ORDINARY_TAX_BRACKETS_1989[MAX_NBRACK] = {0, 5100, 12600, 19500, 35000, INT_MAX, INT_MAX, INT_MAX};
int ORDINARY_TAX_BRACKETS_1990[MAX_NBRACK] = {0, 5100, 17650, 20600, 35000, 50000, INT_MAX, INT_MAX};
int ORDINARY_TAX_BRACKETS_1991[MAX_NBRACK] = {0, 5250, 17650, 20600, 20700, 35000, 36000, 50000};
int ORDINARY_TAX_BRACKETS_1992[MAX_NBRACK] = {0, 5400, 20700, 36000, 50000, INT_MAX, INT_MAX, INT_MAX};
int ORDINARY_TAX_BRACKETS_1993[MAX_NBRACK] = {0, 5400, 20700, 36000, 50000, INT_MAX, INT_MAX, INT_MAX};
int ORDINARY_TAX_BRACKETS_1994[MAX_NBRACK] = {0, 5400, 20700, 36000, 38000, 50000, INT_MAX, INT_MAX};
int ORDINARY_TAX_BRACKETS_1995[MAX_NBRACK] = {0, 5400, 20700, 38000, 50000, INT_MAX, INT_MAX, INT_MAX};
int ORDINARY_TAX_BRACKETS_1996[MAX_NBRACK] = {0, 5400, 20700, 38000, 50000, INT_MAX, INT_MAX, INT_MAX};
int ORDINARY_TAX_BRACKETS_1997[MAX_NBRACK] = {0, 5400, 20700, 38000, 50000, INT_MAX, INT_MAX, INT_MAX};
int ORDINARY_TAX_BRACKETS_1998[MAX_NBRACK] = {0, 5400, 20700, 38000, 50000, INT_MAX, INT_MAX, INT_MAX};
int ORDINARY_TAX_BRACKETS_1999[MAX_NBRACK] = {0, 5400, 20700, 38000, 50000, INT_MAX, INT_MAX, INT_MAX};
int ORDINARY_TAX_BRACKETS_2000[MAX_NBRACK] = {0, 5400, 20700, 38000, 50000, INT_MAX, INT_MAX, INT_MAX};
int ORDINARY_TAX_BRACKETS_2001[MAX_NBRACK] = {0, 6000, 20000, 50000, 60000, INT_MAX, INT_MAX, INT_MAX};
int ORDINARY_TAX_BRACKETS_2002[MAX_NBRACK] = {0, 6000, 20000, 50000, 60000, INT_MAX, INT_MAX, INT_MAX};
int ORDINARY_TAX_BRACKETS_2003[MAX_NBRACK] = {0, 6000, 20000, 50000, 60000, INT_MAX, INT_MAX, INT_MAX};
int ORDINARY_TAX_BRACKETS_2004[MAX_NBRACK] = {0, 6000, 21600, 52000, 62500, INT_MAX, INT_MAX, INT_MAX};
int ORDINARY_TAX_BRACKETS_2005[MAX_NBRACK] = {0, 6000, 21600, 58000, 70000, INT_MAX, INT_MAX, INT_MAX};
int ORDINARY_TAX_BRACKETS_2006[MAX_NBRACK] = {0, 6000, 21600, 63000, 95000, INT_MAX, INT_MAX, INT_MAX};
int ORDINARY_TAX_BRACKETS_2007[MAX_NBRACK] = {0, 6000, 25000, 75000, 150000, INT_MAX, INT_MAX, INT_MAX};
int ORDINARY_TAX_BRACKETS_2008[MAX_NBRACK] = {0, 6000, 30000, 75000, 150000, INT_MAX, INT_MAX, INT_MAX};
int ORDINARY_TAX_BRACKETS_2009[MAX_NBRACK] = {0, 6000, 34000, 80000, 180000, INT_MAX, INT_MAX, INT_MAX};
int ORDINARY_TAX_BRACKETS_2010[MAX_NBRACK] = {0, 6000, 35000, 80000, 180000, INT_MAX, INT_MAX, INT_MAX};
int ORDINARY_TAX_BRACKETS_2011[MAX_NBRACK] = {0, 6000, 37000, 80000, 180000, INT_MAX, INT_MAX, INT_MAX};
int ORDINARY_TAX_BRACKETS_2012[MAX_NBRACK] = {0, 6000, 37000, 80000, 180000, INT_MAX, INT_MAX, INT_MAX};
int ORDINARY_TAX_BRACKETS_2013[MAX_NBRACK] = {0, 18200, 37000, 80000, 180000, INT_MAX, INT_MAX, INT_MAX};
int ORDINARY_TAX_BRACKETS_2014[MAX_NBRACK] = {0, 18200, 37000, 80000, 180000, INT_MAX, INT_MAX, INT_MAX};
int ORDINARY_TAX_BRACKETS_2015[MAX_NBRACK] = {0, 18200, 37000, 80000, 180000, INT_MAX, INT_MAX, INT_MAX};
int ORDINARY_TAX_BRACKETS_2016[MAX_NBRACK] = {0, 18200, 37000, 80000, 180000, INT_MAX, INT_MAX, INT_MAX};
int ORDINARY_TAX_BRACKETS_2017[MAX_NBRACK] = {0, 18200, 37000, 87000, 180000, INT_MAX, INT_MAX, INT_MAX};
int ORDINARY_TAX_BRACKETS_2018[MAX_NBRACK] = {0, 18200, 37000, 87000, 180000, INT_MAX, INT_MAX, INT_MAX};
int ORDINARY_TAX_BRACKETS_2019[MAX_NBRACK] = {0, 18200, 37000, 90000, 180000, INT_MAX, INT_MAX, INT_MAX};
int ORDINARY_TAX_BRACKETS_2020[MAX_NBRACK] = {0, 18200, 37000, 90000, 180000, INT_MAX, INT_MAX, INT_MAX};
int ORDINARY_TAX_BRACKETS_2021[MAX_NBRACK] = {0, 18200, 37000, 90000, 180000, INT_MAX, INT_MAX, INT_MAX};
int ORDINARY_TAX_BRACKETS_2022[MAX_NBRACK] = {0, 18200, 37000, 90000, 180000, INT_MAX, INT_MAX, INT_MAX};

double ORDINARY_TAX_RATES_1984[MAX_NBRACK] = {0, 0.30, 0.46, 0.60, 0.60, 0.60, 0.60, 0.60};
double ORDINARY_TAX_RATES_1985[MAX_NBRACK] = {0, 0.2667, 0.30, 0.46, 0.4733, 0.5533, 0.60, 0.60};
double ORDINARY_TAX_RATES_1986[MAX_NBRACK] = {0, 0.25, 0.30, 0.46, 0.48, 0.60, 0.60, 0.60};
double ORDINARY_TAX_RATES_1987[MAX_NBRACK] = {0, 0.2442, 0.2650, 0.2942, 0.4425, 0.4683, 0.5708, 0.5708};
double ORDINARY_TAX_RATES_1988[MAX_NBRACK] = {0, 0.24, 0.29, 0.40, 0.49, 0.49, 0.49, 0.49};
double ORDINARY_TAX_RATES_1989[MAX_NBRACK] = {0, 0.24, 0.29, 0.40, 0.49, 0.49, 0.49, 0.49};
double ORDINARY_TAX_RATES_1990[MAX_NBRACK] = {0, 0.21, 0.29, 0.39, 0.47, 0.48, 0.48, 0.48};
double ORDINARY_TAX_RATES_1991[MAX_NBRACK] = {0, 0.205, 0.245, 0.295, 0.385, 0.425, 0.465, 0.47};
double ORDINARY_TAX_RATES_1992[MAX_NBRACK] = {0, 0.2, 0.38, 0.46, 0.47, 0.47, 0.47, 0.47};
double ORDINARY_TAX_RATES_1993[MAX_NBRACK] = {0, 0.2, 0.38, 0.46, 0.47, 0.47, 0.47, 0.47};
double ORDINARY_TAX_RATES_1994[MAX_NBRACK] = {0, 0.2, 0.355, 0.385, 0.44125, 0.47, 0.47, 0.47};
double ORDINARY_TAX_RATES_1995[MAX_NBRACK] = {0, 0.2, 0.34, 0.43, 0.47, 0.47, 0.47, 0.47};
double ORDINARY_TAX_RATES_1996[MAX_NBRACK] = {0, 0.2, 0.34, 0.43, 0.47, 0.47, 0.47, 0.47};
double ORDINARY_TAX_RATES_1997[MAX_NBRACK] = {0, 0.2, 0.34, 0.43, 0.47, 0.47, 0.47, 0.47};
double ORDINARY_TAX_RATES_1998[MAX_NBRACK] = {0, 0.2, 0.34, 0.43, 0.47, 0.47, 0.47, 0.47};
double ORDINARY_TAX_RATES_1999[MAX_NBRACK] = {0, 0.2, 0.34, 0.43, 0.47, 0.47, 0.47, 0.47};
double ORDINARY_TAX_RATES_2000[MAX_NBRACK] = {0, 0.2, 0.34, 0.43, 0.47, 0.47, 0.47, 0.47};
double ORDINARY_TAX_RATES_2001[MAX_NBRACK] = {0, 0.17, 0.3, 0.42, 0.47, 0.47, 0.47, 0.47};
double ORDINARY_TAX_RATES_2002[MAX_NBRACK] = {0, 0.17, 0.3, 0.42, 0.47, 0.47, 0.47, 0.47};
double ORDINARY_TAX_RATES_2003[MAX_NBRACK] = {0, 0.17, 0.3, 0.42, 0.47, 0.47, 0.47, 0.47};
double ORDINARY_TAX_RATES_2004[MAX_NBRACK] = {0, 0.17, 0.3, 0.42, 0.47, 0.47, 0.47, 0.47};
double ORDINARY_TAX_RATES_2005[MAX_NBRACK] = {0, 0.17, 0.3, 0.42, 0.47, 0.47, 0.47, 0.47};
double ORDINARY_TAX_RATES_2006[MAX_NBRACK] = {0, 0.15, 0.3, 0.42, 0.47, 0.47, 0.47, 0.47};
double ORDINARY_TAX_RATES_2007[MAX_NBRACK] = {0, 0.15, 0.3, 0.4, 0.45, 0.45, 0.45, 0.45};
double ORDINARY_TAX_RATES_2008[MAX_NBRACK] = {0, 0.15, 0.3, 0.4, 0.45, 0.45, 0.45, 0.45};
double ORDINARY_TAX_RATES_2009[MAX_NBRACK] = {0, 0.15, 0.3, 0.4, 0.45, 0.45, 0.45, 0.45};
double ORDINARY_TAX_RATES_2010[MAX_NBRACK] = {0, 0.15, 0.3, 0.38, 0.45, 0.45, 0.45, 0.45};
double ORDINARY_TAX_RATES_2011[MAX_NBRACK] = {0, 0.15, 0.3, 0.37, 0.45, 0.45, 0.45, 0.45};
double ORDINARY_TAX_RATES_2012[MAX_NBRACK] = {0, 0.15, 0.3, 0.37, 0.45, 0.45, 0.45, 0.45};
double ORDINARY_TAX_RATES_2013[MAX_NBRACK] = {0, 0.19, 0.325, 0.37, 0.45, 0.45, 0.45, 0.45};
double ORDINARY_TAX_RATES_2014[MAX_NBRACK] = {0, 0.19, 0.325, 0.37, 0.45, 0.45, 0.45, 0.45};
double ORDINARY_TAX_RATES_2015[MAX_NBRACK] = {0, 0.19, 0.325, 0.37, 0.45, 0.45, 0.45, 0.45};
double ORDINARY_TAX_RATES_2016[MAX_NBRACK] = {0, 0.19, 0.325, 0.37, 0.45, 0.45, 0.45, 0.45};
double ORDINARY_TAX_RATES_2017[MAX_NBRACK] = {0, 0.19, 0.325, 0.37, 0.45, 0.45, 0.45, 0.45};
double ORDINARY_TAX_RATES_2018[MAX_NBRACK] = {0, 0.19, 0.325, 0.37, 0.45, 0.45, 0.45, 0.45};
double ORDINARY_TAX_RATES_2019[MAX_NBRACK] = {0, 0.19, 0.325, 0.37, 0.45, 0.45, 0.45, 0.45};
double ORDINARY_TAX_RATES_2020[MAX_NBRACK] = {0, 0.19, 0.325, 0.37, 0.45, 0.45, 0.45, 0.45};
double ORDINARY_TAX_RATES_2021[MAX_NBRACK] = {0, 0.19, 0.325, 0.37, 0.45, 0.45, 0.45, 0.45};
double ORDINARY_TAX_RATES_2022[MAX_NBRACK] = {0, 0.19, 0.325, 0.37, 0.45, 0.45, 0.45, 0.45};

int nb_by_year(unsigned int yr) {
  if (yr > 1995) {
    return 5;
  }
  switch(yr) {
  case 1984:
    return 4;
  case 1985:
  case 1987:
    return 7;
  case 1986:
  case 1990:
  case 1994:
    return 6;
  case 1991:
    return 8;
  default:
    return 5;
  }
}

unsigned int brack_by_yr(int b, int yr) {
  switch(yr) {
  case 1984:
    return ORDINARY_TAX_BRACKETS_1984[b];
    break;
  case 1985:
    return ORDINARY_TAX_BRACKETS_1985[b];
    break;
  case 1986:
    return ORDINARY_TAX_BRACKETS_1986[b];
    break;
  case 1987:
    return ORDINARY_TAX_BRACKETS_1987[b];
    break;
  case 1988:
    return ORDINARY_TAX_BRACKETS_1988[b];
    break;
  case 1989:
    return ORDINARY_TAX_BRACKETS_1989[b];
    break;
  case 1990:
    return ORDINARY_TAX_BRACKETS_1990[b];
    break;
  case 1991:
    return ORDINARY_TAX_BRACKETS_1991[b];
    break;
  case 1992:
    return ORDINARY_TAX_BRACKETS_1992[b];
    break;
  case 1993:
    return ORDINARY_TAX_BRACKETS_1993[b];
    break;
  case 1994:
    return ORDINARY_TAX_BRACKETS_1994[b];
    break;
  case 1995:
    return ORDINARY_TAX_BRACKETS_1995[b];
    break;
  case 1996:
    return ORDINARY_TAX_BRACKETS_1996[b];
    break;
  case 1997:
    return ORDINARY_TAX_BRACKETS_1997[b];
    break;
  case 1998:
    return ORDINARY_TAX_BRACKETS_1998[b];
    break;
  case 1999:
    return ORDINARY_TAX_BRACKETS_1999[b];
    break;
  case 2000:
    return ORDINARY_TAX_BRACKETS_2000[b];
    break;
  case 2001:
    return ORDINARY_TAX_BRACKETS_2001[b];
    break;
  case 2002:
    return ORDINARY_TAX_BRACKETS_2002[b];
    break;
  case 2003:
    return ORDINARY_TAX_BRACKETS_2003[b];
    break;
  case 2004:
    return ORDINARY_TAX_BRACKETS_2004[b];
    break;
  case 2005:
    return ORDINARY_TAX_BRACKETS_2005[b];
    break;
  case 2006:
    return ORDINARY_TAX_BRACKETS_2006[b];
    break;
  case 2007:
    return ORDINARY_TAX_BRACKETS_2007[b];
    break;
  case 2008:
    return ORDINARY_TAX_BRACKETS_2008[b];
    break;
  case 2009:
    return ORDINARY_TAX_BRACKETS_2009[b];
    break;
  case 2010:
    return ORDINARY_TAX_BRACKETS_2010[b];
    break;
  case 2011:
    return ORDINARY_TAX_BRACKETS_2011[b];
    break;
  case 2012:
    return ORDINARY_TAX_BRACKETS_2012[b];
    break;
  case 2013:
    return ORDINARY_TAX_BRACKETS_2013[b];
    break;
  case 2014:
    return ORDINARY_TAX_BRACKETS_2014[b];
    break;
  case 2015:
    return ORDINARY_TAX_BRACKETS_2015[b];
    break;
  case 2016:
    return ORDINARY_TAX_BRACKETS_2016[b];
    break;
  case 2017:
    return ORDINARY_TAX_BRACKETS_2017[b];
    break;
  case 2018:
    return ORDINARY_TAX_BRACKETS_2018[b];
    break;
  case 2019:
    return ORDINARY_TAX_BRACKETS_2019[b];
    break;
  case 2020:
    return ORDINARY_TAX_BRACKETS_2020[b];
    break;
  case 2021:
    return ORDINARY_TAX_BRACKETS_2021[b];
    break;
  case 2022:
    return ORDINARY_TAX_BRACKETS_2022[b];
    break;
  default:
    return ORDINARY_TAX_BRACKETS_2022[b];
  }
  return 0;
}

double rates_by_yr(int b, int yr) {
  switch(yr) {
  case 1984:
    return ORDINARY_TAX_RATES_1984[b];
    break;
  case 1985:
    return ORDINARY_TAX_RATES_1985[b];
    break;
  case 1986:
    return ORDINARY_TAX_RATES_1986[b];
    break;
  case 1987:
    return ORDINARY_TAX_RATES_1987[b];
    break;
  case 1988:
    return ORDINARY_TAX_RATES_1988[b];
    break;
  case 1989:
    return ORDINARY_TAX_RATES_1989[b];
    break;
  case 1990:
    return ORDINARY_TAX_RATES_1990[b];
    break;
  case 1991:
    return ORDINARY_TAX_RATES_1991[b];
    break;
  case 1992:
    return ORDINARY_TAX_RATES_1992[b];
    break;
  case 1993:
    return ORDINARY_TAX_RATES_1993[b];
    break;
  case 1994:
    return ORDINARY_TAX_RATES_1994[b];
    break;
  case 1995:
    return ORDINARY_TAX_RATES_1995[b];
    break;
  case 1996:
    return ORDINARY_TAX_RATES_1996[b];
    break;
  case 1997:
    return ORDINARY_TAX_RATES_1997[b];
    break;
  case 1998:
    return ORDINARY_TAX_RATES_1998[b];
    break;
  case 1999:
    return ORDINARY_TAX_RATES_1999[b];
    break;
  case 2000:
    return ORDINARY_TAX_RATES_2000[b];
    break;
  case 2001:
    return ORDINARY_TAX_RATES_2001[b];
    break;
  case 2002:
    return ORDINARY_TAX_RATES_2002[b];
    break;
  case 2003:
    return ORDINARY_TAX_RATES_2003[b];
    break;
  case 2004:
    return ORDINARY_TAX_RATES_2004[b];
    break;
  case 2005:
    return ORDINARY_TAX_RATES_2005[b];
    break;
  case 2006:
    return ORDINARY_TAX_RATES_2006[b];
    break;
  case 2007:
    return ORDINARY_TAX_RATES_2007[b];
    break;
  case 2008:
    return ORDINARY_TAX_RATES_2008[b];
    break;
  case 2009:
    return ORDINARY_TAX_RATES_2009[b];
    break;
  case 2010:
    return ORDINARY_TAX_RATES_2010[b];
    break;
  case 2011:
    return ORDINARY_TAX_RATES_2011[b];
    break;
  case 2012:
    return ORDINARY_TAX_RATES_2012[b];
    break;
  case 2013:
    return ORDINARY_TAX_RATES_2013[b];
    break;
  case 2014:
    return ORDINARY_TAX_RATES_2014[b];
    break;
  case 2015:
    return ORDINARY_TAX_RATES_2015[b];
    break;
  case 2016:
    return ORDINARY_TAX_RATES_2016[b];
    break;
  case 2017:
    return ORDINARY_TAX_RATES_2017[b];
    break;
  case 2018:
    return ORDINARY_TAX_RATES_2018[b];
    break;
  case 2019:
    return ORDINARY_TAX_RATES_2019[b];
    break;
  case 2020:
    return ORDINARY_TAX_RATES_2020[b];
    break;
  case 2021:
    return ORDINARY_TAX_RATES_2021[b];
    break;
  case 2022:
    return ORDINARY_TAX_RATES_2022[b];
    break;
  default:
    return ORDINARY_TAX_RATES_2022[b];
  }
  return 0; // # nocov
}

System yr2System(int yr) {
  System Sys;
  Sys.yr = yr;
  int nb = nb_by_year(yr);
  Sys.nb = nb;
  for (int b = 0; b < MAX_NBRACK; ++b) {
    Sys.BRACKETS[b] = brack_by_yr(b, yr);
    Sys.RATES[b] = rates_by_yr(b, yr);
  }
  Sys.M = yr2Medicare(yr);
  Sys.has_sapto = yr >= 2000;
  Sys.S = yr2Sapto(yr);
  Sys.has_lito = yr >= 1994;
  Sys.has_lmito = yr >= 2019;
  Sys.has_offset1 = false;
  Sys.has_offset2 = false;
  Sys.has_offsetn = false;
  Sys.has_temp_budget_repair_levy = yr >= 2015 && yr <= 2017;
  return Sys;
}

// quick trunc
int qtrunc(double x) {
  if (x > INT_MAX) {
    return INT_MAX;
  }
  if (x <= -INT_MAX) {
    return -INT_MAX;
  }
  return (int)x;
}

bool safe2int(double x) {
  return !ISNAN(x) && x > -INT_MAX && x < INT_MAX;
}

bool hazName(SEXP list, const char * str) {
  int n = length(list);
  SEXP names = getAttrib(list, R_NamesSymbol);
  for (int i = 0; i < n; ++i) {
    if (strcmp(CHAR(STRING_ELT(names, i)), str) == 0) {
      return true;
    }
  }
  return false;
}

bool starts_with_medicare(const char * str) {
  return 
    str[0] == 'm' && str[1] == 'e' && str[2] == 'd' &&
    str[3] == 'i' && str[4] == 'c' && str[5] == 'a' &&
    str[6] == 'r' && str[7] == 'e';
}

// from stats package
SEXP getListElement(SEXP list, const char * str) {
  if (starts_with_medicare(str) && hazName(list, "Medicare")) {
    SEXP MedicareList = getListElement(list, "Medicare");
    return getListElement(MedicareList, str);
  }
  SEXP elmt = R_NilValue, names = getAttrib(list, R_NamesSymbol);
  for (int i = 0; i < length(list); i++) {
    if (strcmp(CHAR(STRING_ELT(names, i)), str) == 0) {
      elmt = VECTOR_ELT(list, i);
      break;
    }
  }
  return elmt;
}

void setIntElement(int * o, SEXP list, const char * str) {
  SEXP elmt = getListElement(list, str);
  if (isReal(elmt)) {
    double delmt = asReal(elmt);
    if (!safe2int(delmt)) {
      return;
    }
    *o = (int)delmt;
    return;
  }
  if (isInteger(elmt)) {
    *o = asInteger(elmt);
  }
}

void setIntElements(int * o, int n, SEXP list, const char * str) {
  SEXP elmt = getListElement(list, str);
  int M = length(elmt); // elements to assign
  if (n < M) {
    M = n; // in case there are more elements
  }
  if (isReal(elmt)) {
    const double * xp = REAL(elmt);
    for (int j = 0; j < M; ++j) {
      if (safe2int(xp[j])) {
        o[j] = xp[j];
      }
    }
    return;
  }
  if (isInteger(elmt)) {
    const int * xp = INTEGER(elmt);
    for (int j = 0; j < M; ++j) {
      if (xp[j] != NA_INTEGER) {
        o[j] = xp[j];
      }
    }
  }
}

void setDblElement(double * o, SEXP list, const char * str) {
  SEXP elmt = getListElement(list, str);
  if (isReal(elmt)) {
    *o = asReal(elmt);
  }
  if (isInteger(elmt)) {
    *o = (double)asInteger(elmt);
  }
}

void setDblElements(double * o, int n, SEXP list, const char * str) {
  SEXP elmt = getListElement(list, str);
  int M = length(elmt); // elements to assign
  if (n < M) {
    M = n; // in case there are more elements
  }
  if (isReal(elmt)) {
    const double * xp = REAL(elmt);
    for (int j = 0; j < M; ++j) {
      if (!ISNAN(xp[j])) {
        o[j] = xp[j];
      }
    }
  }
  if (isInteger(elmt)) {
    const int * xp = INTEGER(elmt);
    for (int j = 0; j < M; ++j) {
      if (xp[j] != NA_INTEGER) {
        o[j] = xp[j];
      }
    }
  }
}

System Sexp2System(SEXP RSystem, int yr) {
  if (isNull(RSystem)) {
    return yr2System(yr);
  }
  if (!isVectorList(RSystem)) {
    error("(Sexp2System): RSystem was type '%s' but must be type list",
          type2char(TYPEOF(RSystem)));
  }
  
  int n = length(RSystem);
  System Sys = yr2System(yr);
  if (n == 0) {
    return Sys;
  }
  // Sapto S = yr2Medicare(yr);
  if (hazName(RSystem, "yr")) {
    int yr = asInteger(getListElement(RSystem, "yr"));
    Sys.yr = yr;
    // Sys.
  }
  Sys.has_sapto = yr >= 2000;
  
  // tax thresholds
  setIntElements(Sys.BRACKETS, MAX_NBRACK, RSystem, "ordinary_tax_thresholds");
  setDblElements(Sys.RATES, MAX_NBRACK, RSystem, "ordinary_tax_rates");
  
  // Set Medicare levy
  setDblElement(&Sys.M.taper, RSystem, "medicare_levy_taper");
  setDblElement(&Sys.M.rate, RSystem, "medicare_levy_rate");
  
  setIntElement(&Sys.M.lwr_single, RSystem, "medicare_levy_lower_threshold");
  setIntElement(&Sys.M.upr_single, RSystem, "medicare_levy_upper_threshold");
  
  setIntElement(&Sys.M.lwr_single_sapto, RSystem, "medicare_levy_lower_sapto_threshold");
  setIntElement(&Sys.M.upr_single_sapto, RSystem, "medicare_levy_upper_sapto_threshold");
  
  setIntElement(&Sys.M.lwr_family, RSystem, "medicare_levy_lower_family_threshold");
  setIntElement(&Sys.M.upr_family, RSystem, "medicare_levy_upper_family_threshold");
  
  setIntElement(&Sys.M.lwr_family_sapto, RSystem, "medicare_levy_lower_family_sapto_threshold");
  setIntElement(&Sys.M.upr_family_sapto, RSystem, "medicare_levy_upper_family_sapto_threshold");
  
  setIntElement(&Sys.M.lwr_thr_up_per_child, RSystem, "medicare_levy_lower_up_for_each_child");
  
  setIntElement(&Sys.M.sapto_age, RSystem, "sapto_pension_age");
  
  if (hazName(RSystem, "offsets")) {
    SEXP Offsets = getListElement(RSystem, "offsets");
    if (isList(Offsets)) {
      if (hazName(Offsets, "LITO")) {
        SEXP Offsets_LITO = getListElement(Offsets, "LITO");
        if (isLogical(Offsets_LITO)) {
          bool offsets_has_lito = asLogical(Offsets_LITO);
          Sys.has_lito = offsets_has_lito;
        }
        if (isList(Offsets_LITO)) {
          if (length(Offsets_LITO) != 4) {
            error("Internal error: Offsets_LITO had wrong length = %d.", length(Offsets_LITO));
          }
          
          setIntElement(&Sys.O1.offset_1st, Offsets_LITO, "offset_1st");
          setIntElement(&Sys.O1.thresh_1st, Offsets_LITO, "thresh_1st");
          setDblElement(&Sys.O1.taper_1st, Offsets_LITO, "taper_1st");
          Sys.O1.refundable = false;
          Sys.has_lito = false; // replaced with O1
        }
      }
      if (hazName(Offsets, "LMITO")) {
        SEXP Offsets_LMITO = getListElement(Offsets, "LMITO");
        if (isLogical(Offsets_LMITO)) {
          bool offsets_has_lmito = asLogical(Offsets_LMITO);
          Sys.has_lmito = offsets_has_lmito;
        }
      }
      int nOffsets = length(Offsets);
      if (nOffsets > (hazName(Offsets, "LITO") + hazName(Offsets, "LMITO"))) {
        warning("Not yet implemented nOffsets > 2"); // # nocov
      }
    }
  }

  // Set Sapto
  setDblElement(&Sys.S.first_tax_rate, RSystem, "sapto_first_tax_rate");
  setIntElement(&Sys.S.lwr_couple, RSystem, "sapto_lower_threshold_married");
  setIntElement(&Sys.S.lwr_single, RSystem, "sapto_lower_threshold");
  
  setIntElement(&Sys.S.mxo_single, RSystem, "sapto_max_offset");
  setIntElement(&Sys.S.mxo_couple, RSystem, "sapto_max_offset_married");
  setDblElement(&Sys.S.pension_age, RSystem, "sapto_pension_age");
  setDblElement(&Sys.S.second_tax_rate, RSystem, "sapto_second_tax_rate");
  setDblElement(&Sys.S.taper, RSystem, "sapto_taper");
  setIntElement(&Sys.S.tax_free_thresh, RSystem, "sapto_tax_free_thresh");
  if (Sys.S.taper < 0) {
    Sys.S.taper = - Sys.S.taper;
  }
  
  Sys.S.upr_single = Sys.S.lwr_single + Sys.S.mxo_single / Sys.S.taper;
  Sys.S.upr_couple = Sys.S.lwr_couple + Sys.S.mxo_couple / Sys.S.taper;
  
  Sys.S.year = yr;
  
  
  
  
  return Sys;
}



